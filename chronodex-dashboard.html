<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Cosmodex">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#030508">
<link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Cosmodex%22,%22short_name%22:%22Cosmodex%22,%22display%22:%22fullscreen%22,%22background_color%22:%22%23030508%22,%22theme_color%22:%22%23030508%22,%22orientation%22:%22any%22}">
<title>Cosmodex</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }

[data-theme="dark"] {
  --bg:#030508; --surface:#090d14; --border:#1a2535;
  --ink:#cce0f8; --ink-dim:#445870; --ink-faint:#0e1520;
  --accent:#3db8ff;       /* high-contrast azure blue */
  --accent-dim:#0c2d4a;
  --accent-glow:rgba(61,184,255,0.13);
  --gold:#3db8ff; --gold-dim:#0c2d4a;  /* alias for compat */
  --red:#e05555;           /* only for errors/overdue */
  --blue:#3db8ff;          /* remap blue→accent */
  --green:#3db8ff;         /* remap green→accent */
  --amber:#3db8ff;         /* remap amber→accent */
  --lotus:#3db8ff;         /* remap lotus→accent */
  --pomo-bg:#060a12;
}
[data-theme="light"] {
  --bg:#f0f4f8; --surface:#ffffff; --border:#7090b8;
  --ink:#0a1a35; --ink-dim:#0b62c4; --ink-faint:#dde6f0;
  --accent:#0b62c4;
  --accent-dim:#b0ccec;
  --accent-glow:rgba(11,98,196,0.09);
  --gold:#0b62c4; --gold-dim:#b0ccec;
  --red:#c42b2b;
  --blue:#0b62c4;
  --green:#0b62c4;
  --amber:#0b62c4;
  --lotus:#0b62c4;
  --pomo-bg:#e8eef6;
}
/* Light mode — force all secondary/dim text to readable dark blue */
[data-theme="light"] .task-group-lbl,
[data-theme="light"] .panel-title,
[data-theme="light"] .tab:not(.active),
[data-theme="light"] .view-btn:not(.active),
[data-theme="light"] .time-date,
[data-theme="light"] .next-lbl,
[data-theme="light"] .next-time,
[data-theme="light"] .task-meta:not(.overdue):not(.today-due),
[data-theme="light"] .tasks-count,
[data-theme="light"] .task-check,
[data-theme="light"] .swipe-lbl,
[data-theme="light"] .pomo-phase,
[data-theme="light"] .pomo-ev-label,
[data-theme="light"] .pomo-header-title,
[data-theme="light"] .pomo-overlay-title,
[data-theme="light"] .scribble-title,
[data-theme="light"] .scribble-btn,
[data-theme="light"] .pen-size-btn,
[data-theme="light"] .picker-label,
[data-theme="light"] .picker-time,
[data-theme="light"] .picker-cancel,
[data-theme="light"] .insights-section-lbl,
[data-theme="light"] .stat-card-lbl,
[data-theme="light"] .stat-card-unit,
[data-theme="light"] .breath-hint,
[data-theme="light"] .focus-check-lbl,
[data-theme="light"] .modal-btn:not(.primary),
[data-theme="light"] .modal-saving,
[data-theme="light"] .nav-arrow,
[data-theme="light"] .sbtn:not(.on),
[data-theme="light"] .lifeos-det-updated,
[data-theme="light"] .daily-title-sub,
[data-theme="light"] .month-day-num { color: var(--accent); }

html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--ink); font-family:'Cormorant Garamond',serif; }
html { height: 100dvh; }
body { display:grid; grid-template-columns:36px 1fr 340px 340px; grid-template-rows:1fr; height:100dvh; }

/* Explicit column+row placement — prevents auto-placement cursor from bumping panels to row 2 */
#sidebar      { grid-column:1; grid-row:1; }
#panel-chrono { grid-column:2; grid-row:1; }
#panel-tasks  { grid-column:3; grid-row:1; }
#panel-left   { grid-column:4; grid-row:1; }

.panel { border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; min-width:0; }
#panel-left { border-right:none; }

/* HEADERS */
.panel-header { padding:9px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:5px; flex-shrink:0; }
.panel-title { font-size:15px; letter-spacing:0.20em; text-transform:uppercase; color:var(--ink-dim); font-family:'JetBrains Mono',monospace; }
#panel-chrono .panel-title { font-size:38px; font-weight:700; letter-spacing:0.18em; color:var(--accent); }
.cosmodex-logo { width:44px; height:44px; flex-shrink:0; color:var(--accent); }
.panel-accent { width:6px; height:6px; border-radius:50%; background:var(--gold); animation:pulse 3s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* Add button */
.add-btn { background:none; border:2px solid var(--gold-dim); border-radius:5px; color:var(--gold); cursor:pointer; font-size:22px; line-height:1; padding:4px 10px; min-height:44px; min-width:44px; display:flex; align-items:center; justify-content:center; }
.add-btn:active { background:var(--gold-dim); }

/* Theme toggle */
.theme-btn { background:none; border:2px solid var(--border); border-radius:6px; padding:8px 14px; cursor:pointer; font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.08em; color:var(--ink-dim); display:flex; align-items:center; gap:8px; min-height:44px; }
.theme-btn:active { background:var(--ink-faint); }

/* View toggle */
.view-toggle { display:flex; gap:3px; background:var(--ink-faint); border-radius:6px; padding:3px; margin-left:auto; }
.view-btn { font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.06em; text-transform:uppercase; color:var(--ink-dim); background:none; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; min-height:44px; min-width:56px; }
.view-btn.active { background:var(--border); color:var(--gold); }

/* Nav arrows */
.nav-arrow { background:none; border:2px solid var(--border); border-radius:5px; color:var(--ink-dim); cursor:pointer; font-size:22px; padding:6px 12px; line-height:1; min-height:44px; min-width:48px; }
.nav-arrow:active { background:var(--ink-faint); }

/* ── TABS (shared by calendar + tasks panels) ── */
.tab-bar { display:flex; gap:0; border-bottom:2px solid var(--border); flex-shrink:0; overflow-x:auto; scrollbar-width:none; }
.tab-bar::-webkit-scrollbar { display:none; }
.tab { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.08em; text-transform:uppercase; color:var(--ink-dim); background:none; border:none; border-bottom:3px solid transparent; padding:9px 14px; cursor:pointer; white-space:nowrap; flex-shrink:0; min-height:40px; }
.tab.active { color:var(--gold); border-bottom-color:var(--gold); }
.tab-dot { display:inline-block; width:7px; height:7px; border-radius:50%; margin-right:6px; vertical-align:middle; }

/* DAY VIEW */
.daily-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.daily-top { display:flex; align-items:center; justify-content:space-between; padding:8px 14px; border-bottom:2px solid var(--ink-faint); flex-shrink:0; }
.daily-title-num { font-size:34px; font-weight:300; line-height:1; }
.daily-title-sub { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); letter-spacing:0.08em; margin-top:2px; }
.daily-timeline { flex:1; overflow-y:auto; scrollbar-width:none; }
.daily-timeline::-webkit-scrollbar { display:none; }
.hour-row { display:flex; min-height:40px; border-bottom:1.5px solid var(--ink-faint); }
.hour-row.hour-now { background:rgba(61,184,255,0.08); }
.hour-label { width:52px; flex-shrink:0; font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); padding:6px 6px 0; text-align:right; }
.hour-label.now-lbl { color:var(--gold); }
.hour-events { flex:1; padding:4px 8px; display:flex; flex-direction:column; gap:3px; }
.hour-event { font-size:13px; padding:4px 10px; border-radius:3px; cursor:pointer; border-left:4px solid; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-family:'JetBrains Mono',monospace; }

/* WEEK VIEW */
.week-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.week-nav { display:flex; align-items:center; justify-content:space-between; padding:5px 14px; flex-shrink:0; }
.week-range { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); }
.week-grid { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.week-day { flex:1; display:flex; align-items:stretch; border-bottom:1.5px solid var(--ink-faint); }
.week-day:last-child { border-bottom:none; }
.week-day.today { background:rgba(61,184,255,0.07); }
.day-label { width:54px; flex-shrink:0; display:flex; flex-direction:column; align-items:center; justify-content:center; border-right:2px solid var(--ink-faint); }
.day-name { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.08em; color:var(--ink-dim); text-transform:uppercase; }
.day-num { font-size:22px; font-weight:300; line-height:1; margin-top:2px; }
.week-day.today .day-num { color:var(--gold); font-weight:400; }
.day-events { flex:1; padding:3px 8px; display:flex; flex-direction:column; gap:2px; justify-content:center; overflow:hidden; }
.cal-event { display:flex; align-items:center; gap:6px; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-family:'JetBrains Mono',monospace; }
.cal-event-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.cal-event-time { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); flex-shrink:0; }

/* MONTH VIEW */
.month-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.month-nav { display:flex; align-items:center; justify-content:space-between; padding:6px 14px 3px; flex-shrink:0; }
.month-title { font-size:22px; font-weight:300; }
.month-dow-row { display:grid; grid-template-columns:repeat(7,1fr); padding:0 6px; flex-shrink:0; }
.month-dow { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); text-align:center; padding:3px 0; text-transform:uppercase; }
.month-grid { flex:1; display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr; padding:0 6px 6px; gap:2px; overflow:hidden; }
.month-cell { display:flex; flex-direction:column; padding:3px 4px; border:2px solid transparent; border-radius:3px; min-height:0; }
.month-cell.weekend-start { border-left:2px solid rgba(196,75,58,0.35) !important; }
.month-cell.today { border-color:var(--gold); background:rgba(61,184,255,0.08); }
.month-cell.other-month { opacity:0.22; }
.month-day-num { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); line-height:1.3; text-align:center; }
.month-cell.today .month-day-num { color:var(--gold); font-weight:400; }
.month-dots { display:flex; flex-wrap:wrap; gap:2px; margin-top:2px; justify-content:center; }
.month-dot { width:6px; height:6px; border-radius:50%; }

/* CHRONODEX */
#panel-chrono { background:var(--bg); }
#panel-left, #panel-tasks { background:var(--surface); }
.chrono-wrapper { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:space-evenly; gap:0; padding:16px 20px 20px; width:100%; }
.time-display { text-align:center; }
.time-big { font-size:76px; font-weight:300; letter-spacing:0.04em; line-height:1; font-variant-numeric:tabular-nums; display:block; }
.time-date { font-family:'JetBrains Mono',monospace; font-size:15px; color:var(--ink-dim); letter-spacing:0.18em; margin-top:8px; text-transform:uppercase; display:block; }
/* Safari renders canvas with a default border/outline — suppress it */
#chronodex-canvas { max-width:100%; display:block; pointer-events:none; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent; outline:none; border:none; -webkit-appearance:none; appearance:none; }
.chrono-canvas-wrap { position:relative; display:block; width:100%; }
.chrono-tap-overlay { position:absolute; inset:0; cursor:pointer; user-select:none; -webkit-user-select:none; -webkit-tap-highlight-color:transparent; touch-action:manipulation; }
.next-strip { background:var(--ink-faint); border:2px solid var(--border); border-radius:3px; padding:12px 18px; width:100%; }
.next-lbl { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.18em; color:var(--ink-dim); text-transform:uppercase; margin-bottom:3px; }
.next-title { font-size:18px; font-weight:400; color:var(--gold); }
.next-time { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); margin-top:2px; }

/* EVENT PICKER */
#event-picker { position:fixed; z-index:500; display:none; background:var(--surface); border:2px solid var(--border); border-radius:6px; min-width:230px; max-width:320px; }
#event-picker.open { display:block; }
.picker-label { font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.15em; text-transform:uppercase; color:var(--ink-dim); padding:12px 16px 6px; }
.picker-item { display:flex; align-items:center; gap:12px; padding:12px 16px; cursor:pointer; border-top:1px solid var(--ink-faint); }
.picker-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.picker-text { flex:1; min-width:0; }
.picker-title { font-size:18px; font-weight:400; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.picker-time { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); margin-top:2px; }
.picker-divider { height:2px; background:var(--border); }
.picker-cancel { font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:var(--ink-dim); padding:12px 16px; cursor:pointer; display:block; }

/* TASKS */
#panel-tasks { background:var(--surface); }
.tasks-list { flex:1; overflow-y:auto; padding:4px 0; scrollbar-width:none; }
.tasks-list::-webkit-scrollbar { display:none; }
.task-group-lbl { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.18em; color:var(--gold-dim); text-transform:uppercase; padding:8px 16px 4px; }
.task-item { display:flex; align-items:flex-start; gap:10px; padding:8px 16px; border-bottom:1.5px solid var(--ink-faint); cursor:pointer; }
.task-item.done { opacity:0.35; }
.task-check { width:20px; height:20px; border:2px solid var(--border); border-radius:3px; flex-shrink:0; margin-top:1px; display:flex; align-items:center; justify-content:center; }
.task-item.done .task-check { background:var(--gold-dim); border-color:var(--gold-dim); }
.task-item.done .task-check::after { content:'✓'; font-size:12px; color:var(--gold); }
.task-body { flex:1; min-width:0; }
.task-title { font-size:14px; line-height:1.4; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-family:'JetBrains Mono',monospace; }
.task-item.done .task-title { text-decoration:line-through; }
.task-meta { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); margin-top:2px; }
.task-meta.overdue { color:var(--red); }
.task-meta.today-due { color:var(--amber); }
.task-pri { width:5px; align-self:stretch; border-radius:2px; flex-shrink:0; }
.pri-high{background:var(--red);} .pri-med{background:var(--amber);} .pri-low{background:var(--border);}
.tasks-footer { padding:8px 16px; border-top:2px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
.tasks-count { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); }

/* POMODORO */
#panel-pomo { display:none; } /* pomo is now an overlay */
.pomo-header { padding:12px 16px; border-bottom:2px solid var(--border); display:flex; align-items:center; gap:10px; flex-shrink:0; }
.pomo-header-title { font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.20em; text-transform:uppercase; color:var(--ink-dim); }
.pomo-close-btn { margin-left:auto; background:none; border:2px solid var(--border); border-radius:5px; color:var(--ink-dim); cursor:pointer; font-size:16px; padding:5px 10px; min-height:44px; min-width:44px; display:flex; align-items:center; justify-content:center; }
.pomo-close-btn:active { background:var(--ink-faint); }
.pomo-body { flex:1; display:flex; flex-direction:column; align-items:center; padding:14px 16px 16px; gap:12px; overflow-y:auto; scrollbar-width:none; }
.pomo-body::-webkit-scrollbar { display:none; }
.pomo-ev-label { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.18em; text-transform:uppercase; color:var(--ink-dim); text-align:center; }
.pomo-ev-title { font-size:20px; font-weight:300; color:var(--gold); text-align:center; line-height:1.3; width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.pomo-ring-wrap { position:relative; width:150px; height:150px; flex-shrink:0; }
#pomo-ring { position:absolute; inset:0; }
.pomo-center { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:none; }
.pomo-time { font-size:34px; font-weight:300; font-variant-numeric:tabular-nums; letter-spacing:-0.02em; line-height:1; }
.pomo-phase { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.15em; color:var(--ink-dim); text-transform:uppercase; margin-top:4px; }
.swipe-section { width:100%; }
.swipe-lbl { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.12em; color:var(--ink-dim); text-transform:uppercase; text-align:center; margin-bottom:8px; }
.swipe-control { display:flex; align-items:center; background:var(--ink-faint); border:2px solid var(--border); border-radius:5px; overflow:hidden; user-select:none; }
.swipe-minus,.swipe-plus { background:none; border:none; color:var(--ink-dim); cursor:pointer; padding:0 14px; height:52px; font-size:24px; display:flex; align-items:center; flex-shrink:0; min-width:48px; justify-content:center; }
.swipe-minus:active,.swipe-plus:active { background:var(--border); }
.swipe-track { flex:1; height:52px; position:relative; overflow:hidden; cursor:ew-resize; touch-action:none; }
.swipe-track-inner { width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; position:relative; }
.swipe-val { font-family:'JetBrains Mono',monospace; font-size:22px; color:var(--gold); line-height:1; pointer-events:none; }
.swipe-unit { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); pointer-events:none; margin-top:2px; }
.swipe-ticks { position:absolute; bottom:4px; left:0; right:0; display:flex; align-items:flex-end; justify-content:center; gap:2px; pointer-events:none; }
.tick { width:2px; border-radius:1px; background:var(--border); }
.tick.major { background:var(--gold-dim); }
.tick.current { background:var(--gold); width:3px; }
.pomo-btns { display:flex; gap:8px; width:100%; }
.pomo-btn { flex:1; padding:12px 0; font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.10em; text-transform:uppercase; border:2px solid var(--border); background:none; color:var(--ink-dim); cursor:pointer; border-radius:4px; min-height:48px; }
.pomo-btn.primary { background:var(--gold-dim); border-color:var(--gold); color:var(--gold); }
.pomo-btn.primary:active { background:var(--gold); color:var(--bg); }
.pomo-btn.danger { border-color:var(--red); color:var(--red); }
.pomo-btn.danger:active { background:rgba(196,75,58,0.15); }
.pomo-sess { display:flex; gap:8px; }
.sess-dot { width:13px; height:13px; border-radius:50%; border:2px solid var(--gold-dim); }
.sess-dot.done { background:var(--gold); border-color:var(--gold); }
.pomo-tip { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-faint); text-align:center; line-height:1.7; }

/* Light mode */
[data-theme="light"] .task-group-lbl { color:var(--accent); }

/* ── SIDEBAR RAIL ── */
#sidebar {
  background:var(--surface); border-right:1px solid var(--border);
  display:flex; flex-direction:column; align-items:center;
  padding:8px 0 10px; gap:4px; z-index:10; overflow:hidden;
}
.sbtn {
  width:34px; height:34px; border-radius:6px; background:none; border:none;
  color:var(--ink-dim); cursor:pointer; display:flex; align-items:center;
  justify-content:center; font-size:17px; flex-shrink:0;
}
.sbtn.on { color:var(--accent); background:var(--accent-dim); }
.sbtn:hover { background:var(--ink-faint); }
.sbtn-sep { width:22px; height:1px; background:var(--border); margin:4px 0; flex-shrink:0; }
#sbtn-lifeos { color:var(--accent); font-size:22px; }
#sbtn-tasks  { font-size:22px; }
#sbtn-habits { color:var(--accent); font-size:22px; }

/* Subtask indent */
.task-item.subtask { padding-left:38px; }
.task-add-sub {
  background:none; border:none; color:var(--ink-dim); cursor:pointer;
  font-size:13px; padding:2px 5px; flex-shrink:0;
  line-height:1; opacity:0.65;
}
.task-add-sub:hover { opacity:1; color:var(--accent); }
.task-del-btn {
  background:none; border:none; color:var(--ink-dim); cursor:pointer;
  font-size:12px; padding:2px 4px; flex-shrink:0; line-height:1;
  opacity:0.35; transition:opacity 0.15s;
}
.task-item:hover .task-del-btn { opacity:0.65; }
.task-del-btn:hover { color:var(--red) !important; opacity:1 !important; }
.ev-del-btn {
  position:absolute; right:4px; top:50%; transform:translateY(-50%);
  background:none; border:none; color:var(--ink-dim); cursor:pointer;
  font-size:11px; padding:2px 4px; opacity:0; transition:opacity 0.15s; z-index:3;
}
.hour-event:hover .ev-del-btn { opacity:0.7; }
.ev-del-btn:hover { color:var(--red) !important; opacity:1 !important; }

/* ══ RESPONSIVE / MOBILE ══ */
@media (max-width: 720px) {
  #sidebar { display:none !important; }
  body {
    grid-template-columns: 1fr !important;
    grid-template-rows: 1fr;
    position: relative;
  }
  /* All panels stack, only active one shows */
  .panel {
    position: absolute !important;
    inset: 0 !important;
    bottom: 56px !important; /* leave room for bottom nav */
    border-right: none !important;
    display: none !important;
  }
  .panel.mobile-active { display: flex !important; }

  /* Bottom nav bar */
  #mobile-nav {
    display: flex !important;
  }

  /* Cosmodex: make canvas fill width */
  .chrono-wrapper { padding: 8px 10px 10px; }
  #cosmodex-canvas { width: 100% !important; height: auto !important; }

  /* Time display smaller */
  .time-big { font-size: 40px; }

  /* Overlays: full screen */
  #pomo-overlay, #notes-overlay { inset: 0; }

  /* Day view: tighter */
  .hour-label { width: 40px; font-size: 11px; }

  /* Pomo col: full width */
  .pomo-col { width: 100%; border-right: none; }
  .scribble-col { display: none; } /* hide scribble on narrow screens */
  .pomo-overlay-inner { flex-direction: column; }
}

/* Mobile bottom navigation */
#mobile-nav {
  display: none; /* hidden on desktop */
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 56px;
  background: var(--surface);
  border-top: 2px solid var(--border);
  z-index: 600;
  justify-content: space-around;
  align-items: center;
}
.mob-nav-btn {
  flex: 1;
  height: 100%;
  background: none;
  border: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  cursor: pointer;
  color: var(--ink-dim);
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.10em;
  text-transform: uppercase;
}
.mob-nav-btn.active { color: var(--accent); }
.mob-nav-icon { font-size: 18px; line-height: 1; }

/* ══ SIGN-IN OVERLAY ══ */
#signin-overlay { position:fixed; inset:0; z-index:2000; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; }
#signin-overlay.hidden { display:none; }
.signin-logo { font-size:54px; opacity:0.6; }
.signin-title { font-family:'JetBrains Mono',monospace; font-size:22px; letter-spacing:0.22em; text-transform:uppercase; color:var(--ink); text-align:center; }
.signin-sub { font-family:'JetBrains Mono',monospace; font-size:14px; color:var(--ink-dim); text-align:center; line-height:1.8; }
.signin-btn { font-family:'JetBrains Mono',monospace; font-size:15px; letter-spacing:0.12em; text-transform:uppercase; padding:16px 36px; border-radius:6px; cursor:pointer; background:var(--gold-dim); border:2px solid var(--gold); color:var(--gold); min-height:56px; }
.signin-btn:active { background:var(--gold); color:var(--bg); }
.signin-note { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-faint); text-align:center; max-width:340px; line-height:1.8; }

/* ══ SYNC BAR ══ */
#sync-bar { position:fixed; bottom:0; left:0; right:0; z-index:1000; background:var(--surface); border-top:2px solid var(--border); padding:7px 16px; display:flex; align-items:center; gap:10px; font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); transform:translateY(100%); transition:transform 0.2s ease; }
#sync-bar.visible { transform:translateY(0); }
.sync-dot { width:7px; height:7px; border-radius:50%; background:var(--gold); animation:pulse 1.5s ease-in-out infinite; }
.sync-dot.ok { background:var(--green); animation:none; }
.sync-dot.err { background:var(--red); animation:none; }
#sync-user { margin-left:auto; color:var(--ink-faint); font-size:11px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px; }
.signout-btn { background:none; border:1px solid var(--border); border-radius:3px; color:var(--ink-dim); font-family:'JetBrains Mono',monospace; font-size:11px; padding:4px 10px; cursor:pointer; min-height:30px; }
.signout-btn:active { background:var(--ink-faint); }
.loading-msg { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); padding:20px 16px; }

/* ══ ADD ENTRY MODAL ══ */
.modal-backdrop { position:fixed; inset:0; z-index:900; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; }
.modal-backdrop.open { display:flex; }
.modal { background:var(--surface); border:2px solid var(--border); border-radius:8px; width:min(440px,95vw); max-height:90vh; overflow-y:auto; scrollbar-width:none; }
.modal::-webkit-scrollbar { display:none; }
.modal-header { padding:16px 20px 12px; border-bottom:2px solid var(--border); display:flex; align-items:center; gap:12px; }
.modal-title { font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.18em; text-transform:uppercase; color:var(--ink); }
.modal-close { margin-left:auto; background:none; border:none; color:var(--ink-dim); cursor:pointer; font-size:20px; line-height:1; padding:4px 6px; min-height:36px; min-width:36px; }
.modal-body { padding:20px; display:flex; flex-direction:column; gap:16px; }
.field { display:flex; flex-direction:column; gap:6px; }
.field label { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.14em; text-transform:uppercase; color:var(--ink-dim); }
.field input, .field select, .field textarea {
  background:var(--ink-faint); border:2px solid var(--border); border-radius:4px;
  color:var(--ink); font-family:'JetBrains Mono',monospace; font-size:14px;
  padding:10px 12px; width:100%; outline:none; appearance:none;
}
.field input:focus, .field select:focus, .field textarea:focus { border-color:var(--gold); }
.field-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.modal-footer { padding:14px 20px 18px; border-top:2px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }
.modal-btn { font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.10em; text-transform:uppercase; padding:12px 22px; border-radius:4px; cursor:pointer; border:2px solid var(--border); background:none; color:var(--ink-dim); min-height:46px; }
.modal-btn.primary { background:var(--gold-dim); border-color:var(--gold); color:var(--gold); }
.modal-btn.primary:active { background:var(--gold); color:var(--bg); }
.modal-btn:active { background:var(--ink-faint); }
.modal-saving { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); align-self:center; }


/* ── 24HR DAY VIEW ── */
.hour-row { display:flex; min-height:44px; border-bottom:1.5px solid var(--ink-faint); position:relative; }
.hour-row.hour-now { background:rgba(61,184,255,0.09); }
.hour-row.hour-past { opacity:0.55; }
.hour-row.drag-over { background:rgba(74,127,165,0.15); border-color:var(--blue); }
/* DRAG ── */
.task-item[draggable] { cursor:grab; }
.task-item.dragging { opacity:0.4; }
.drag-hint { font-size:16px; color:var(--ink-dim); margin-right:8px; align-self:center; flex-shrink:0; cursor:grab; }


/* ══ POMODORO OVERLAY ══ */
#pomo-overlay {
  display:none; position:fixed; z-index:800;
  inset:0;
  background:rgba(3,5,8,0.96);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  flex-direction:column;
}
#pomo-overlay.open { display:flex; }
[data-theme="light"] #pomo-overlay { background:rgba(232,240,250,0.95); }

.pomo-overlay-inner {
  flex:1; display:flex; overflow:hidden; justify-content:center;
}

/* Left half of overlay = pomodoro */
.pomo-col {
  width:min(400px,100%); flex-shrink:0; flex-grow:0;
  display:flex; flex-direction:column;
  border-right:2px solid var(--border);
  background:var(--pomo-bg);
  overflow-y:auto; scrollbar-width:none;
}
.pomo-col::-webkit-scrollbar { display:none; }

/* Right half = scribble canvas */
.scribble-col {
  flex:1; display:flex; flex-direction:column; overflow:hidden;
}
.scribble-header {
  padding:10px 16px; border-bottom:2px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0;
}
.scribble-title {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.16em; text-transform:uppercase; color:var(--ink-dim);
}
#scribble-canvas {
  flex:1; width:100%; cursor:crosshair;
  touch-action:none;
  -webkit-touch-callout:none;
  background:transparent;
}
.scribble-tools {
  display:flex; gap:8px; margin-left:auto; align-items:center;
}
.scribble-btn {
  background:none; border:1.5px solid var(--border); border-radius:4px;
  color:var(--ink-dim); cursor:pointer; font-family:'JetBrains Mono',monospace;
  font-size:11px; padding:5px 10px; min-height:32px;
}
.scribble-btn.active { border-color:var(--gold); color:var(--gold); }
.scribble-swatch {
  width:22px; height:22px; border-radius:50%; border:2px solid var(--border);
  cursor:pointer; flex-shrink:0;
}
.scribble-swatch.active { border-color:var(--gold); }
.pen-size-btn {
  background:none; border:1.5px solid var(--border); border-radius:50%;
  width:30px; height:30px; cursor:pointer; color:var(--ink-dim);
  display:flex; align-items:center; justify-content:center; padding:0; flex-shrink:0;
}
.pen-size-btn.active { border-color:var(--gold); color:var(--gold); }
.pen-size-btn:hover  { border-color:var(--ink-dim); }

/* Locked overlay when pomo running */
#pomo-lock-msg {
  display:none; position:absolute; inset:0; z-index:50;
  align-items:center; justify-content:center; flex-direction:column; gap:16px;
  background:rgba(0,0,0,0.72);
}
#pomo-lock-msg.show { display:flex; }
.lock-text {
  font-family:'JetBrains Mono',monospace; font-size:14px;
  letter-spacing:0.12em; color:var(--ink); text-align:center; line-height:1.8;
}
.lock-withdraw {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.10em; text-transform:uppercase;
  padding:12px 28px; border-radius:4px; cursor:pointer;
  border:2px solid var(--red); color:var(--red); background:none;
  min-height:46px;
}
.lock-withdraw:active { background:rgba(196,75,58,0.15); }

/* Pomo overlay header */
.pomo-overlay-header {
  padding:11px 16px; border-bottom:2px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0;
}
.pomo-overlay-title {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.18em; text-transform:uppercase; color:var(--ink-dim);
}

/* ── INSIGHTS OVERLAY ── */
#insights-overlay {
  display:none; position:fixed; inset:0; z-index:820;
  background:rgba(3,5,8,0.97); backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px); flex-direction:column;
}
#insights-overlay.open { display:flex; }
[data-theme="light"] #insights-overlay { background:rgba(232,240,250,0.97); }
.insights-header {
  padding:11px 16px; border-bottom:2px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0;
}
.insights-body {
  flex:1; overflow-y:auto; padding:28px 48px; scrollbar-width:none;
  display:flex; flex-direction:column; gap:32px;
  align-items:center; max-width:960px; margin:0 auto; width:100%;
  text-align:center;
}
.insights-body > * {
  width:100%;
}
.insights-body::-webkit-scrollbar { display:none; }
.insights-section-lbl {
  font-family:'JetBrains Mono',monospace; font-size:11px;
  letter-spacing:0.18em; text-transform:uppercase; color:var(--ink-dim);
  margin-bottom:10px;
}
.stat-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:18px; }
.stat-card {
  background:var(--ink-faint); border:1px solid var(--border); border-radius:8px; padding:22px 20px;
}
.stat-card-lbl {
  font-family:'JetBrains Mono',monospace; font-size:11px; letter-spacing:0.15em;
  text-transform:uppercase; color:var(--ink-dim); margin-bottom:8px;
}
.stat-card-val {
  font-size:40px; font-weight:300; color:var(--accent); line-height:1;
}
.stat-card-unit { font-size:14px; color:var(--ink-dim); }
.heatmap-wrap { display:flex; gap:4px; justify-content:center; }
.heatmap-col { display:flex; flex-direction:column; gap:4px; }
.heatmap-cell {
  width:36px; height:14px; border-radius:3px; flex-shrink:0;
}
/* 6×15 insights grid */
.insights-grid-6x15 {
  display:grid;
  grid-template-columns: repeat(15, 1fr);
  grid-template-rows: repeat(6, 1fr);
  gap:5px;
  width:100%;
}
.ig-cell {
  aspect-ratio:2/1;
  border-radius:3px;
  border:1px solid var(--border);
  cursor:default;
  transition:opacity 0.1s;
}
.ig-cell:hover { opacity:0.75; }

/* ── BREATHING RING ── */
.breath-section { display:flex; flex-direction:column; align-items:center; gap:8px; padding:10px 0 4px; }
.breath-ring-outer {
  width:72px; height:72px; border-radius:50%;
  border:2.5px solid var(--accent);
  display:flex; align-items:center; justify-content:center;
  animation:breathe-ring 16s ease-in-out infinite;
}
.breath-ring-inner {
  width:44px; height:44px; border-radius:50%;
  background:var(--accent-glow);
  animation:breathe-inner 16s ease-in-out infinite;
}
@keyframes breathe-ring {
  0%,100% { transform:scale(0.55); opacity:0.30; }
  25%      { transform:scale(1.00); opacity:0.85; }
  50%      { transform:scale(1.00); opacity:0.85; }
  75%      { transform:scale(0.55); opacity:0.30; }
}
@keyframes breathe-inner {
  0%,100% { transform:scale(0.45); opacity:0.15; }
  25%      { transform:scale(1.00); opacity:0.80; }
  50%      { transform:scale(1.00); opacity:0.80; }
  75%      { transform:scale(0.45); opacity:0.15; }
}
.breath-phase {
  font-family:'JetBrains Mono',monospace; font-size:12px;
  letter-spacing:0.16em; text-transform:uppercase; color:var(--accent);
  text-align:center; min-height:16px;
}
.breath-hint { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--ink-dim); letter-spacing:0.10em; }
/* ── FOCUS CHECKLIST ── */
.focus-checklist { width:100%; border-top:1px solid var(--border); padding-top:12px; }
.focus-check-lbl {
  font-family:'JetBrains Mono',monospace; font-size:10px; letter-spacing:0.16em;
  text-transform:uppercase; color:var(--ink-dim); margin-bottom:8px;
}
.focus-check-items { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; }
.focus-check-item { display:flex; align-items:center; gap:8px; padding:5px 8px; border-radius:4px; background:var(--ink-faint); }
.focus-check-item.done .focus-check-txt { text-decoration:line-through; opacity:0.45; }
.focus-check-box {
  width:16px; height:16px; border:2px solid var(--border); border-radius:3px;
  flex-shrink:0; display:flex; align-items:center; justify-content:center;
  font-size:10px; cursor:pointer;
}
.focus-check-item.done .focus-check-box { background:var(--accent-dim); border-color:var(--accent); color:var(--accent); }
.focus-check-txt { font-size:14px; flex:1; }
.focus-check-add { display:flex; gap:6px; align-items:center; }
.focus-check-add input {
  flex:1; background:var(--ink-faint); border:2px solid var(--border); border-radius:4px;
  color:var(--ink); font-family:'JetBrains Mono',monospace; font-size:13px;
  padding:6px 10px; outline:none;
}
.focus-check-add input:focus { border-color:var(--accent); }
.focus-check-add-btn {
  background:var(--accent-dim); border:2px solid var(--accent); border-radius:4px;
  color:var(--accent); cursor:pointer; font-size:18px; line-height:1;
  width:34px; height:34px; display:flex; align-items:center; justify-content:center;
  flex-shrink:0;
}

/* Paper grain */
body::after { content:''; position:fixed; inset:0; pointer-events:none; opacity:0.25; z-index:998;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"); }
[data-theme="light"] body::after { opacity:0.10; }

/* ══ LIFE OS OVERLAY ══ */
#lifeos-overlay {
  display:none; position:fixed; inset:0; z-index:830;
  background:rgba(3,5,8,0.97); backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px); flex-direction:column;
}
#lifeos-overlay.open { display:flex; }
[data-theme="light"] #lifeos-overlay { background:rgba(232,240,250,0.97); }

/* Password gate */
#lifeos-gate {
  position:absolute; inset:0; z-index:10; display:flex;
  align-items:center; justify-content:center; background:inherit;
}
#lifeos-gate.hidden { display:none; }
.lifeos-gate-inner {
  display:flex; flex-direction:column; align-items:center; gap:16px;
  background:var(--surface); border:2px solid var(--border);
  border-radius:12px; padding:44px 52px; min-width:300px;
}
.lifeos-gate-icon { font-size:44px; color:var(--accent); }
.lifeos-gate-title {
  font-family:'JetBrains Mono',monospace; font-size:18px;
  letter-spacing:0.22em; text-transform:uppercase; color:var(--ink);
}
.lifeos-gate-sub {
  font-family:'JetBrains Mono',monospace; font-size:12px;
  color:var(--ink-dim); letter-spacing:0.10em;
}
#lifeos-pin {
  background:var(--ink-faint); border:2px solid var(--border); border-radius:6px;
  color:var(--ink); font-size:24px; letter-spacing:0.5em; padding:12px 20px;
  text-align:center; width:100%; outline:none;
  font-family:'JetBrains Mono',monospace;
}
#lifeos-pin:focus { border-color:var(--accent); }
.lifeos-gate-err {
  font-family:'JetBrains Mono',monospace; font-size:12px;
  color:var(--red); min-height:16px; text-align:center;
}
.lifeos-gate-btn {
  background:var(--accent-dim); border:2px solid var(--accent); border-radius:6px;
  color:var(--accent); cursor:pointer; font-family:'JetBrains Mono',monospace;
  font-size:13px; letter-spacing:0.12em; text-transform:uppercase;
  padding:12px 0; min-height:46px; width:100%;
}
.lifeos-gate-btn:active { background:var(--accent); color:var(--bg); }
@keyframes lifeos-shake {
  0%,100%{transform:translateX(0)} 20%{transform:translateX(-10px)}
  40%{transform:translateX(10px)} 60%{transform:translateX(-7px)} 80%{transform:translateX(7px)}
}
.lifeos-gate-inner.shake { animation:lifeos-shake 0.45s ease; }

/* Header */
.lifeos-header {
  padding:11px 16px; border-bottom:2px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0;
  background:var(--surface);
}
.lifeos-header-title {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.18em; text-transform:uppercase; color:var(--accent);
}
.lifeos-hbtn {
  background:var(--accent-dim); border:2px solid var(--accent); border-radius:5px;
  color:var(--accent); cursor:pointer; font-family:'JetBrains Mono',monospace;
  font-size:12px; letter-spacing:0.10em; text-transform:uppercase;
  padding:6px 14px; min-height:36px; white-space:nowrap;
}
.lifeos-hbtn:active { background:var(--accent); color:var(--bg); }
.lifeos-hclose {
  margin-left:auto; background:none; border:2px solid var(--border); border-radius:5px;
  color:var(--ink-dim); cursor:pointer; font-family:'JetBrains Mono',monospace;
  font-size:12px; letter-spacing:0.08em; padding:6px 14px; min-height:36px;
}
.lifeos-hclose:active { background:var(--ink-faint); }

/* Body layout */
.lifeos-body { flex:1; display:flex; overflow:hidden; }

/* Left column */
.lifeos-left {
  width:300px; flex-shrink:0; border-right:2px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden; background:var(--surface);
}
.lifeos-search-row {
  padding:10px 12px; border-bottom:1px solid var(--border); flex-shrink:0;
}
.lifeos-search-row input {
  width:100%; background:var(--ink-faint); border:2px solid var(--border);
  border-radius:5px; color:var(--ink); font-family:'JetBrains Mono',monospace;
  font-size:13px; padding:8px 12px; outline:none;
}
.lifeos-search-row input:focus { border-color:var(--accent); }
.lifeos-cat-chips {
  display:flex; flex-wrap:wrap; gap:4px; padding:8px 12px;
  border-bottom:1px solid var(--border); flex-shrink:0;
}
.lifeos-chip {
  font-family:'JetBrains Mono',monospace; font-size:10px; letter-spacing:0.10em;
  text-transform:uppercase; background:none; border:1.5px solid var(--border);
  border-radius:20px; color:var(--ink-dim); cursor:pointer; padding:3px 10px; min-height:26px;
}
.lifeos-chip.active { border-color:var(--accent); color:var(--accent); background:var(--accent-dim); }
.lifeos-proj-list { flex:1; overflow-y:auto; scrollbar-width:none; }
.lifeos-proj-list::-webkit-scrollbar { display:none; }
.lifeos-proj-group-lbl {
  font-family:'JetBrains Mono',monospace; font-size:10px; letter-spacing:0.18em;
  text-transform:uppercase; color:var(--ink-dim); padding:10px 14px 4px;
}
.lifeos-proj-item {
  display:flex; align-items:center; gap:10px; padding:10px 14px;
  border-bottom:1px solid var(--ink-faint); cursor:pointer;
  border-left:3px solid transparent;
}
.lifeos-proj-item.active { background:var(--accent-dim); border-left-color:var(--accent); }
.lifeos-proj-item:hover:not(.active) { background:var(--ink-faint); }
.lifeos-proj-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.lifeos-proj-info { flex:1; min-width:0; }
.lifeos-proj-name {
  font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.3;
}
.lifeos-proj-meta {
  font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--ink-dim); margin-top:2px;
}
.lifeos-proj-mini-bar {
  width:36px; height:4px; background:var(--border); border-radius:2px; flex-shrink:0; overflow:hidden;
}
.lifeos-proj-mini-fill { height:100%; background:var(--accent); border-radius:2px; }

/* Right column */
.lifeos-right {
  flex:1; display:flex; flex-direction:column; overflow:hidden;
  background:var(--bg); position:relative;
}
.lifeos-empty {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:12px;
}
.lifeos-empty-icon { font-size:40px; opacity:0.25; }
.lifeos-empty-text {
  font-family:'JetBrains Mono',monospace; font-size:12px;
  letter-spacing:0.12em; color:var(--ink-dim);
}
#lifeos-detail {
  flex:1; overflow-y:auto; scrollbar-width:none;
  padding:24px 32px; display:flex; flex-direction:column; gap:20px;
}
#lifeos-detail::-webkit-scrollbar { display:none; }
.lifeos-field { display:flex; flex-direction:column; gap:6px; }
.lifeos-lbl {
  font-family:'JetBrains Mono',monospace; font-size:11px;
  letter-spacing:0.14em; text-transform:uppercase; color:var(--ink-dim);
}
.lifeos-inp {
  background:var(--ink-faint); border:2px solid var(--border); border-radius:5px;
  color:var(--ink); font-family:'JetBrains Mono',monospace;
  font-size:14px; padding:10px 12px; outline:none; width:100%; appearance:none;
}
.lifeos-inp:focus { border-color:var(--accent); }
textarea.lifeos-inp { resize:vertical; min-height:90px; font-family:'Cormorant Garamond',serif; font-size:16px; line-height:1.6; }
.lifeos-title-inp {
  background:none; border:none; border-bottom:2px solid var(--border);
  color:var(--ink); font-family:'Cormorant Garamond',serif; font-size:28px;
  font-weight:300; padding:4px 0 8px; outline:none; width:100%;
}
.lifeos-title-inp:focus { border-bottom-color:var(--accent); }

/* Progress */
.lifeos-prog-wrap { display:flex; align-items:center; gap:10px; }
.lifeos-prog-bar { flex:1; height:8px; background:var(--border); border-radius:4px; overflow:hidden; }
.lifeos-prog-fill { height:100%; background:var(--accent); border-radius:4px; transition:width 0.25s; }
.lifeos-prog-pct {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  color:var(--accent); min-width:40px; text-align:right;
}

/* Checklist */
.lifeos-checklist { display:flex; flex-direction:column; gap:4px; margin-bottom:6px; }
.lifeos-ci {
  display:flex; align-items:center; gap:8px; padding:7px 10px;
  background:var(--ink-faint); border-radius:4px; border:1px solid transparent;
}
.lifeos-ci:hover { border-color:var(--border); }
.lifeos-ci.done .lifeos-ci-txt { text-decoration:line-through; opacity:0.40; }
.lifeos-ci-box {
  width:17px; height:17px; border:2px solid var(--border); border-radius:3px;
  flex-shrink:0; display:flex; align-items:center; justify-content:center;
  font-size:10px; cursor:pointer;
}
.lifeos-ci.done .lifeos-ci-box { background:var(--accent-dim); border-color:var(--accent); color:var(--accent); }
.lifeos-ci-txt-inp {
  flex:1; background:none; border:none; color:var(--ink);
  font-family:'JetBrains Mono',monospace; font-size:13px; outline:none; padding:0;
}
.lifeos-ci.done .lifeos-ci-txt-inp { text-decoration:line-through; opacity:0.40; }
.lifeos-ci-del {
  background:none; border:none; color:var(--ink-dim); cursor:pointer;
  font-size:12px; padding:2px 5px; opacity:0.25; transition:opacity 0.15s;
}
.lifeos-ci:hover .lifeos-ci-del { opacity:0.60; }
.lifeos-ci-del:hover { color:var(--red); opacity:1 !important; }
.lifeos-check-add { display:flex; gap:6px; align-items:center; }
.lifeos-check-add-btn {
  background:var(--accent-dim); border:2px solid var(--accent); border-radius:4px;
  color:var(--accent); cursor:pointer; font-size:18px; line-height:1;
  width:36px; height:36px; display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.lifeos-check-add-btn:active { background:var(--accent); color:var(--bg); }

/* Footer */
.lifeos-det-footer {
  padding-top:12px; border-top:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
  flex-shrink:0;
}
.lifeos-det-updated {
  font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--ink-dim);
  letter-spacing:0.08em;
}
.lifeos-del-btn {
  background:none; border:2px solid var(--red); border-radius:5px;
  color:var(--red); cursor:pointer; font-family:'JetBrains Mono',monospace;
  font-size:12px; letter-spacing:0.10em; padding:8px 18px; min-height:38px;
}
.lifeos-del-btn:active { background:rgba(224,85,85,0.15); }

/* ══ HABITS OVERLAY ══ */
#habits-overlay {
  display:none; position:fixed; inset:0; z-index:820;
  background:rgba(3,5,8,0.97); backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px); flex-direction:column;
}
#habits-overlay.open { display:flex; }
[data-theme="light"] #habits-overlay { background:rgba(232,240,250,0.97); }
.habits-header {
  padding:11px 16px; border-bottom:2px solid var(--border);
  display:flex; align-items:center; gap:12px; flex-shrink:0;
}
.habits-header-title {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.18em; text-transform:uppercase; color:var(--accent);
}
.habits-body {
  flex:1; overflow-y:auto; padding:28px 48px; scrollbar-width:none;
  display:flex; flex-direction:column; gap:36px;
  max-width:960px; margin:0 auto; width:100%;
}
.habits-body::-webkit-scrollbar { display:none; }
/* Tabs */
.habits-tab-bar {
  display:flex; gap:0; border-bottom:2px solid var(--border); flex-shrink:0;
}
.habits-tab {
  font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.10em;
  text-transform:uppercase; color:var(--ink-dim); background:none; border:none;
  border-bottom:3px solid transparent; padding:10px 18px; cursor:pointer;
}
.habits-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
/* Section label */
.habits-section-lbl {
  font-family:'JetBrains Mono',monospace; font-size:11px; letter-spacing:0.18em;
  text-transform:uppercase; color:var(--accent); margin-bottom:14px;
}
/* Day strip */
.habit-day-strip {
  display:flex; gap:5px; margin-bottom:18px; align-items:flex-end;
}
.habit-day-cell {
  display:flex; flex-direction:column; align-items:center; gap:4px; flex:1;
}
.habit-day-label {
  font-family:'JetBrains Mono',monospace; font-size:9px;
  letter-spacing:0.08em; color:var(--accent); text-transform:uppercase;
}
.habit-day-label.today { color:var(--accent); font-weight:700; }
/* Habit rows */
.habit-row {
  display:flex; align-items:center; gap:10px;
  padding:10px 0; border-bottom:1px solid var(--border);
}
.habit-row:last-child { border-bottom:none; }
.habit-name {
  font-size:15px; font-weight:400; flex:1; min-width:0;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.habit-checks { display:flex; gap:5px; flex-shrink:0; }
.habit-check-box {
  width:28px; height:28px; border:2px solid var(--border); border-radius:4px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:13px; flex-shrink:0; transition:background 0.15s, border-color 0.15s;
  background:none; color:transparent;
}
.habit-check-box.done {
  background:var(--accent-dim); border-color:var(--accent); color:var(--accent);
}
.habit-check-box.today-col { border-color:var(--accent); }
/* Add habit input row */
.habit-add-row {
  display:flex; gap:8px; margin-top:16px;
}
.habit-add-inp {
  flex:1; background:var(--ink-faint); border:2px solid var(--border);
  border-radius:5px; color:var(--ink); font-family:'JetBrains Mono',monospace;
  font-size:13px; padding:10px 14px; outline:none;
}
.habit-add-inp:focus { border-color:var(--accent); }
.habit-add-btn {
  background:var(--accent-dim); border:2px solid var(--accent);
  border-radius:5px; color:var(--accent); cursor:pointer;
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.08em; padding:10px 18px; min-height:44px; white-space:nowrap;
}
.habit-add-btn:active { background:var(--accent); color:var(--bg); }
.habit-del-btn {
  background:none; border:none; color:var(--ink-dim); cursor:pointer;
  font-size:16px; padding:4px 8px; opacity:0.3; flex-shrink:0;
}
.habit-del-btn:hover { opacity:1; color:var(--red); }
/* Streak badge */
.habit-streak {
  font-family:'JetBrains Mono',monospace; font-size:10px;
  color:var(--accent); letter-spacing:0.08em; flex-shrink:0; min-width:32px; text-align:right;
}
/* Note/textarea for routines & behaviours */
.habits-textarea {
  width:100%; min-height:140px; background:var(--ink-faint);
  border:2px solid var(--border); border-radius:5px; color:var(--ink);
  font-family:'Cormorant Garamond',serif; font-size:16px; line-height:1.7;
  padding:14px 16px; outline:none; resize:vertical;
}
.habits-textarea:focus { border-color:var(--accent); }
.habits-save-btn {
  background:var(--accent-dim); border:2px solid var(--accent);
  border-radius:5px; color:var(--accent); cursor:pointer;
  font-family:'JetBrains Mono',monospace; font-size:12px;
  letter-spacing:0.10em; padding:9px 22px; min-height:40px; margin-top:10px;
}
.habits-save-btn:active { background:var(--accent); color:var(--bg); }
/* Routine item */
.routine-item {
  display:flex; align-items:flex-start; gap:10px;
  padding:10px 0; border-bottom:1px solid var(--border);
}
.routine-item:last-child { border-bottom:none; }
.routine-time-inp {
  width:72px; background:var(--ink-faint); border:2px solid var(--border);
  border-radius:4px; color:var(--accent); font-family:'JetBrains Mono',monospace;
  font-size:12px; padding:6px 8px; outline:none; flex-shrink:0;
}
.routine-time-inp:focus { border-color:var(--accent); }
.routine-text-inp {
  flex:1; background:none; border:none; color:var(--ink);
  font-family:'JetBrains Mono',monospace; font-size:13px; outline:none; padding:6px 0;
}
</style>
</head>
<body>

<!-- SIDEBAR RAIL -->
<div id="sidebar">
  <button class="sbtn on" id="sbtn-cal" title="Calendar" onclick="toggleSidePanel('left')">&#128197;</button>
  <button class="sbtn on" id="sbtn-tasks" title="Tasks" onclick="toggleSidePanel('tasks')">&#9745;</button>
  <div class="sbtn-sep"></div>
  <button class="sbtn" id="sbtn-insights" title="Insights" onclick="openInsights()">&#128200;</button>
  <button class="sbtn" id="sbtn-habits" title="Habits" onclick="openHabits()">&#9733;</button>
  <button class="sbtn" id="sbtn-lifeos" title="Life OS" onclick="openLifeOS()">&#10010;</button>
  <div style="flex:1"></div>
  <button class="sbtn" id="theme-btn" title="Toggle theme">&#9788;</button>
</div>

<!-- COL 1: CALENDAR -->
<section class="panel" id="panel-left">
  <div class="panel-header">
    <button class="add-btn" id="add-event-btn" title="Add event">+</button>
    <span class="panel-title" id="left-title" style="font-size:13px;margin-left:6px"></span>
    <div class="view-toggle" style="margin-left:auto">
      <button class="view-btn active" data-view="day">Day</button>
      <button class="view-btn" data-view="week">Week</button>
      <button class="view-btn" data-view="month">Mon</button>
    </div>
  </div>
  <div class="tab-bar" id="cal-tab-bar" style="display:none"></div>
  <div id="left-content" style="flex:1;display:flex;flex-direction:column;overflow:hidden;"></div>
</section>

<!-- COL 2: TASKS -->
<section class="panel" id="panel-tasks">
  <div class="panel-header">
    <button class="add-btn" id="add-task-btn" title="Add task">+</button>
    <span class="panel-title" style="margin-left:6px">Tasks</span>
  </div>
  <div class="tab-bar" id="task-tab-bar" style="display:none"></div>
  <div class="tasks-list" id="tasks-list"></div>
  <div class="tasks-footer">
    <span class="tasks-count" id="tasks-count"></span>

  </div>
</section>

<!-- COL 3: CHRONODEX -->
<section class="panel" id="panel-chrono">
  <div class="panel-header">
    <svg class="cosmodex-logo" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <circle cx="11" cy="11" r="9" stroke="currentColor" stroke-width="1.5" opacity="0.7"/>
      <circle cx="11" cy="11" r="5.5" stroke="currentColor" stroke-width="1" opacity="0.5"/>
      <circle cx="11" cy="11" r="1.5" fill="currentColor"/>
      <line x1="11" y1="2" x2="11" y2="5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="11" y1="17" x2="11" y2="20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <line x1="2" y1="11" x2="5" y2="11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <line x1="17" y1="11" x2="20" y2="11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
    </svg>
    <span class="panel-title">Cosmodex</span>
    <div class="view-toggle" style="margin-left:auto">
      <button class="view-btn" id="notes-btn" title="Quick note">&#9998; Notes</button>
      <button class="view-btn" id="pomo-open-btn" title="Focus timer">&#9650; Focus</button>
    </div>
  </div>
  <div class="chrono-wrapper">
    <div class="time-display">
      <div class="time-big" id="time-big">00:00</div>
      <div class="time-date" id="time-date"></div>
    </div>
    <div class="chrono-canvas-wrap">
      <canvas id="cosmodex-canvas" width="760" height="500"></canvas>
      <div class="chrono-tap-overlay" id="chrono-overlay"></div>
    </div>
    <div class="next-strip">
      <div class="next-lbl">Next · 30 min</div>
      <div class="next-title" id="next-title">—</div>
      <div class="next-time" id="next-time"></div>
    </div>
  </div>
</section>

<!-- POMODORO + SCRIBBLE OVERLAY (covers tasks+chrono) -->
<div id="pomo-overlay">
  <div class="pomo-overlay-header">
    <span class="pomo-overlay-title">&#9650; Focus</span>
    <button class="pomo-close-btn" id="pomo-close" style="margin-left:auto">✕</button>
  </div>
  <div class="pomo-overlay-inner">
    <!-- Pomodoro col -->
    <div class="pomo-col">
      <div class="pomo-body">
        <div class="pomo-ev-label">Focus Session</div>
        <div class="pomo-ev-title" id="pomo-ev-title">—</div>
        <div class="pomo-ring-wrap">
          <canvas id="pomo-ring" width="150" height="150"></canvas>
          <div class="pomo-center">
            <div class="pomo-time" id="pomo-time">25:00</div>
            <div class="pomo-phase" id="pomo-phase">Ready</div>
          </div>
        </div>
        <div class="swipe-section">
          <div class="swipe-control">
            <button class="swipe-minus" id="sw-minus">−</button>
            <div class="swipe-track" id="sw-track">
              <div class="swipe-track-inner">
                <div style="display:flex;align-items:baseline;justify-content:center;gap:6px;margin-bottom:2px">
                  <div class="swipe-val" id="sw-val">25</div>
                  <div style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--ink-dim);padding-bottom:2px">min</div>
                </div>
                <div class="swipe-ticks" id="sw-ticks"></div>
              </div>
            </div>
            <button class="swipe-plus" id="sw-plus">+</button>
          </div>
        </div>
        <div class="pomo-btns">
          <button class="pomo-btn danger" id="pomo-reset">Reset</button>
          <button class="pomo-btn primary" id="pomo-start">Start</button>
        </div>
        <div class="pomo-sess" id="pomo-sess">
          <div class="sess-dot"></div><div class="sess-dot"></div>
          <div class="sess-dot"></div><div class="sess-dot"></div>
        </div>

        <!-- Breathing ring -->
        <div class="breath-section">
          <div class="breath-ring-outer"><div class="breath-ring-inner"></div></div>
          <div class="breath-phase" id="breath-phase">Breathe in</div>
          <div class="breath-hint">Box breathing · 4-4-4-4</div>
        </div>

        <!-- Session checklist -->
        <div class="focus-checklist">
          <div class="focus-check-lbl">Session checklist</div>
          <div class="focus-check-items" id="focus-check-items"></div>
          <div class="focus-check-add">
            <input type="text" id="focus-check-input" placeholder="Add item…" autocomplete="off">
            <button class="focus-check-add-btn" id="focus-check-add-btn">+</button>
          </div>
        </div>

      </div>
    </div>
    <!-- Scribble col -->
    <div class="scribble-col">
      <div class="scribble-header">
        <span class="scribble-title">&#9998; Notes</span>
        <div class="scribble-tools">
          <div id="pen-size-bar" style="display:flex;gap:4px;align-items:center"></div>
          <div id="color-swatches" style="display:flex;gap:6px;align-items:center"></div>
          <button class="scribble-btn" id="scribble-eraser">Erase</button>
          <button class="scribble-btn" id="scribble-clear">Clear</button>
          <button class="scribble-btn" id="scribble-download">&#8681; Save</button>
        </div>
      </div>
      <canvas id="scribble-canvas"></canvas>
    </div>
  </div>
  <!-- Lock screen shown when timer is running -->
  <div id="pomo-lock-msg">
    <div class="lock-text">Session in progress.<br>Stop the timer to close.</div>
    <button class="lock-withdraw" id="pomo-withdraw">Withdraw Session</button>
  </div>
</div>

</section>

<!-- TASK→EVENT MODAL -->
<div class="modal-backdrop" id="modal-task2event">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="t2e-modal-title">Schedule Task</span>
      <button class="modal-close" id="modal-t2e-close">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Title</label>
        <input type="text" id="t2e-title" autocomplete="off">
      </div>
      <div class="field-row">
        <div class="field">
          <label>Date</label>
          <input type="date" id="t2e-date">
        </div>
        <div class="field">
          <label>Calendar</label>
          <select id="t2e-cal"></select>
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Start time</label>
          <input type="time" id="t2e-start">
        </div>
        <div class="field">
          <label>Duration (min)</label>
          <input type="number" id="t2e-dur" value="30" min="5" max="480" step="15">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span class="modal-saving" id="t2e-saving" style="display:none">Saving…</span>
      <button class="modal-btn" id="t2e-cancel">Cancel</button>
      <button class="modal-btn primary" id="t2e-save">Add to Calendar</button>
    </div>
  </div>
</div>

<!-- QUICK NOTES SCRIBBLE OVERLAY -->
<div id="notes-overlay" style="display:none;position:fixed;inset:0;z-index:810;background:rgba(3,5,8,0.97);backdrop-filter:blur(6px);flex-direction:column;">
  <div style="display:flex;align-items:center;padding:10px 16px;border-bottom:2px solid var(--border);flex-shrink:0;gap:8px;background:var(--surface);">
    <span style="font-family:'JetBrains Mono',monospace;font-size:12px;letter-spacing:0.18em;text-transform:uppercase;color:var(--blue)">&#9998; Notes</span>
    <div id="notes-pen-bar" style="display:flex;gap:4px;align-items:center;margin-left:12px"></div>
    <div id="notes-color-bar" style="display:flex;gap:5px;align-items:center"></div>
    <button class="scribble-btn" id="notes-eraser-btn">Erase</button>
    <button class="scribble-btn" id="notes-clear-btn2">Clear</button>
    <button class="scribble-btn" id="notes-save-btn">&#8681; Save</button>
    <button class="scribble-btn" id="notes-overlay-close" style="margin-left:auto;border-color:var(--border)">&#10005; Close</button>
  </div>
  <canvas id="notes-canvas" style="flex:1;width:100%;touch-action:none;cursor:crosshair;-webkit-touch-callout:none;"></canvas>
</div>

<!-- INSIGHTS OVERLAY -->
<div id="insights-overlay">
  <div class="insights-header">
    <span style="font-family:'JetBrains Mono',monospace;font-size:13px;letter-spacing:0.18em;text-transform:uppercase;color:var(--accent)">&#128200; Insights</span>
    <button onclick="closeInsights()" style="margin-left:auto;background:none;border:2px solid var(--border);border-radius:5px;color:var(--ink-dim);cursor:pointer;font-size:16px;padding:5px 10px;min-height:44px;min-width:44px">✕</button>
  </div>
  <div class="insights-body">
    <div>
      <div class="insights-section-lbl">Focus Heatmap — Last 90 Days</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--ink-dim);margin-bottom:8px">Each cell = 1 day · full blue = 4h+ deep work</div>
      <div id="heatmap-wrap" class="heatmap-wrap"></div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--ink-dim)">
        <span>0h</span>
        <div id="heatmap-legend" style="display:flex;gap:2px"></div>
        <span>4h+</span>
      </div>
    </div>
    <div>
      <div class="insights-section-lbl">Focus Stats</div>
      <div class="stat-grid" id="insights-stats"></div>
    </div>
    <div>
      <div class="insights-section-lbl">90-Day Focus Grid — 6 rows &times; 15 days</div>
      <div class="insights-grid-6x15" id="insights-grid-6x15"></div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--ink-dim)">
        <span>0h</span>
        <div id="insights-grid-legend" style="display:flex;gap:4px"></div>
        <span>4h+</span>
      </div>
    </div>
  </div>
</div>

<!-- HABITS OVERLAY -->
<div id="habits-overlay">
  <div class="habits-header">
    <span class="habits-header-title">&#9651; Habits &middot; Routines &middot; Behaviours</span>
    <button onclick="closeHabits()" style="margin-left:auto;background:none;border:2px solid var(--border);border-radius:5px;color:var(--ink-dim);cursor:pointer;font-size:16px;padding:5px 10px;min-height:44px;min-width:44px">&#10005;</button>
  </div>
  <!-- Tab bar -->
  <div class="habits-tab-bar">
    <button class="habits-tab active" id="htab-habits" onclick="switchHabitsTab('habits')">Habits</button>
    <button class="habits-tab" id="htab-routines" onclick="switchHabitsTab('routines')">Routines</button>
    <button class="habits-tab" id="htab-behaviours" onclick="switchHabitsTab('behaviours')">Behaviours</button>
  </div>
  <!-- Habits tab -->
  <div id="hpane-habits" class="habits-body">
    <div>
      <div class="habits-section-lbl">Daily Habit Tracker — Last 7 days</div>
      <div id="habits-day-strip" class="habit-day-strip"></div>
      <div id="habits-list"></div>
      <div class="habit-add-row">
        <input class="habit-add-inp" id="habit-new-inp" placeholder="Add a habit&#8230;" autocomplete="off" maxlength="60">
        <button class="habit-add-btn" onclick="habitsAddNew()">+ Add</button>
      </div>
    </div>
  </div>
  <!-- Routines tab -->
  <div id="hpane-routines" class="habits-body" style="display:none">
    <div>
      <div class="habits-section-lbl">Morning Routine</div>
      <div id="routines-morning-list"></div>
      <div class="habit-add-row" style="margin-top:12px">
        <input class="routine-time-inp" id="routine-morning-time" placeholder="06:00" style="margin-right:4px">
        <input class="habit-add-inp" id="routine-morning-inp" placeholder="Add morning routine step&#8230;" autocomplete="off" maxlength="80">
        <button class="habit-add-btn" onclick="routineAdd('morning')">+ Add</button>
      </div>
    </div>
    <div>
      <div class="habits-section-lbl">Evening Routine</div>
      <div id="routines-evening-list"></div>
      <div class="habit-add-row" style="margin-top:12px">
        <input class="routine-time-inp" id="routine-evening-time" placeholder="21:00" style="margin-right:4px">
        <input class="habit-add-inp" id="routine-evening-inp" placeholder="Add evening routine step&#8230;" autocomplete="off" maxlength="80">
        <button class="habit-add-btn" onclick="routineAdd('evening')">+ Add</button>
      </div>
    </div>
  </div>
  <!-- Behaviours tab -->
  <div id="hpane-behaviours" class="habits-body" style="display:none">
    <div>
      <div class="habits-section-lbl">Identity &amp; Values</div>
      <textarea class="habits-textarea" id="behav-identity" placeholder="Who am I becoming? What do I stand for?&#10;e.g. I am someone who shows up consistently…" oninput="behavSave()"></textarea>
    </div>
    <div>
      <div class="habits-section-lbl">Keystone Behaviours</div>
      <div id="behav-keystone-list"></div>
      <div class="habit-add-row" style="margin-top:12px">
        <input class="habit-add-inp" id="behav-keystone-inp" placeholder="Add a keystone behaviour&#8230;" autocomplete="off" maxlength="100">
        <button class="habit-add-btn" onclick="behavKeystoneAdd()">+ Add</button>
      </div>
    </div>
    <div>
      <div class="habits-section-lbl">Reflection Notes</div>
      <textarea class="habits-textarea" id="behav-notes" placeholder="Weekly reflection, friction points, what's working&#8230;" oninput="behavSave()"></textarea>
    </div>
  </div>
</div>

<!-- LIFE OS OVERLAY -->
<div id="lifeos-overlay">

  <!-- Password gate -->
  <div id="lifeos-gate">
    <div class="lifeos-gate-inner">
      <div class="lifeos-gate-icon">&#10010;</div>
      <div class="lifeos-gate-title">Life OS</div>
      <div class="lifeos-gate-sub">Enter PIN to access</div>
      <input type="password" id="lifeos-pin" maxlength="10" placeholder="&#9679;&#9679;&#9679;&#9679;" autocomplete="off" inputmode="numeric">
      <div class="lifeos-gate-err" id="lifeos-gate-err"></div>
      <button class="lifeos-gate-btn" id="lifeos-pin-submit">Unlock</button>
    </div>
  </div>

  <!-- Main panel (shown after auth) -->
  <div id="lifeos-main" style="display:none;flex:1;flex-direction:column;overflow:hidden;">

    <!-- Header -->
    <div class="lifeos-header">
      <span class="lifeos-header-title">&#10010; Life OS</span>
      <button class="lifeos-hbtn" id="lifeos-add-btn">+ Project</button>
      <button class="lifeos-hbtn" id="lifeos-sync-btn">&#8635; Sync</button>
      <button class="lifeos-hclose" id="lifeos-close-btn">&#10005; Close</button>
    </div>

    <!-- Body -->
    <div class="lifeos-body">

      <!-- LEFT: project list -->
      <div class="lifeos-left">
        <div class="lifeos-search-row">
          <input type="text" id="lifeos-search" placeholder="Search projects&#8230;" autocomplete="off">
        </div>
        <div class="lifeos-cat-chips" id="lifeos-cat-chips"></div>
        <div class="lifeos-proj-list" id="lifeos-proj-list"></div>
      </div>

      <!-- RIGHT: project detail -->
      <div class="lifeos-right">
        <div class="lifeos-empty" id="lifeos-empty">
          <div class="lifeos-empty-icon">&#128203;</div>
          <div class="lifeos-empty-text">Select a project or click + Project</div>
        </div>
        <div id="lifeos-detail" style="display:none;">
          <!-- Title -->
          <div class="lifeos-field">
            <input type="text" class="lifeos-title-inp" id="lifeos-det-title" placeholder="Project title&#8230;" autocomplete="off">
          </div>
          <!-- Category + meta row -->
          <div style="display:flex;gap:12px;align-items:center;">
            <div class="lifeos-field" style="flex:1">
              <label class="lifeos-lbl">Category</label>
              <select id="lifeos-det-cat" class="lifeos-inp">
                <option value="Mind">Mind</option>
                <option value="Body">Body</option>
                <option value="Soul">Soul</option>
                <option value="Growth">Growth</option>
                <option value="Relationships">Relationships</option>
                <option value="Cosmos">Cosmos</option>
              </select>
            </div>
            <div class="lifeos-field" style="flex:2">
              <label class="lifeos-lbl">Progress</label>
              <div class="lifeos-prog-wrap">
                <div class="lifeos-prog-bar"><div class="lifeos-prog-fill" id="lifeos-prog-fill" style="width:0%"></div></div>
                <span class="lifeos-prog-pct" id="lifeos-prog-pct">0%</span>
              </div>
            </div>
          </div>
          <!-- Notes -->
          <div class="lifeos-field">
            <label class="lifeos-lbl">Notes &amp; Context</label>
            <textarea id="lifeos-det-notes" class="lifeos-inp" rows="4" placeholder="Add notes, links, ideas&#8230;"></textarea>
          </div>
          <!-- Checklist -->
          <div class="lifeos-field">
            <label class="lifeos-lbl">Checklist &amp; Plan</label>
            <div class="lifeos-checklist" id="lifeos-checklist"></div>
            <div class="lifeos-check-add">
              <input type="text" id="lifeos-check-inp" class="lifeos-inp" placeholder="Add item&#8230;" autocomplete="off" style="flex:1">
              <button class="lifeos-check-add-btn" id="lifeos-check-add-btn">+</button>
            </div>
          </div>
          <!-- Footer -->
          <div class="lifeos-det-footer">
            <span class="lifeos-det-updated" id="lifeos-det-updated"></span>
            <button class="lifeos-del-btn" id="lifeos-det-delete">&#128465; Delete Project</button>
          </div>
        </div>
      </div>

    </div><!-- /lifeos-body -->
  </div><!-- /lifeos-main -->
</div><!-- /lifeos-overlay -->

<!-- SIGN-IN OVERLAY -->
<div id="signin-overlay">
  <div class="signin-logo">◷</div>
  <div class="signin-title">Cosmodex</div>
  <div class="signin-sub">Your day, at a glance.<br>Sign in to load your calendar &amp; tasks.</div>
  <button class="signin-btn" id="signin-btn">Sign in with Google</button>
  <div class="signin-note">Calendar &amp; Tasks access (read + write).<br>No data stored anywhere.</div>
</div>

<!-- SYNC BAR -->
<div id="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-msg">Syncing…</span>
  <span id="sync-user"></span>
  <button class="signout-btn" id="signout-btn">Sign out</button>
</div>

<!-- EVENT PICKER (tap dial) -->
<div id="event-picker">
  <div class="picker-label">Start Pomodoro for</div>
  <div id="picker-items"></div>
  <div class="picker-divider"></div>
  <div class="picker-cancel" id="picker-cancel">Cancel</div>
</div>

<!-- ADD EVENT MODAL -->
<div class="modal-backdrop" id="modal-event">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Add Calendar Event</span>
      <button class="modal-close" id="modal-event-close">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Title</label>
        <input type="text" id="ev-title" placeholder="Event title" autocomplete="off">
      </div>
      <div class="field-row">
        <div class="field">
          <label>Date</label>
          <input type="date" id="ev-date">
        </div>
        <div class="field">
          <label>Calendar</label>
          <select id="ev-cal"></select>
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Start time</label>
          <input type="time" id="ev-start">
        </div>
        <div class="field">
          <label>Duration (min)</label>
          <input type="number" id="ev-dur" value="30" min="5" max="480" step="15">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span class="modal-saving" id="ev-saving" style="display:none">Saving…</span>
      <button class="modal-btn" id="ev-cancel">Cancel</button>
      <button class="modal-btn primary" id="ev-save">Add Event</button>
    </div>
  </div>
</div>

<!-- ADD TASK MODAL -->
<div class="modal-backdrop" id="modal-task">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Add Task</span>
      <button class="modal-close" id="modal-task-close">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Title</label>
        <input type="text" id="tk-title" placeholder="Task title" autocomplete="off">
      </div>
      <div class="field-row">
        <div class="field">
          <label>Due date (optional)</label>
          <input type="date" id="tk-date">
        </div>
        <div class="field">
          <label>Task list</label>
          <select id="tk-list"></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span class="modal-saving" id="tk-saving" style="display:none">Saving…</span>
      <button class="modal-btn" id="tk-cancel">Cancel</button>
      <button class="modal-btn primary" id="tk-save">Add Task</button>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════
//  GOOGLE API — Calendar + Tasks (read + write)
// ══════════════════════════════════════════════════════
const CLIENT_ID  = '663470287783-ljsv9gr282m780ue4mlbu6qoqulenk7u.apps.googleusercontent.com';
const SCOPES     = [
  'https://www.googleapis.com/auth/calendar.events',
  'https://www.googleapis.com/auth/tasks',
  'https://www.googleapis.com/auth/userinfo.email',
  'https://www.googleapis.com/auth/spreadsheets',
].join(' ');
const SCOPE_VER  = 'v3-rw';  // bumped: added spreadsheets scope

// Local date helper — fixes UTC vs local timezone mismatch (critical for SGT UTC+8)
function localDate(d){
  const dt = d || new Date();
  return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
}
function localDatetime(d){
  // Returns YYYY-MM-DDTHH:MM in local time (for input[type=date/time] prefill)
  const dt = d || new Date();
  return localDate(dt)+'T'+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
}
function dtToLocal(apiStr){
  // Convert Google Calendar API datetime string to local YYYY-MM-DDTHH:MM
  // Handles both "2026-02-26T02:00:00Z" (UTC) and "2026-02-26T10:00:00+08:00" (offset)
  const d = new Date(apiStr);
  return localDate(d)+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
}
const CAL_API    = 'https://www.googleapis.com/calendar/v3';
const TASKS_API  = 'https://www.googleapis.com/tasks/v1';
const SHEETS_API = 'https://sheets.googleapis.com/v4/spreadsheets';
let   SHEETS_ID  = localStorage.getItem('cosmodex_sheets_id') || '';

async function ensureSheet(){
  if(SHEETS_ID) return SHEETS_ID;
  try{
    const res=await apiPost(SHEETS_API,{
      properties:{title:'Cosmodex Trends'},
      sheets:[{properties:{title:'Tasks',index:0}},{properties:{title:'Events',index:1}}]
    });
    SHEETS_ID=res.spreadsheetId;
    localStorage.setItem('cosmodex_sheets_id',SHEETS_ID);
    return SHEETS_ID;
  }catch(e){ return null; }
}
async function logToSheet(sheetName,row){
  if(!accessToken) return;
  try{
    const sid=await ensureSheet();
    if(!sid) return;
    await fetch(`${SHEETS_API}/${sid}/values/${sheetName}!A1:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`,{
      method:'POST',
      headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
      body:JSON.stringify({values:[row]}),
    });
  }catch(e){ console.warn('Sheet log failed:',e); }
}

// ── DATA ──────────────────────────────────────────────
let EVENTS       = [];  // all events
let TASKS        = [];  // all tasks
let CAL_LIST     = [];  // [{id, name, color}]  — all writable calendars
let TASK_LISTS   = [];  // [{id, title}]         — all task lists

// Tabs state
let activeCalTab  = 'all';   // calendarId or 'all'
let activeTaskTab = 'all';   // list id or 'all'

// Google colorId → theme colour
const GCAL_COLORS = {'1':'#58a8f0','2':'#46d4a0','3':'#8ccc60','4':'#38c8d8','5':'#f0a030','6':'#e058c0','7':'#7078f0','8':'#a890d8','9':'#a860e8','10':'#68d448','11':'#e0cc38'};

// ── AUTH ──────────────────────────────────────────────
let accessToken = null, tokenExpiry = 0, tokenClient = null, currentUser = '';

try {
  const s = JSON.parse(localStorage.getItem('cdx_tok') || 'null');
  if (s && s.expiry > Date.now() + 90000 && s.sv === SCOPE_VER) {
    accessToken = s.token; tokenExpiry = s.expiry; currentUser = s.user||'';
  } else if (s) {
    // Stale or wrong-scope token — wipe it so user gets prompted with new scopes
    localStorage.removeItem('cdx_tok');
  }
} catch(e){}

function saveSession(){ try{ localStorage.setItem('cdx_tok', JSON.stringify({token:accessToken,expiry:tokenExpiry,user:currentUser,sv:SCOPE_VER})); }catch(e){} }
function clearSession(){ accessToken=null;tokenExpiry=0;currentUser=''; try{localStorage.removeItem('cdx_tok');}catch(e){} }

function initGIS(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES,
    callback: async (resp) => {
      if(resp.error){ showSyncBar('Auth error: '+resp.error,'err'); return; }
      accessToken = resp.access_token;
      tokenExpiry  = Date.now() + (resp.expires_in - 60)*1000;
      await fetchUserInfo(); saveSession();
      document.getElementById('signin-overlay').classList.add('hidden');
      document.getElementById('sync-user').textContent = currentUser;
      await loadAllData();
    },
    // Use no-prompt for silent re-auth
    error_callback: ()=>{},
  });
}

// Proactive silent token renewal — called every 5 min
// Uses prompt:'none' so Google never shows any popup/redirect.
// If silent refresh fails the token naturally expires; user re-auths on next manual sync.
async function maybeRefreshToken(){
  if(!tokenClient || !accessToken) return;
  const timeLeft = tokenExpiry - Date.now();
  if(timeLeft < 10 * 60 * 1000){
    try {
      await new Promise((resolve, reject) => {
        const origCallback = tokenClient.callback;
        const origError    = tokenClient.error_callback;
        tokenClient.callback = (resp) => {
          tokenClient.callback       = origCallback;
          tokenClient.error_callback = origError;
          if(resp.error){ reject(resp.error); return; }
          accessToken = resp.access_token;
          tokenExpiry = Date.now() + (resp.expires_in - 60) * 1000;
          saveSession();
          resolve();
        };
        tokenClient.error_callback = () => {
          tokenClient.callback       = origCallback;
          tokenClient.error_callback = origError;
          reject('silent_fail');
        };
        // prompt:'none' = strict no-UI; fails silently instead of opening a popup
        tokenClient.requestAccessToken({ prompt: 'none', hint: currentUser });
      });
    } catch(e) {
      // Silent refresh failed — token will expire naturally; no popup shown
    }
  }
}

async function fetchUserInfo(){
  try{ const r=await apiFetch('https://www.googleapis.com/oauth2/v2/userinfo'); currentUser=r.email||''; }catch(e){}
}

function requestToken(){ if(!tokenClient){showSyncBar('GIS loading — try again shortly','err');return;} tokenClient.requestAccessToken({prompt:'consent'}); }

function signOut(){
  if(accessToken) try{google.accounts.oauth2.revoke(accessToken,()=>{});}catch(e){}
  clearSession(); EVENTS=[];TASKS=[];CAL_LIST=[];TASK_LISTS=[];
  renderLeft();buildTasks();updateClock();drawCosmodex();
  document.getElementById('signin-overlay').classList.remove('hidden');
  document.getElementById('sync-bar').classList.remove('visible');
}

document.getElementById('signin-btn').addEventListener('click', requestToken);
document.getElementById('signout-btn').addEventListener('click', signOut);

// ── SYNC BAR ──────────────────────────────────────────
let _st=null;
function showSyncBar(msg,state){
  document.getElementById('sync-msg').textContent=msg;
  document.getElementById('sync-dot').className='sync-dot'+(state==='ok'?' ok':state==='err'?' err':'');
  document.getElementById('sync-bar').classList.add('visible');
  clearTimeout(_st);
  if(state==='ok') _st=setTimeout(()=>document.getElementById('sync-bar').classList.remove('visible'),3500);
}

// ── API HELPER ────────────────────────────────────────
async function apiFetch(url, params, opts, silent=false){
  if(!accessToken) throw new Error('not_authenticated');
  if(Date.now()>tokenExpiry){ if(!silent) clearSession(); throw new Error('token_expired'); }
  const qs = params ? '?'+new URLSearchParams(params) : '';
  const r = await fetch(url+qs, { headers:{Authorization:'Bearer '+accessToken}, ...opts });
  if(r.status===401){ if(!silent) clearSession(); throw new Error('token_expired'); }
  if(!r.ok) throw new Error('HTTP '+r.status);
  if(r.status===204||r.headers.get('content-length')==='0') return {};
  return r.json();
}
async function apiPost(url, body){
  if(!accessToken) throw new Error('not_authenticated');
  if(Date.now()>tokenExpiry){ clearSession(); throw new Error('token_expired'); }
  const r = await fetch(url, { method:'POST', headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'}, body:JSON.stringify(body) });
  if(r.status===401){ clearSession(); throw new Error('token_expired'); }
  if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+': '+t.slice(0,120)); }
  return r.json();
}

// Silent versions for background refresh (don't clear session on 401)
async function apiFetchSilent(url, params){
  if(!accessToken||Date.now()>tokenExpiry) throw new Error('skip');
  const qs=params?'?'+new URLSearchParams(params):'';
  const r=await fetch(url+qs,{headers:{Authorization:'Bearer '+accessToken}});
  if(r.status===401||r.status===403) throw new Error('skip');
  if(!r.ok) throw new Error('HTTP '+r.status);
  if(r.status===204) return {};
  return r.json();
}
async function loadAllDataSilent(){
  // Re-use normal load but with a try/catch that never touches session
  const oldFetch = window._apiFetch;
  try {
    await fetchCalList();
    await Promise.all([fetchEvents(), fetchTasks()]);
    buildCalTabs(); buildTaskTabs();
    renderLeft(); buildTasks(); updateClock(); drawCosmodex();
    const t=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    showSyncBar('Synced · '+t,'ok');
  } catch(e) {
    if(e.message!=='skip'&&e.message!=='token_expired'&&e.message!=='not_authenticated'){
      showSyncBar('⚠ '+e.message,'err');
    }
    // Never log out during background refresh
  }
}

// ── FETCH CALENDAR LIST ───────────────────────────────
async function fetchCalList(){
  const res = await apiFetch(CAL_API+'/users/me/calendarList');
  const palette = ['#58a8f0','#46d4a0','#a860e8','#38c8d8','#f0a030','#8ccc60','#e058c0','#7078f0'];
  CAL_LIST = (res.items||[]).filter(c=>c.selected!==false).map((c,i)=>({
    id:       c.id,
    name:     c.summary||'Calendar',
    color:    palette[i%palette.length],
    isPrimary: c.primary === true,
  }));
}

function evColor(gcalEv, calId){
  if(gcalEv.colorId) return GCAL_COLORS[gcalEv.colorId]||'#c9a84c';
  const cal = CAL_LIST.find(c=>c.id===calId);
  return cal ? cal.color : '#58a8f0';
}

// ── FETCH EVENTS ──────────────────────────────────────
async function fetchEvents(){
  const now=new Date();
  // Start from beginning of current month so month view always has full data
  const tMin=new Date(now.getFullYear(), now.getMonth(), 1);
  const tMax=new Date(now); tMax.setDate(now.getDate()+90);  // 90 days ahead for holidays
  const all=[];
  await Promise.all(CAL_LIST.map(async cal=>{
    try{
      const resp=await apiFetch(CAL_API+'/calendars/'+encodeURIComponent(cal.id)+'/events',{
        timeMin:tMin.toISOString(), timeMax:tMax.toISOString(),
        singleEvents:'true', orderBy:'startTime', maxResults:'500',
        fields:'items(id,summary,start,end,colorId,status)',
      });
      (resp.items||[]).forEach(ev=>{
        if(ev.status==='cancelled') return;
        const startISO=ev.start.date&&!ev.start.dateTime ? ev.start.date : dtToLocal(ev.start.dateTime||ev.start.date+'T00:00:00');
        const endISO  =ev.end.date&&!ev.end.dateTime ? ev.end.date : dtToLocal(ev.end.dateTime||ev.end.date+'T00:00:00');
        all.push({ title:(ev.summary||'(No title)').replace(/</g,'&lt;'), startISO, endISO, color:evColor(ev,cal.id), calId:cal.id, calName:cal.name, evId:ev.id });
      });
    }catch(e){}
  }));
  all.sort((a,b)=>a.startISO.localeCompare(b.startISO));
  EVENTS=all;
}

// ── FETCH TASKS ───────────────────────────────────────
async function fetchTasks(){
  const res=await apiFetch(TASKS_API+'/users/@me/lists',{maxResults:'20'});
  TASK_LISTS=(res.items||[]).map(t=>({id:t.id,title:t.title||'Tasks'}));
  const today=localDate();
  const all=[];
  await Promise.all(TASK_LISTS.map(async tl=>{
    try{
      const r=await apiFetch(TASKS_API+'/lists/'+tl.id+'/tasks',{showCompleted:'false',showHidden:'true',maxResults:'100',fields:'items(id,title,due,status,parent)'});
      (r.items||[]).forEach(t=>{
        if(!t.title||!t.title.trim()) return;
        const due=t.due?t.due.slice(0,10):null;
        const d=due?(new Date(due)-new Date(today))/86400000:null;
        const priority=d===null?'low':d<=0?'high':d<=2?'high':d<=7?'med':'low';
        all.push({title:t.title.replace(/</g,'&lt;'),due,done:false,priority,_id:t.id,_list:tl.id,_listName:tl.title,_parent:t.parent||null});
      });
    }catch(e){}
  }));
  all.sort((a,b)=>{if(!a.due&&!b.due)return 0;if(!a.due)return 1;if(!b.due)return -1;return a.due.localeCompare(b.due);});
  TASKS=all;
}

// ── LOAD ALL ──────────────────────────────────────────
async function loadAllData(){
  showSyncBar('Syncing\u2026','syncing');
  try{
    await fetchCalList();
    await Promise.all([fetchEvents(),fetchTasks()]);
    buildCalTabs(); buildTaskTabs();
    renderLeft(); buildTasks(); updateClock(); drawCosmodex();
    const t=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    showSyncBar('Synced \u00b7 '+t,'ok');
  }catch(err){
    if(err.message==='token_expired'||err.message==='not_authenticated'){
      clearSession(); document.getElementById('signin-overlay').classList.remove('hidden');
      document.getElementById('sync-bar').classList.remove('visible'); return;
    }
    showSyncBar('\u26a0 '+err.message,'err');
    renderLeft(); buildTasks(); updateClock(); drawCosmodex();
  }
}

// ── TABS ──────────────────────────────────────────────
function buildCalTabs(){
  const bar=document.getElementById('cal-tab-bar');
  bar.style.display='flex';
  bar.style.cssText='display:flex;align-items:center;padding:3px 8px;border-bottom:2px solid var(--border);flex-shrink:0;gap:6px;';
  bar.innerHTML='';
  const isFiltered=activeCalTab!=='all';
  // "All" button — dimmed when a calendar is selected
  const allBtn=document.createElement('button');
  allBtn.style.cssText='font-family:"JetBrains Mono",monospace;font-size:11px;letter-spacing:0.10em;text-transform:uppercase;'+
    'background:none;border:1.5px solid '+(isFiltered?'var(--border)':'var(--gold)')+';border-radius:4px;'+
    'color:'+(isFiltered?'var(--ink-faint)':'var(--gold)')+';cursor:pointer;padding:3px 8px;min-height:28px;';
  allBtn.textContent='All';
  allBtn.onclick=()=>{activeCalTab='all';buildCalTabs();renderLeft();};
  bar.appendChild(allBtn);
  // Dropdown with colored dot indicator
  const wrap=document.createElement('div');
  wrap.style.cssText='position:relative;display:flex;align-items:center;flex:1;';
  const selCal=CAL_LIST.find(c=>c.id===activeCalTab);
  const sel=document.createElement('select');
  sel.style.cssText='appearance:none;-webkit-appearance:none;width:100%;'+
    'background:none;border:1.5px solid '+(isFiltered?selCal?.color||'var(--blue)':'var(--border)')+';border-radius:4px;'+
    'font-family:"JetBrains Mono",monospace;font-size:11px;'+
    'color:'+(isFiltered?'var(--ink)':'var(--ink-faint)')+';cursor:pointer;'+
    'padding:3px 24px 3px 8px;outline:none;min-height:28px;';
  const ph=document.createElement('option');ph.value='';
  ph.textContent=isFiltered?(selCal?.name||'Calendar'):'Calendar ▾';
  ph.disabled=true; ph.selected=!isFiltered;
  sel.appendChild(ph);
  CAL_LIST.forEach(cal=>{
    const o=document.createElement('option');o.value=cal.id;o.textContent=cal.name;
    if(activeCalTab===cal.id) o.selected=true;
    sel.appendChild(o);
  });
  sel.onchange=e=>{if(e.target.value){activeCalTab=e.target.value;buildCalTabs();renderLeft();}};
  // Color dot on right of dropdown
  const dot=document.createElement('span');
  dot.style.cssText='position:absolute;right:8px;top:50%;transform:translateY(-50%);width:7px;height:7px;border-radius:50%;pointer-events:none;flex-shrink:0;';
  dot.style.background=isFiltered?(selCal?.color||'var(--blue)'):'var(--border)';
  wrap.appendChild(sel);wrap.appendChild(dot);
  bar.appendChild(wrap);
}

function buildTaskTabs(){
  const bar=document.getElementById('task-tab-bar');
  bar.style.display='flex';
  bar.style.cssText='display:flex;align-items:center;padding:3px 8px;border-bottom:2px solid var(--border);flex-shrink:0;gap:6px;';
  bar.innerHTML='';
  const isFiltered=activeTaskTab!=='all';
  const allBtn=document.createElement('button');
  allBtn.style.cssText='font-family:"JetBrains Mono",monospace;font-size:11px;letter-spacing:0.10em;text-transform:uppercase;'+
    'background:none;border:1.5px solid '+(isFiltered?'var(--border)':'var(--gold)')+';border-radius:4px;'+
    'color:'+(isFiltered?'var(--ink-faint)':'var(--gold)')+';cursor:pointer;padding:3px 8px;min-height:28px;';
  allBtn.textContent='All';
  allBtn.onclick=()=>{activeTaskTab='all';buildTaskTabs();buildTasks();};
  bar.appendChild(allBtn);
  const wrap=document.createElement('div');
  wrap.style.cssText='position:relative;display:flex;align-items:center;flex:1;';
  const selList=TASK_LISTS.find(l=>l.id===activeTaskTab);
  const sel=document.createElement('select');
  sel.style.cssText='appearance:none;-webkit-appearance:none;width:100%;'+
    'background:none;border:1.5px solid '+(isFiltered?'var(--blue)':'var(--border)')+';border-radius:4px;'+
    'font-family:"JetBrains Mono",monospace;font-size:11px;'+
    'color:'+(isFiltered?'var(--ink)':'var(--ink-faint)')+';cursor:pointer;'+
    'padding:3px 24px 3px 8px;outline:none;min-height:28px;';
  const ph=document.createElement('option');ph.value='';
  ph.textContent=isFiltered?(selList?.title||'List'):'List ▾';
  ph.disabled=true; ph.selected=!isFiltered;
  sel.appendChild(ph);
  TASK_LISTS.forEach(tl=>{
    const o=document.createElement('option');o.value=tl.id;o.textContent=tl.title;
    if(activeTaskTab===tl.id) o.selected=true;
    sel.appendChild(o);
  });
  sel.onchange=e=>{if(e.target.value){activeTaskTab=e.target.value;buildTaskTabs();buildTasks();}};
  wrap.appendChild(sel);
  bar.appendChild(wrap);
}

function filteredEvents(){
  return activeCalTab==='all' ? EVENTS : EVENTS.filter(e=>e.calId===activeCalTab);
}

function filteredTasks(){
  return activeTaskTab==='all' ? TASKS : TASKS.filter(t=>t._list===activeTaskTab);
}

// ── THEME ─────────────────────────────────────────────
let isDark=true;
document.getElementById('theme-btn').addEventListener('click',()=>{
  isDark=!isDark;
  document.documentElement.setAttribute('data-theme',isDark?'dark':'light');
  document.getElementById('theme-btn').textContent=isDark?'☀':'☾';
  drawCosmodex(); drawPomoRing();
});

// ── VIEW STATE ────────────────────────────────────────
let currentView='day',dayOff=0,weekOff=0,monthOff=0;
document.querySelectorAll('.view-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); currentView=btn.dataset.view; dayOff=weekOff=monthOff=0; renderLeft();
  });
});
function renderLeft(){
  ({day:buildDay,week:buildWeek,month:buildMonth})[currentView]();
}

// ── DAY VIEW ──────────────────────────────────────────
function buildDay(){
  const now=new Date(),d=new Date(now); d.setDate(now.getDate()+dayOff);
  const ds=localDate(d),isToday=ds===localDate(now);
  const DN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const MN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const evts=filteredEvents().filter(e=>e.startISO.startsWith(ds));
  const nowH=now.getHours(), nowM=now.getMinutes();
  document.getElementById('left-content').innerHTML=
    '<div class="daily-view">'+
    '<div class="daily-top">'+
    '<button class="nav-arrow" id="d-prev">&#8249;</button>'+
    '<div style="text-align:center"><div class="daily-title-num">'+d.getDate()+'</div>'+
    '<div class="daily-title-sub">'+DN[d.getDay()].toUpperCase()+' &middot; '+MN[d.getMonth()].toUpperCase()+' '+d.getFullYear()+'</div></div>'+
    '<button class="nav-arrow" id="d-next">&#8250;</button>'+
    '</div>'+
    '<div class="daily-timeline" id="d-tl"></div>'+
    '</div>';
  document.getElementById('d-prev').onclick=()=>{dayOff--;buildDay();};
  document.getElementById('d-next').onclick=()=>{dayOff++;buildDay();};
  const tl=document.getElementById('d-tl');

  // Full 24 hours
  for(let hr=0;hr<24;hr++){
    const isNow=isToday&&hr===nowH;
    const isPast=isToday&&hr<nowH;
    const row=document.createElement('div');
    row.className='hour-row'+(isNow?' hour-now':'')+(isPast?' hour-past':'');
    row.dataset.hour=hr;
    // Drop-zone for tasks
    row.addEventListener('dragover',e=>{e.preventDefault();row.classList.add('drag-over');});
    row.addEventListener('dragleave',()=>row.classList.remove('drag-over'));
    row.addEventListener('drop',e=>{
      e.preventDefault(); row.classList.remove('drag-over');
      const data=JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
      if(data.taskTitle) openTaskToEventModal(data.taskTitle,data.taskId,data.listId,ds,hr);
    });
    row.addEventListener('click',e=>{
      if(e.target.closest('.hour-event')) return;
      openAddEvent(ds, hr);
    });

    const lbl=document.createElement('div');
    lbl.className='hour-label'+(isNow?' now-lbl':'');
    lbl.textContent=String(hr).padStart(2,'0')+':00';

    const evDiv=document.createElement('div'); evDiv.className='hour-events';

    // Current time indicator line
    if(isNow){
      const pct=(nowM/60)*100;
      const line=document.createElement('div');
      line.style.cssText='position:absolute;left:0;right:0;top:'+pct+'%;height:2px;background:var(--red);opacity:0.7;pointer-events:none;z-index:2;';
      evDiv.style.position='relative';
      evDiv.appendChild(line);
    }

    evts.filter(e=>new Date(e.startISO).getHours()===hr).forEach(ev=>{
      const dur=Math.round((new Date(ev.endISO)-new Date(ev.startISO))/60000);
      const startM=new Date(ev.startISO).getMinutes();
      const el=document.createElement('div'); el.className='hour-event';
      const topPct=(startM/60)*100;
      const heightPct=Math.max(8,(dur/60)*100);
      el.style.cssText='border-color:'+ev.color+';background:'+ev.color+'28;position:relative;margin-top:'+Math.round(startM/60*40)+'px;';
      const tStr=String(new Date(ev.startISO).getHours()).padStart(2,'0')+':'+String(startM).padStart(2,'0');
      el.innerHTML='<span style="font-size:11px;font-family:JetBrains Mono,monospace;color:var(--ink-dim)">'+tStr+'</span> '+ev.title+(dur>0?' <span style="color:var(--ink-dim);font-size:12px">'+dur+'m</span>':'')+'<button class="ev-del-btn" title="Delete event">✕</button>';
      el.querySelector('.ev-del-btn').addEventListener('click',e=>{e.stopPropagation();deleteEvent(ev);});
      el.addEventListener('click',()=>openPomo(ev)); evDiv.appendChild(el);
    });

    row.appendChild(lbl); row.appendChild(evDiv); tl.appendChild(row);
  }

  // Scroll to current hour (or 8am if not today) — use scrollTop for reliable cross-browser behaviour
  const scrollTo=isToday?Math.max(0,Math.min(nowH-1,22)):8;
  requestAnimationFrame(()=>requestAnimationFrame(()=>{ tl.scrollTop = scrollTo * 44; }));
}

// Create a calendar event from a dragged task
function openTaskToEventModal(title, taskId, listId, dateStr, hour){
  document.getElementById('t2e-title').value = title;
  document.getElementById('t2e-date').value  = dateStr;
  document.getElementById('t2e-start').value = String(hour).padStart(2,'0')+':00';
  document.getElementById('t2e-dur').value   = '30';
  const sel = document.getElementById('t2e-cal'); sel.innerHTML='';
  CAL_LIST.forEach(cal=>{
    const o=document.createElement('option'); o.value=cal.id; o.textContent=cal.name;
    if(cal.isPrimary) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('modal-task2event').classList.add('open');
  setTimeout(()=>document.getElementById('t2e-start').focus(),50);
}
document.getElementById('modal-t2e-close').addEventListener('click',()=>document.getElementById('modal-task2event').classList.remove('open'));
document.getElementById('t2e-cancel').addEventListener('click',()=>document.getElementById('modal-task2event').classList.remove('open'));
document.getElementById('t2e-save').addEventListener('click',async()=>{
  const title=document.getElementById('t2e-title').value.trim();
  const date =document.getElementById('t2e-date').value;
  const start=document.getElementById('t2e-start').value;
  const dur  =parseInt(document.getElementById('t2e-dur').value)||60;
  const calId=document.getElementById('t2e-cal').value;
  if(!title||!date||!start) return;
  const startDT=new Date(date+'T'+start);
  const endDT  =new Date(startDT.getTime()+dur*60000);
  document.getElementById('t2e-saving').style.display='';
  document.getElementById('t2e-save').disabled=true;
  try{
    await apiPost(CAL_API+'/calendars/'+encodeURIComponent(calId)+'/events',{
      summary:title,
      start:{dateTime:startDT.toISOString()},
      end:{dateTime:endDT.toISOString()},
    });
    document.getElementById('modal-task2event').classList.remove('open');
    showSyncBar('Added to calendar ✓','ok');
    await loadAllData();
  }catch(err){ showSyncBar('⚠ '+err.message,'err'); }
  finally{
    document.getElementById('t2e-saving').style.display='none';
    document.getElementById('t2e-save').disabled=false;
  }
});

async function createEventFromTask(title, taskId, listId, dateStr, hour){
  if(!accessToken){showSyncBar('Sign in to add events','err');return;}
  const calId = CAL_LIST.find(c=>c.isPrimary)?.id || CAL_LIST[0]?.id;
  if(!calId){showSyncBar('No calendar found','err');return;}
  const start=new Date(dateStr+'T'+String(hour).padStart(2,'0')+':00:00');
  const end  =new Date(start.getTime()+60*60000); // 1 hour default
  try{
    await apiPost(CAL_API+'/calendars/'+encodeURIComponent(calId)+'/events',{
      summary: title,
      start:{dateTime: start.toISOString()},
      end:  {dateTime: end.toISOString()},
    });
    showSyncBar('Added "'+title+'" to calendar','ok');
    await loadAllData();
  }catch(err){showSyncBar('Failed: '+err.message,'err');}
}

// ── WEEK VIEW ─────────────────────────────────────────
function buildWeek(){
  const now=new Date(),base=new Date(now); base.setDate(now.getDate()+weekOff*7);
  const dow=base.getDay(),mon=new Date(base); mon.setDate(base.getDate()-((dow+6)%7));
  const sun=new Date(mon); sun.setDate(mon.getDate()+6);
  const M=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmt=d=>d.getDate()+' '+M[d.getMonth()];
  const DN=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],todayStr=localDate(now);
  document.getElementById('left-content').innerHTML=
    '<div class="week-view"><div class="week-nav">'+
    '<button class="nav-arrow" id="w-prev">&#8249;</button>'+
    '<span class="week-range">'+fmt(mon)+' \u2013 '+fmt(sun)+'</span>'+
    '<button class="nav-arrow" id="w-next">&#8250;</button></div>'+
    '<div class="week-grid" id="w-grid"></div></div>';
  document.getElementById('w-prev').onclick=()=>{weekOff--;buildWeek();};
  document.getElementById('w-next').onclick=()=>{weekOff++;buildWeek();};
  const grid=document.getElementById('w-grid');
  for(let i=0;i<7;i++){
    const d=new Date(mon); d.setDate(mon.getDate()+i);
    const ds=localDate(d),isToday=ds===todayStr;
    const dayEvts=filteredEvents().filter(e=>e.startISO.startsWith(ds)).sort((a,b)=>a.startISO.localeCompare(b.startISO));
    const row=document.createElement('div'); row.className='week-day'+(isToday?' today':'');
    row.innerHTML='<div class="day-label" style="cursor:pointer" title="Open day view"><span class="day-name">'+DN[i]+'</span><span class="day-num">'+d.getDate()+'</span></div><div class="day-events" id="de'+i+'"></div>';
    grid.appendChild(row);
    // Click day label -> jump to that day in day view
    row.querySelector('.day-label').addEventListener('click',()=>{
      currentView='day';
      dayOff=Math.round((d-new Date(new Date().toDateString()))/86400000);
      document.querySelectorAll('.view-btn').forEach(b=>b.classList.toggle('active',b.dataset.view==='day'));
      renderLeft();
    });
    const evDiv=row.querySelector('#de'+i);
    if(!dayEvts.length){evDiv.innerHTML='<span style="font-size:14px;color:var(--ink-faint);font-style:italic">clear</span>';}
    dayEvts.slice(0,3).forEach(e=>{
      const t=new Date(e.startISO).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
      const el=document.createElement('div'); el.className='cal-event';
      el.innerHTML='<span class="cal-event-dot" style="background:'+e.color+'"></span><span class="cal-event-time">'+t+'</span><span style="overflow:hidden;text-overflow:ellipsis">'+e.title+'</span>';
      evDiv.appendChild(el);
    });
    if(dayEvts.length>3){const m=document.createElement('div');m.style.cssText='font-family:JetBrains Mono,monospace;font-size:12px;color:var(--ink-dim);padding-left:13px;';m.textContent='+'+(dayEvts.length-3)+' more';evDiv.appendChild(m);}
  }
}

// ── MONTH VIEW ────────────────────────────────────────
function buildMonth(){
  const now=new Date(), ref=new Date(now.getFullYear(),now.getMonth()+monthOff,1);
  const MN=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const SN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dim=new Date(ref.getFullYear(),ref.getMonth()+1,0).getDate();
  const todayStr=localDate(now);
  const yr=ref.getFullYear(), mo=ref.getMonth();

  // Month events: holidays from ALL cals, regular events respect tab filter
  const monthStart=yr+'-'+String(mo+1).padStart(2,'0')+'-01';
  const monthEnd  =yr+'-'+String(mo+1).padStart(2,'0')+'-'+String(dim).padStart(2,'0');
  const allMonthEvts=EVENTS.filter(e=>e.startISO>=monthStart&&e.startISO<=monthEnd+'T99');
  const filtMonthEvts=filteredEvents().filter(e=>e.startISO>=monthStart&&e.startISO<=monthEnd+'T99');
  const monthEvts=allMonthEvts;  // used for holiday detection only

  // Identify holiday calendars (not the primary gmail)
  const isHolidayCal=cal=>!cal.isPrimary&&(cal.name.toLowerCase().includes('holiday')||cal.name.toLowerCase().includes('observance')||cal.name.toLowerCase().includes('region'));
  const holidayCalIds=new Set(CAL_LIST.filter(isHolidayCal).map(c=>c.id));

  // Split: holidays from all cals, regular events respect filter
  const holidays=allMonthEvts.filter(e=>holidayCalIds.has(e.calId)||e.startISO.length===10);
  const regular =filtMonthEvts.filter(e=>!holidayCalIds.has(e.calId)&&e.startISO.length>10);

  // Build sparse week grid (5 rows x 7 cols) + event counts per day
  const evByDay={};
  regular.forEach(e=>{const d=e.startISO.slice(0,10);evByDay[d]=(evByDay[d]||[]);evByDay[d].push(e);});
  const holByDay={};
  holidays.forEach(e=>{const d=e.startISO.slice(0,10);holByDay[d]=(holByDay[d]||[]);holByDay[d].push(e);});

  let fd=ref.getDay(); fd=fd===0?6:fd-1; // Mon=0

  // Build HTML
  let html='<div class="month-view" style="display:flex;flex-direction:column;height:100%;overflow:hidden;">';
  // Nav
  html+='<div class="month-nav"><button class="nav-arrow" id="m-prev">&#8249;</button>';
  html+='<span class="month-title">'+MN[mo]+' '+yr+'</span>';
  html+='<button class="nav-arrow" id="m-next">&#8250;</button></div>';
  // Mini calendar grid
  html+='<div style="padding:4px 8px 0">';
  html+='<div class="month-dow-row">'+ ['M','T','W','T','F','S','S'].map((x,xi)=>'<div class="month-dow"'+(xi>=5?' style="color:var(--red);border-left:'+(xi===5?'2px solid rgba(196,75,58,0.35)':'none')+'"':'')+'>'+ x+'</div>').join('')+'</div>';
  html+='<div class="month-grid" id="m-grid" style="flex:none;height:auto"></div>';
  html+='</div>';
  // Holiday list
  html+='<div style="font-family:JetBrains Mono,monospace;font-size:11px;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold-dim);padding:8px 12px 2px">Highlights</div>';
  html+='<div id="month-highlights" style="flex:1;overflow-y:auto;scrollbar-width:none;padding:0 10px 8px"></div>';
  html+='</div>';
  document.getElementById('left-content').innerHTML=html;

  document.getElementById('m-prev').onclick=()=>{monthOff--;buildMonth();};
  document.getElementById('m-next').onclick=()=>{monthOff++;buildMonth();};

  // Fill mini grid
  const grid=document.getElementById('m-grid');
  // Blank leading days
  for(let i=fd-1;i>=0;i--){
    const c=document.createElement('div');c.className='month-cell other-month';
    const prevDay=new Date(yr,mo,0-i); c.innerHTML='<div class="month-day-num">'+prevDay.getDate()+'</div>';
    grid.appendChild(c);
  }
  for(let d=1;d<=dim;d++){
    const ds=yr+'-'+String(mo+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const isToday=ds===todayStr;
    const hasHol=holByDay[ds]&&holByDay[ds].length>0;
    const evs=evByDay[ds]||[];
    const dayOfWeek=new Date(yr,mo,d).getDay();
    const isWeekend=(dayOfWeek===0||dayOfWeek===6);
    const c=document.createElement('div');
    c.className='month-cell'+(isToday?' today':'')+(dayOfWeek===6?' weekend-start':'');
    if(hasHol) c.style.background='rgba(196,75,58,0.13)';
    else if(isWeekend) c.style.background='rgba(196,75,58,0.04)';
    const numCol=hasHol?'var(--red)':isWeekend?'rgba(210,80,60,0.80)':isToday?'var(--gold)':'';
    let inner='<div class="month-day-num" style="'+(numCol?'color:'+numCol:'')+'">'+(hasHol?'★ ':'')+d+'</div>';
    inner+='<div class="month-dots">'+evs.slice(0,4).map(e=>'<div class="month-dot" style="background:'+e.color+'"></div>').join('')+'</div>';
    c.innerHTML=inner;
    // Click: jump to day view
    c.style.cursor='pointer';
    c.addEventListener('click',()=>{
      currentView='day'; dayOff=d-now.getDate()+(mo-now.getMonth())*31;
      // More accurate:
      dayOff=Math.round((new Date(yr,mo,d)-new Date(now.toDateString()))/86400000);
      document.querySelectorAll('.view-btn').forEach(b=>b.classList.toggle('active',b.dataset.view==='day'));
      renderLeft();
    });
    grid.appendChild(c);
  }
  const total=fd+dim,rem=total%7===0?0:7-(total%7);
  for(let d=1;d<=rem;d++){const c=document.createElement('div');c.className='month-cell other-month';c.innerHTML='<div class="month-day-num">'+d+'</div>';grid.appendChild(c);}

  // Highlights panel: holidays + busy days
  const hl=document.getElementById('month-highlights');
  // Collect notable days sorted by date
  const notable=[];
  for(let d=1;d<=dim;d++){
    const ds=yr+'-'+String(mo+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const hols=holByDay[ds]||[],evs=evByDay[ds]||[];
    if(hols.length||evs.length>=2){
      const dow=new Date(yr,mo,d).toLocaleDateString('en-US',{weekday:'short'});
      notable.push({d,ds,dow,hols,evs});
    }
  }
  if(!notable.length){
    hl.innerHTML='<div style="color:var(--ink-faint);font-size:13px;padding:8px 2px">Clear month</div>';
  } else {
    notable.forEach(n=>{
      const isToday=n.ds===todayStr;
      const row=document.createElement('div');
      row.style.cssText='padding:5px 4px;border-bottom:1px solid var(--ink-faint);cursor:pointer;';
      if(isToday) row.style.background='rgba(61,184,255,0.06)';
      let inner='<div style="display:flex;align-items:baseline;gap:6px;margin-bottom:2px">';
      const _isWknd=(new Date(n.ds).getDay()===0||new Date(n.ds).getDay()===6);
      inner+='<span style="font-family:JetBrains Mono,monospace;font-size:10px;letter-spacing:0.10em;color:'+(isToday?'var(--gold)':_isWknd||n.hols.length?'var(--amber)':'var(--ink-dim)')+'">'+n.dow.toUpperCase()+' '+String(n.d).padStart(2,'0')+'</span>';
      n.hols.forEach(e=>{ inner+='<span style="font-size:12px;color:var(--gold);letter-spacing:0.05em">★ '+e.title.replace(/&lt;/g,String.fromCharCode(60))+'</span>'; });
      inner+='</div>';
      n.evs.slice(0,3).forEach(e=>{
        const t=e.startISO.slice(11,16);
        inner+='<div style="display:flex;align-items:center;gap:5px;padding:1px 0">';
        inner+='<span style="width:6px;height:6px;border-radius:50%;background:'+e.color+';flex-shrink:0;display:inline-block"></span>';
        inner+='<span style="font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+e.title.replace(/&lt;/g,'<')+'</span>';
        inner+='<span style="font-family:JetBrains Mono,monospace;font-size:10px;color:var(--ink-dim);margin-left:auto;flex-shrink:0">'+t+'</span>';
        inner+='</div>';
      });
      if(n.evs.length>3) inner+='<div style="font-size:11px;color:var(--ink-dim);margin-top:1px">+' +(n.evs.length-3)+' more</div>';
      row.innerHTML=inner;
      row.addEventListener('click',()=>{
        currentView='day';
        dayOff=Math.round((new Date(n.ds)-new Date(new Date().toDateString()))/86400000);
        document.querySelectorAll('.view-btn').forEach(b=>b.classList.toggle('active',b.dataset.view==='day'));
        renderLeft();
      });
      hl.appendChild(row);
    });
  }
}

// ── COSMODEX ─────────────────────────────────────────
// Petal layout: 5am-midnight, 19 petals, growing outward.
// - Empty petals: thin border outline only (no fill)
// - Elapsed time: thick radial arc LINE per petal, not fill
// - Events: solid color fill in their exact petal fraction
// - Labels: outside petals, rotated so text goes petal->outward
// - Crisp: canvas scaled by devicePixelRatio

const H_START  = 5;
const H_END    = 24;
const CHOURS   = H_END - H_START;   // 19
const PETAL_DEG = 360 / CHOURS;
const PETAL_RAD = PETAL_DEG * Math.PI / 180;
const RI_BASE  = 30;
const RO_MIN   = 56;
const RO_MAX   = 195;  // slightly smaller to leave room for labels

function petalRI()  { return RI_BASE * _cosScale; }
function petalRO(i) { return (RO_MIN + i * (RO_MAX - RO_MIN) / (CHOURS - 1)) * _cosScale; }
function hourAngle(i, frac) { return -Math.PI/2 + (i + frac) * PETAL_RAD; }
function petalMid(i) { return hourAngle(i, 0.5); }

let _cosScale = 1, _cdxLW = 760, _cdxLH = 500;
let todayEventsForPicker = [];

function initHiDPI(cv) {
  const dpr = window.devicePixelRatio || 1;
  const rect = cv.getBoundingClientRect();
  const logW = cv.width, logH = cv.height;
  cv.width  = logW * dpr;
  cv.height = logH * dpr;
  cv.style.width  = logW + 'px';
  cv.style.height = logH + 'px';
  const ctx = cv.getContext('2d');
  ctx.scale(dpr, dpr);
  return { ctx, W:logW, H:logH, dpr };
}

function drawCosmodex() {
  const cv = document.getElementById('cosmodex-canvas');
  const dpr = window.devicePixelRatio || 1;
  // Only re-init if needed (size changed or first draw)
  const container = cv.parentElement;
  const panel = document.getElementById('panel-chrono');
  const panelH = panel ? panel.clientHeight : 900;
  const availH = Math.max(panelH - 300, 180); // subtract header + time display + next strip + padding + gaps
  const maxLwByH = Math.round(availH * 760 / 500);
  const rawLw = Math.max(container.clientWidth || 760, 120);
  const lw = Math.min(rawLw, maxLwByH);
  const lh = Math.round(lw * 500 / 760);
  if (cv._lastLW !== lw || cv._lastDPR !== dpr) {
    cv.width  = lw * dpr;
    cv.height = lh * dpr;
    cv.style.width  = lw + 'px';
    cv.style.height = lh + 'px';
    cv._lastLW = lw; cv._lastDPR = dpr;
  }
  _cdxLW = lw; _cdxLH = lh; _cosScale = lw / 760;
  const ctx = cv.getContext('2d');
  const LW = lw, LH = lh, sc = _cosScale;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, LW, LH);
  ctx.shadowBlur = 0; ctx.shadowColor = 'transparent'; // reset — prevents Safari shadow halo
  todayEventsForPicker = [];

  const dark    = isDark;
  const needleC = dark ? '#e05555' : '#c42b2b';
  const hubC    = dark ? '#3db8ff' : '#0b62c4';
  const borderC = dark ? 'rgba(61,184,255,0.55)'  : 'rgba(11,98,196,0.82)';
  const tickC   = dark ? 'rgba(61,184,255,0.45)'  : 'rgba(11,98,196,0.65)';
  const elapsedC= dark ? 'rgba(61,184,255,0.65)'  : 'rgba(11,98,196,0.55)';
  const lblC    = dark ? '#d8eeff' : '#111c2d';
  const cx = LW*0.50, cy = LH/2;  // centred for equal label room on both sides
  const GAP = 0.020;
  const accentC   = dark ? '#3db8ff' : '#0b62c4';
  const emptyFill = dark ? 'rgba(61,184,255,0.04)' : 'rgba(11,98,196,0.05)';

  const now   = new Date();
  const tm    = now.getHours()*60 + now.getMinutes();
  const today = localDate(now);
  const te    = EVENTS.filter(e => e.startISO.startsWith(today));
  todayEventsForPicker = te;

  // ── 1. Petal outlines only (no fill for empty petals) ──
  for (let i = 0; i < CHOURS; i++) {
    const ri = petalRI(), ro = petalRO(i);
    const a0 = hourAngle(i, 0), a1 = hourAngle(i, 1);
    ctx.beginPath();
    ctx.arc(cx, cy, ro, a0 + GAP, a1 - GAP);
    ctx.arc(cx, cy, ri, a1 - GAP, a0 + GAP, true);
    ctx.closePath();
    ctx.fillStyle = emptyFill;
    ctx.fill();
    ctx.strokeStyle = borderC;
    ctx.lineWidth = 1.5;
    ctx.stroke();

    // 30-min tick (small radial line inside petal near inner edge)
    const amid = hourAngle(i, 0.5);
    const t0 = ri + 3*sc, t1 = ri + 3*sc + Math.min(8*sc, (ro - ri) * 0.18);
    ctx.beginPath();
    ctx.moveTo(cx + t0 * Math.cos(amid), cy + t0 * Math.sin(amid));
    ctx.lineTo(cx + t1 * Math.cos(amid), cy + t1 * Math.sin(amid));
    ctx.strokeStyle = tickC;
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // ── 1b. Rest tints: alternating green+orange on empty petals (5–8am and 8pm–midnight) ──
  function drawRestTints(startI, endI, offset){
    for(let i = startI; i < endI; i++){
      const hMin = (H_START+i)*60, hMax = (H_START+i+1)*60;
      const hasEv = te.some(ev=>{
        const sm=new Date(ev.startISO).getHours()*60+new Date(ev.startISO).getMinutes();
        const em=new Date(ev.endISO).getHours()*60+new Date(ev.endISO).getMinutes();
        return sm<hMax && em>hMin;
      });
      if(hasEv) continue;
      const ri=petalRI(), ro=petalRO(i);
      const a0=hourAngle(i,0), a1=hourAngle(i,1);
      const col=(i-offset)%2===0?'#46d4a0':'#f0a030';
      ctx.save();
      ctx.globalAlpha=0.06;
      ctx.beginPath();
      ctx.arc(cx,cy,ro,a0+GAP,a1-GAP);
      ctx.arc(cx,cy,ri,a1-GAP,a0+GAP,true);
      ctx.closePath();
      ctx.fillStyle=col;
      ctx.fill();
      ctx.restore();
    }
  }
  // Morning: 5am–8am (petals 0–2)
  drawRestTints(0, 8 - H_START, 0);
  // Evening: 8pm–midnight (petals 15–18)
  drawRestTints(20 - H_START, CHOURS, 0);

  // ── 2. Elapsed time fill — subtle glow on past petals ──
  for(let i=0;i<CHOURS;i++){
    const hAbs=H_START+i;
    const hMin=hAbs*60, hMax=(hAbs+1)*60;
    if(tm<=hMin) break; // all remaining petals are future
    const frac=Math.min(1,(tm-hMin)/60);
    const ri=petalRI()+1*_cosScale, ro=petalRO(i)-1*_cosScale;
    const a0=hourAngle(i,0), a1=hourAngle(i,frac);
    ctx.save();
    ctx.globalAlpha=0.14;
    ctx.beginPath();
    ctx.arc(cx,cy,ro,a0+GAP*0.5,a1-GAP*0.5);
    ctx.arc(cx,cy,ri,a1-GAP*0.5,a0+GAP*0.5,true);
    ctx.closePath();
    ctx.fillStyle=accentC;
    ctx.fill();
    ctx.restore();
  }

  // ── 3. Event fills ──
  te.forEach(ev => {
    const sm = new Date(ev.startISO).getHours() * 60 + new Date(ev.startISO).getMinutes();
    const em = new Date(ev.endISO).getHours()   * 60 + new Date(ev.endISO).getMinutes();
    if (em <= H_START * 60 || sm >= H_END * 60) return;
    const isPast    = em <= tm;
    const isCurrent = sm <= tm && em > tm;
    const pinkC  = dark ? '#ff82b4' : '#d05080';
    const fillC  = isPast ? pinkC : accentC;
    const alpha  = isPast ? 0.22 : isCurrent ? 0.82 : 0.52;
    const sAlpha = isPast ? 0.18 : isCurrent ? 0.88 : 0.68;

    for (let i = 0; i < CHOURS; i++) {
      const hAbs = H_START + i;
      const hMin = hAbs * 60, hMax = (hAbs + 1) * 60;
      const os = Math.max(sm, hMin), oe = Math.min(em, hMax);
      if (oe <= os) continue;
      const f0 = (os - hMin) / 60, f1 = (oe - hMin) / 60;
      const ri = petalRI() + 2*sc, ro = petalRO(i) - 2*sc;
      const a0 = hourAngle(i, f0), a1 = hourAngle(i, f1);
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.beginPath();
      ctx.arc(cx, cy, ro, a0 + GAP * 0.4, a1 - GAP * 0.4);
      ctx.arc(cx, cy, ri, a1 - GAP * 0.4, a0 + GAP * 0.4, true);
      ctx.closePath();
      ctx.fillStyle = fillC;
      ctx.fill();
      ctx.globalAlpha = sAlpha;
      ctx.strokeStyle = fillC;
      ctx.lineWidth = isCurrent ? 2.5 : 1.5;
      ctx.stroke();
      ctx.restore();
    }
  });

  // ── 4. Event labels — outside petals, no overlap ──
  // Sort by bestI so labels at same petal stack in order
  const labelItems = [];
  te.forEach(ev => {
    const sm = new Date(ev.startISO).getHours() * 60 + new Date(ev.startISO).getMinutes();
    const em = new Date(ev.endISO).getHours()   * 60 + new Date(ev.endISO).getMinutes();
    if (em <= H_START * 60 || sm >= H_END * 60) return;
    let bestI = -1, bestOv = 0;
    for (let i = 0; i < CHOURS; i++) {
      const ov = Math.min(em, (H_START+i+1)*60) - Math.max(sm, (H_START+i)*60);
      if (ov > bestOv) { bestOv = ov; bestI = i; }
    }
    if (bestI < 0) return;
    const fmt = m => String(Math.floor(m/60)).padStart(2,'0') + ':' + String(m%60).padStart(2,'0');
    const short = ev.title.replace(/&lt;/g,'<').replace(/&amp;/g,'&');
    const name  = short.length > 12 ? short.slice(0,11) + '\u2026' : short;
    labelItems.push({ bestI, name, color: ev.color, isPast: em <= tm });
  });
  labelItems.sort((a,b) => a.bestI - b.bestI);

  // Assign label slots — stack outward, text always reads away from centre
  const petalLabelCount = {};
  labelItems.forEach(item => {
    const i     = item.bestI;
    const slot  = petalLabelCount[i] || 0;
    petalLabelCount[i] = slot + 1;

    const ro    = petalRO(i);
    const angle = petalMid(i);
    // Single-line label: ~14px per slot is enough
    const startR = ro + 16*sc + slot * 26*sc;
    const shouldFlip = Math.cos(angle) < 0;

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(angle);

    ctx.shadowColor = dark ? 'rgba(0,0,0,1)' : 'rgba(255,255,255,1)';
    ctx.shadowBlur  = 10;
    ctx.textBaseline = 'middle';

    if (shouldFlip) {
      ctx.font = 'bold 11px "JetBrains Mono",monospace';
      const twN = ctx.measureText(item.name).width;
      ctx.scale(-1, -1);
      ctx.translate(-(startR + twN + 4), 0);
    } else {
      ctx.translate(startR, 0);
    }

    ctx.textAlign = 'left';

    // Event name only
    ctx.font = 'bold 12px "JetBrains Mono",monospace';
    ctx.fillStyle = item.isPast ? 'rgba(160,160,160,0.45)' : item.color;
    ctx.fillText(item.name, 0, 0);

    ctx.shadowBlur = 0;
    ctx.restore();
  });

  // ── 5. Boundary markers: small dot every petal, accent tick + label every 3rd ──
  ctx.shadowBlur = 0;
  for(let i=0;i<CHOURS;i++){
    const hAbs   = H_START + i;
    const a      = hourAngle(i, 0);
    const ro     = petalRO(i);
    const ri     = petalRI();
    const isMajor = i % 3 === 0;

    if(isMajor){
      // Subtle radial tick at major hour boundaries
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(cx+(ri+2*sc)*Math.cos(a), cy+(ri+2*sc)*Math.sin(a));
      ctx.lineTo(cx+(ro+2*sc)*Math.cos(a), cy+(ro+2*sc)*Math.sin(a));
      ctx.strokeStyle=accentC; ctx.globalAlpha=0.18; ctx.lineWidth=1; ctx.stroke();
      ctx.restore();
    }

    // Dot at outer edge — larger and brighter at major marks
    const dotR    = ro + 5*sc;
    const dotSize = isMajor ? 3*sc : 1.5*sc;
    const dotAlpha= isMajor ? 0.80 : 0.40;
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx+dotR*Math.cos(a), cy+dotR*Math.sin(a), dotSize, 0, Math.PI*2);
    ctx.fillStyle=accentC; ctx.globalAlpha=dotAlpha; ctx.fill();
    ctx.restore();

    if(isMajor && hAbs!==5){
      // Hour label just outside dot — horizontal text aligned to position on circle
      let hLabel = hAbs===12?'12pm':hAbs<12?hAbs+'am':(hAbs-12)+'pm';
      const labelR = ro + 20*sc;
      const lx = cx + labelR*Math.cos(a);
      const ly = cy + labelR*Math.sin(a);
      let tAlign = 'center';
      if(Math.cos(a) > 0.2) tAlign = 'left';
      else if(Math.cos(a) < -0.2) tAlign = 'right';
      ctx.save();
      ctx.font = `bold 12px "JetBrains Mono",monospace`;
      ctx.textAlign = tAlign;
      ctx.textBaseline = 'middle';
      ctx.shadowColor=dark?'rgba(0,0,0,1)':'rgba(255,255,255,1)'; ctx.shadowBlur=8;
      ctx.fillStyle=dark?'rgba(180,220,255,0.80)':'rgba(20,45,80,0.80)';
      ctx.fillText(hLabel, lx, ly);
      ctx.shadowBlur=0;
      ctx.restore();
    }
  }

  // ── 6. Time needle ──
  if (tm >= H_START * 60 && tm < H_END * 60) {
    const slotF = tm / 60 - H_START;
    const si    = Math.floor(slotF);
    const frac  = slotF - si;
    const na    = hourAngle(si, frac);
    const nLen  = petalRO(si) + 6*sc;
    ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx + nLen * Math.cos(na), cy + nLen * Math.sin(na));
    ctx.strokeStyle = dark ? 'rgba(0,0,0,0.45)' : 'rgba(255,255,255,0.5)';
    ctx.lineWidth = 5; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx + nLen * Math.cos(na), cy + nLen * Math.sin(na));
    ctx.strokeStyle = needleC; ctx.lineWidth = 2.5; ctx.stroke();
    ctx.beginPath(); ctx.arc(cx + nLen * Math.cos(na), cy + nLen * Math.sin(na), 5*sc, 0, Math.PI * 2);
    ctx.fillStyle = needleC; ctx.fill();
  }

  // ── 7. Centre hub — just a small dot, no circle ──
  ctx.beginPath(); ctx.arc(cx, cy, 8*sc, 0, Math.PI * 2);
  ctx.fillStyle = hubC; ctx.fill();
}

// ── SMART TAP ────────────────────────────────────────
const overlay=document.getElementById('chrono-overlay');
const canvas=document.getElementById('cosmodex-canvas');
const picker=document.getElementById('event-picker');

overlay.addEventListener('click',e=>{
  const rect=overlay.getBoundingClientRect();
  const mx=(e.clientX-rect.left);
  const my=(e.clientY-rect.top);
  const cx=_cdxLW*0.50,cy=_cdxLH/2,dx=mx-cx,dy=my-cy,dist=Math.sqrt(dx*dx+dy*dy);
  // Work out which petal was tapped using angle + radius
  const tapAngle=Math.atan2(dy,dx);  // -π to π
  // Normalise to 0–2π starting from top (−π/2)
  let norm=tapAngle+Math.PI/2; if(norm<0)norm+=Math.PI*2;
  // Which hour slot?
  const slotF=norm/PETAL_RAD;
  const slotI=Math.floor(slotF);
  if(slotI<0||slotI>=CHOURS){closePicker();return;}
  const ro=petalRO(slotI);
  if(dist<petalRI()||dist>ro+20*_cosScale){closePicker();return;}
  const tapMin=(H_START+slotF)*60;  // fractional minute
  const near=todayEventsForPicker.filter(ev=>{
    const sm=new Date(ev.startISO).getHours()*60+new Date(ev.startISO).getMinutes();
    const em=new Date(ev.endISO).getHours()*60+new Date(ev.endISO).getMinutes();
    return sm<=tapMin+30&&tapMin<=em+30;
  });
  if(!near.length){
    closePicker();
    // Tap on empty petal → open Add Event modal pre-filled to that hour
    openAddEvent(localDate(), H_START+slotI);
    return;
  }
  if(near.length===1){openPomo(near[0]);return;}
  showPicker(near,e.clientX,e.clientY);
});

function showPicker(events,px,py){
  const items=document.getElementById('picker-items');items.innerHTML='';
  events.forEach(ev=>{
    const fmt=d=>d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    const div=document.createElement('div');div.className='picker-item';
    div.innerHTML='<div class="picker-dot" style="background:'+ev.color+'"></div><div class="picker-text"><div class="picker-title">'+ev.title+'</div><div class="picker-time">'+fmt(new Date(ev.startISO))+' \u2013 '+fmt(new Date(ev.endISO))+'</div></div>';
    div.addEventListener('click',()=>{closePicker();openPomo(ev);});
    items.appendChild(div);
  });
  picker.classList.add('open');
  const pw=320,ph=picker.offsetHeight||200;
  let left=px+12,top=py-ph/2;
  if(left+pw>window.innerWidth-10)left=px-pw-12;
  if(top<10)top=10; if(top+ph>window.innerHeight-10)top=window.innerHeight-ph-10;
  picker.style.left=left+'px';picker.style.top=top+'px';
}
function closePicker(){picker.classList.remove('open');}
document.getElementById('picker-cancel').addEventListener('click',closePicker);
document.addEventListener('click',e=>{if(picker.classList.contains('open')&&!picker.contains(e.target)&&e.target!==overlay)closePicker();},{capture:true});

// ── CLOCK + NEXT EVENT ────────────────────────────────
function updateClock(){
  const now=new Date();
  document.getElementById('time-big').textContent=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  const DN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const MN=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('time-date').textContent=DN[now.getDay()]+' \u00b7 '+now.getDate()+' '+MN[now.getMonth()]+' '+now.getFullYear();
  const nm=now.getTime(),in30=nm+30*60*1000;
  const up=EVENTS.map(e=>({...e,sm:new Date(e.startISO).getTime()})).filter(e=>e.sm>=nm&&e.sm<=in30).sort((a,b)=>a.sm-b.sm);
  if(up.length){
    const nx=up[0],st=new Date(nx.startISO),mu=Math.round((nx.sm-nm)/60000);
    document.getElementById('next-title').textContent=nx.title;
    document.getElementById('next-title').style.color=nx.color;
    document.getElementById('next-time').textContent=st.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})+' \u00b7 in '+mu+' min';
  }else{
    document.getElementById('next-title').textContent='Nothing in next 30 min';
    document.getElementById('next-title').style.color='var(--ink-dim)';
    document.getElementById('next-time').textContent='';
  }
}

// ── TASKS ─────────────────────────────────────────────
let _draggedTask=null;
function buildTasks(){
  const list=document.getElementById('tasks-list'), today=localDate();
  list.innerHTML='';
  const allTasks=filteredTasks();
  if(!allTasks.length){ list.innerHTML='<div class="loading-msg">'+(accessToken?'No tasks':'Sign in to see tasks')+'</div>'; document.getElementById('tasks-count').textContent=''; return; }

  // Build ID lookup and children map to maintain correct tree order
  const taskById={};
  allTasks.forEach(t=>taskById[t._id]=t);
  const childrenOf={};
  allTasks.forEach(t=>{
    if(t._parent&&taskById[t._parent]){
      if(!childrenOf[t._parent])childrenOf[t._parent]=[];
      childrenOf[t._parent].push(t);
    }
  });

  // Only root tasks (no parent, or parent not in filtered set) go into groups
  const rootTasks=allTasks.filter(t=>!t._parent||!taskById[t._parent]);
  const ov=rootTasks.filter(t=>!t.done&&t.due&&t.due<today);
  const dt=rootTasks.filter(t=>!t.done&&t.due===today);
  const up=rootTasks.filter(t=>!t.done&&(!t.due||t.due>today));
  const dn=rootTasks.filter(t=>t.done);

  function renderTask(task, mc){
    const isSubtask=!!(task._parent&&taskById[task._parent]);
    const item=document.createElement('div');
    item.className='task-item'+(task.done?' done':'')+(isSubtask?' subtask':'');
    item.draggable=true;
    item.dataset.taskId=task._id;
    const metaHtml=task.due?'<div class="task-meta '+(mc||'')+'">'+fmtDue(task.due,today)+(activeTaskTab==='all'?' \u00b7 '+task._listName:'')+'</div>':'';
    item.innerHTML=
      '<div class="drag-hint">\u2630</div>'+
      '<div class="task-pri pri-'+task.priority+'"></div>'+
      '<div class="task-check"></div>'+
      '<div class="task-body"><div class="task-title">'+(isSubtask?'\u2937 ':'')+task.title+'</div>'+metaHtml+'</div>'+
      (!isSubtask?'<button class="task-add-sub" title="Add subtask">+</button>':'')+
      '<button class="task-del-btn" title="Delete task">\u2715</button>';

    // Drag: allow all tasks to be dragged (including subtasks)
    item.addEventListener('dragstart',e=>{
      _draggedTask=task;
      e.dataTransfer.setData('text/plain',JSON.stringify({taskTitle:task.title,taskId:task._id,listId:task._list}));
      item.classList.add('dragging');
    });
    item.addEventListener('dragend',()=>{ item.classList.remove('dragging'); _draggedTask=null; });

    // Drop on a task item → reparent dragged task as a child (only if different task, not already a subtask target)
    item.addEventListener('dragover',e=>{
      if(_draggedTask&&_draggedTask._id!==task._id&&!isSubtask){
        e.preventDefault(); e.stopPropagation(); item.classList.add('drag-over');
      }
    });
    item.addEventListener('dragleave',()=>item.classList.remove('drag-over'));
    item.addEventListener('drop',e=>{
      e.preventDefault(); e.stopPropagation(); item.classList.remove('drag-over');
      if(_draggedTask&&_draggedTask._id!==task._id) moveTaskToSubtask(_draggedTask._id,_draggedTask._list,task._id,task._list);
    });

    item.querySelector('.task-check').addEventListener('click',ev=>{ev.stopPropagation();toggleTask(task);});
    const subBtn=item.querySelector('.task-add-sub');
    if(subBtn) subBtn.addEventListener('click',ev=>{ev.stopPropagation();openAddSubtask(task);});
    const delBtn=item.querySelector('.task-del-btn');
    if(delBtn) delBtn.addEventListener('click',ev=>{ev.stopPropagation();deleteTask(task);});

    list.appendChild(item);
    // Render children right after parent so hierarchy is visually correct
    (childrenOf[task._id]||[]).forEach(child=>renderTask(child, mc));
  }

  function grp(lbl,items,mc){
    if(!items.length)return;
    const gl=document.createElement('div');gl.className='task-group-lbl';gl.textContent=lbl;list.appendChild(gl);
    items.forEach(task=>renderTask(task,mc));
  }
  grp('\u26a0 Overdue',ov,'overdue');
  grp('\u00b7 Today',dt,'today-due');
  grp('\u00b7 Upcoming',up,'');
  grp('\u00b7 Done',dn,'');
  document.getElementById('tasks-count').textContent=allTasks.filter(t=>!t.done).length+' remaining';
}

async function deleteTask(task){
  if(!confirm('Delete "'+task.title.replace(/&lt;/g,'<')+'"?')) return;
  try{
    await fetch(TASKS_API+'/lists/'+task._list+'/tasks/'+task._id,{
      method:'DELETE', headers:{Authorization:'Bearer '+accessToken}
    });
    TASKS=TASKS.filter(t=>t._id!==task._id&&t._parent!==task._id); // remove task + its children
    buildTasks();
    showSyncBar('Task deleted','ok');
  }catch(e){ showSyncBar('\u26a0 Delete failed','err'); }
}

async function deleteEvent(ev){
  if(!confirm('Delete "'+ev.title.replace(/&lt;/g,'<')+'"\n'+ev.startISO.slice(0,16).replace('T',' ')+'?')) return;
  try{
    await fetch(CAL_API+'/calendars/'+encodeURIComponent(ev.calId)+'/events/'+ev.evId,{
      method:'DELETE', headers:{Authorization:'Bearer '+accessToken}
    });
    EVENTS=EVENTS.filter(e=>e.evId!==ev.evId);
    renderLeft(); drawCosmodex();
    showSyncBar('Event deleted','ok');
  }catch(e){ showSyncBar('\u26a0 Delete failed','err'); }
}

async function moveTaskToSubtask(taskId, fromListId, parentId, parentListId){
  if(fromListId!==parentListId){ showSyncBar('Can only move tasks within the same list','err'); return; }
  try{
    await fetch(TASKS_API+'/lists/'+fromListId+'/tasks/'+taskId+'/move?parent='+encodeURIComponent(parentId),{
      method:'POST', headers:{Authorization:'Bearer '+accessToken}
    });
    await loadAllData();
    showSyncBar('Moved as subtask \u2713','ok');
  }catch(e){ showSyncBar('\u26a0 Move failed: '+e.message,'err'); }
}
function fmtDue(due,today){ if(due===today)return'Today'; return new Date(due+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}); }

async function toggleTask(task){
  const newDone=!task.done;
  task.done=newDone; buildTasks();
  try{
    await fetch(TASKS_API+'/lists/'+task._list+'/tasks/'+task._id,{
      method:'PATCH', headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
      body:JSON.stringify({status:newDone?'completed':'needsAction'}),
    });
    if(newDone) logToSheet('Tasks',[new Date().toISOString(),task.title.replace(/&lt;/g,'<'),task._listName||'','completed']);
  }catch(e){ task.done=!newDone; buildTasks(); }
}

// ── ADD EVENT MODAL ───────────────────────────────────
function openAddEvent(dateStr, startHour){
  if(!accessToken){showSyncBar('Sign in first','err');return;}
  const now=new Date();
  if(dateStr && startHour !== undefined){
    document.getElementById('ev-date').value=dateStr;
    document.getElementById('ev-start').value=String(startHour%24).padStart(2,'0')+':00';
  } else {
    // Pre-fill today's date and current time rounded to next 30 min
    const mins=now.getMinutes(); const roundMin=mins<30?30:0;
    const h=roundMin===0?now.getHours()+1:now.getHours();
    document.getElementById('ev-date').value=localDate(now);
    document.getElementById('ev-start').value=String(h%24).padStart(2,'0')+':'+String(roundMin).padStart(2,'0');
  }
  document.getElementById('ev-title').value='';
  document.getElementById('ev-dur').value='30';
  // Populate calendar selector
  const sel=document.getElementById('ev-cal'); sel.innerHTML='';
  const primaryCal = CAL_LIST.find(c=>c.isPrimary);
  CAL_LIST.forEach(cal=>{
    const o=document.createElement('option'); o.value=cal.id; o.textContent=cal.name;
    // Priority: active tab > primary calendar > first
    if(activeCalTab!=='all' && activeCalTab===cal.id) o.selected=true;
    else if(activeCalTab==='all' && cal.isPrimary) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('modal-event').classList.add('open');
  setTimeout(()=>document.getElementById('ev-title').focus(),50);
}
function closeAddEvent(){ document.getElementById('modal-event').classList.remove('open'); }

document.getElementById('add-event-btn').addEventListener('click',openAddEvent);
document.getElementById('modal-event-close').addEventListener('click',closeAddEvent);
document.getElementById('ev-cancel').addEventListener('click',closeAddEvent);
document.getElementById('modal-event').addEventListener('click',e=>{ if(e.target===document.getElementById('modal-event'))closeAddEvent(); });

document.getElementById('ev-save').addEventListener('click',async()=>{
  const title=document.getElementById('ev-title').value.trim();
  const date=document.getElementById('ev-date').value;
  const start=document.getElementById('ev-start').value;
  const dur=parseInt(document.getElementById('ev-dur').value)||60;
  const calId=document.getElementById('ev-cal').value;
  if(!title){document.getElementById('ev-title').focus();return;}
  if(!date||!start){showSyncBar('Please fill in date and time','err');return;}
  const startDT=new Date(date+'T'+start);
  const endDT=new Date(startDT.getTime()+dur*60000);
  const toISO=d=>d.toISOString().replace('.000Z','Z');
  document.getElementById('ev-saving').style.display='';
  document.getElementById('ev-save').disabled=true;
  try{
    await apiPost(CAL_API+'/calendars/'+encodeURIComponent(calId)+'/events',{
      summary:title, start:{dateTime:toISO(startDT)}, end:{dateTime:toISO(endDT)},
    });
    closeAddEvent();
    await loadAllData();
    showSyncBar('Event added \u2713','ok');
  }catch(err){
    showSyncBar('\u26a0 '+err.message,'err');
  }finally{
    document.getElementById('ev-saving').style.display='none';
    document.getElementById('ev-save').disabled=false;
  }
});

// ── ADD TASK MODAL ────────────────────────────────────
let _subtaskParent=null;

function openAddTask(){
  if(!accessToken){showSyncBar('Sign in first','err');return;}
  _subtaskParent=null;
  document.querySelector('#modal-task .modal-title').textContent='Add Task';
  document.getElementById('tk-title').value='';
  document.getElementById('tk-date').value='';
  const sel=document.getElementById('tk-list'); sel.innerHTML='';
  // Default priority: active tab > "Other Reminders" > first list
  const otherReminders = TASK_LISTS.find(tl=>tl.title.toLowerCase().includes('other'));
  TASK_LISTS.forEach(tl=>{
    const o=document.createElement('option'); o.value=tl.id; o.textContent=tl.title;
    if(activeTaskTab!=='all'&&activeTaskTab===tl.id) o.selected=true;
    else if(activeTaskTab==='all'&&otherReminders&&tl.id===otherReminders.id) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('modal-task').classList.add('open');
  setTimeout(()=>document.getElementById('tk-title').focus(),50);
}
function openAddSubtask(parentTask){
  if(!accessToken){showSyncBar('Sign in first','err');return;}
  _subtaskParent=parentTask;
  document.querySelector('#modal-task .modal-title').textContent='Add Subtask \u2937';
  document.getElementById('tk-title').value='';
  document.getElementById('tk-date').value='';
  const sel=document.getElementById('tk-list'); sel.innerHTML='';
  TASK_LISTS.forEach(tl=>{
    const o=document.createElement('option'); o.value=tl.id; o.textContent=tl.title;
    if(tl.id===parentTask._list) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('modal-task').classList.add('open');
  setTimeout(()=>document.getElementById('tk-title').focus(),50);
}
function closeAddTask(){
  _subtaskParent=null;
  document.querySelector('#modal-task .modal-title').textContent='Add Task';
  document.getElementById('modal-task').classList.remove('open');
}

document.getElementById('add-task-btn').addEventListener('click',openAddTask);
document.getElementById('modal-task-close').addEventListener('click',closeAddTask);
document.getElementById('tk-cancel').addEventListener('click',closeAddTask);
document.getElementById('modal-task').addEventListener('click',e=>{ if(e.target===document.getElementById('modal-task'))closeAddTask(); });

document.getElementById('tk-save').addEventListener('click',async()=>{
  const title=document.getElementById('tk-title').value.trim();
  const due=document.getElementById('tk-date').value;
  const listId=document.getElementById('tk-list').value;
  if(!title){document.getElementById('tk-title').focus();return;}
  if(!listId){showSyncBar('No task lists found','err');return;}
  const body={title};
  // Tasks API expects RFC 3339 with time for due field
  if(due) body.due=new Date(due+'T00:00:00').toISOString();
  document.getElementById('tk-saving').style.display='';
  document.getElementById('tk-save').disabled=true;
  try{
    let url=TASKS_API+'/lists/'+listId+'/tasks';
    const wasSubtask=!!_subtaskParent;
    if(_subtaskParent) url+='?parent='+encodeURIComponent(_subtaskParent._id);
    await apiPost(url,body);
    closeAddTask();
    await loadAllData();
    showSyncBar((wasSubtask?'Subtask':'Task')+' added \u2713','ok');
  }catch(err){
    showSyncBar('\u26a0 '+err.message,'err');
  }finally{
    document.getElementById('tk-saving').style.display='none';
    document.getElementById('tk-save').disabled=false;
  }
});

// ── POMODORO ──────────────────────────────────────────
const PMIN=1,PMAX=80;let pomoDuration=25;
const pomo={running:false,totalSecs:25*60,remainSecs:25*60,interval:null,sessions:0};

// ── BREATHING RING ──────────────────────────────────
let _breathInterval=null;
const _breathPhases=['Breathe in \u2191','Hold','Breathe out \u2193','Hold'];
let _breathPhaseIdx=0;
function startBreathing(){
  _breathPhaseIdx=0;
  const el=document.getElementById('breath-phase');
  if(el) el.textContent=_breathPhases[0];
  clearInterval(_breathInterval);
  _breathInterval=setInterval(()=>{
    _breathPhaseIdx=(_breathPhaseIdx+1)%4;
    const el=document.getElementById('breath-phase');
    if(el) el.textContent=_breathPhases[_breathPhaseIdx];
  },4000);
}
function stopBreathing(){ clearInterval(_breathInterval); _breathInterval=null; }

// ── FOCUS CHECKLIST ─────────────────────────────────
let focusChecklist=[];
function renderFocusChecklist(){
  const el=document.getElementById('focus-check-items'); if(!el) return;
  el.innerHTML='';
  focusChecklist.forEach((item,i)=>{
    const div=document.createElement('div');
    div.className='focus-check-item'+(item.done?' done':'');
    div.innerHTML='<div class="focus-check-box">'+(item.done?'\u2713':'')+'</div><span class="focus-check-txt">'+item.text+'</span>';
    div.querySelector('.focus-check-box').addEventListener('click',()=>{
      focusChecklist[i].done=!focusChecklist[i].done; renderFocusChecklist();
    });
    el.appendChild(div);
  });
}
document.getElementById('focus-check-add-btn').addEventListener('click',()=>{
  const inp=document.getElementById('focus-check-input');
  const text=inp.value.trim(); if(!text) return;
  focusChecklist.push({text,done:false}); inp.value=''; renderFocusChecklist();
});
document.getElementById('focus-check-input').addEventListener('keydown',e=>{
  if(e.key==='Enter') document.getElementById('focus-check-add-btn').click();
});

function openPomo(ev){
  if(!pomo.running) document.getElementById('pomo-ev-title').textContent = ev ? ev.title : 'Focus Session';
  document.getElementById('pomo-overlay').classList.add('open');
  initScribble();
  startBreathing();
  drawPomoRing(); renderPomo(); buildTicks();
}
document.getElementById('pomo-open-btn').addEventListener('click', ()=>openPomo(null));
document.getElementById('pomo-close').addEventListener('click', ()=>{
  if(pomo.running){
    document.getElementById('pomo-lock-msg').classList.add('show');
    return;
  }
  _scribbleInited = false;
  stopBreathing();
  document.getElementById('pomo-overlay').classList.remove('open');
});
document.getElementById('pomo-withdraw').addEventListener('click', ()=>{
  clearInterval(pomo.interval); pomo.running=false;
  pomo.totalSecs=pomoDuration*60; pomo.remainSecs=pomoDuration*60;
  renderPomo();
  stopBreathing();
  document.getElementById('pomo-lock-msg').classList.remove('show');
  document.getElementById('pomo-overlay').classList.remove('open');
});

function clamp(v){return Math.max(PMIN,Math.min(PMAX,Math.round(v)));}
function setDuration(v){
  pomoDuration=clamp(v);
  if(!pomo.running){pomo.totalSecs=pomoDuration*60;pomo.remainSecs=pomoDuration*60;}
  const el=document.getElementById('sw-val');if(el)el.textContent=String(pomoDuration);
  buildTicks();renderPomo();
}
function buildTicks(){
  const c=document.getElementById('sw-ticks');if(!c)return;c.innerHTML='';
  for(let i=-15;i<=15;i++){
    const val=pomoDuration+i,el=document.createElement('div');
    if(val<PMIN||val>PMAX){el.style.width='4px';c.appendChild(el);continue;}
    el.className='tick'+(i===0?' current':val%5===0?' major':'');
    el.style.height=i===0?'16px':val%5===0?'11px':'6px';
    c.appendChild(el);
  }
}
let swX=null,swDur=null;
const swTrack=document.getElementById('sw-track');
swTrack.addEventListener('pointerdown',e=>{swX=e.clientX;swDur=pomoDuration;swTrack.setPointerCapture(e.pointerId);e.preventDefault();});
swTrack.addEventListener('pointermove',e=>{if(swX===null)return;setDuration(swDur+Math.round((e.clientX-swX)/13));});
swTrack.addEventListener('pointerup',()=>swX=null);
swTrack.addEventListener('pointercancel',()=>swX=null);
swTrack.addEventListener('wheel',e=>{e.preventDefault();setDuration(pomoDuration+(e.deltaY>0?-1:1));},{passive:false});
['sw-minus','sw-plus'].forEach(id=>{
  const btn=document.getElementById(id),d=id==='sw-minus'?-1:1;
  btn.addEventListener('click',()=>setDuration(pomoDuration+d));
  btn.addEventListener('pointerdown',()=>{let tid=setInterval(()=>setDuration(pomoDuration+d),90);document.addEventListener('pointerup',()=>clearInterval(tid),{once:true});});
});

function drawPomoRing(){
  const cv=document.getElementById('pomo-ring');if(!cv)return;
  const ctx=cv.getContext('2d'),W=cv.width,H=cv.height,cx=W/2,cy=H/2,R=58;
  ctx.clearRect(0,0,W,H);
  const frac=pomo.remainSecs/pomo.totalSecs,sa=-Math.PI/2,ea=sa+(1-frac)*Math.PI*2;
  const dark=isDark,gRGB=dark?'61,184,255':'11,98,196';
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.strokeStyle=dark?'rgba(61,184,255,0.10)':'rgba(11,98,196,0.12)';ctx.lineWidth=13;ctx.stroke();
  if(frac>0){ctx.beginPath();ctx.arc(cx,cy,R,ea,sa+Math.PI*2);ctx.strokeStyle='rgba('+gRGB+',0.12)';ctx.lineWidth=13;ctx.lineCap='butt';ctx.stroke();}
  if(frac<1){const col=pomo.running?(dark?'#e05555':'#c42b2b'):pomo.remainSecs<pomo.totalSecs?(dark?'#3db8ff':'#0b62c4'):'rgba('+gRGB+',0.55)';ctx.beginPath();ctx.arc(cx,cy,R,sa,ea);ctx.strokeStyle=col;ctx.lineWidth=13;ctx.lineCap='round';ctx.stroke();}
}
function renderPomo(){
  const m=Math.floor(pomo.remainSecs/60),s=pomo.remainSecs%60;
  document.getElementById('pomo-time').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  document.getElementById('pomo-phase').textContent=pomo.running?'Focusing':pomo.remainSecs===0?'Complete \u2713':pomo.remainSecs<pomo.totalSecs?'Paused':'Ready';
  document.getElementById('pomo-start').textContent=pomo.running?'Pause':pomo.remainSecs>0&&pomo.remainSecs<pomo.totalSecs?'Resume':'Start';
  document.querySelectorAll('.sess-dot').forEach((d,i)=>d.classList.toggle('done',i<pomo.sessions));
  const sw=document.querySelector('.swipe-section');
  if(sw){sw.style.opacity=pomo.running?'0.4':'1';sw.style.pointerEvents=pomo.running?'none':'auto';}
  if(!pomo.running) document.getElementById('pomo-lock-msg').classList.remove('show');
  drawPomoRing();
}
document.getElementById('pomo-start').addEventListener('click',()=>{
  if(pomo.running){clearInterval(pomo.interval);pomo.running=false;}
  else{
    if(pomo.remainSecs===0){pomo.totalSecs=pomoDuration*60;pomo.remainSecs=pomoDuration*60;}
    pomo.running=true;
    pomo.interval=setInterval(()=>{
      pomo.remainSecs--;
      if(pomo.remainSecs<=0){
        clearInterval(pomo.interval);pomo.running=false;pomo.remainSecs=0;pomo.sessions=Math.min(4,pomo.sessions+1);
        logToSheet('Events',[new Date().toISOString(),document.getElementById('pomo-ev-title').textContent,'pomo_complete',String((pomoDuration/60).toFixed(2))]);
        stopBreathing();
        document.getElementById('pomo-lock-msg').classList.remove('show');
        setTimeout(()=>{ _scribbleInited=false; document.getElementById('pomo-overlay').classList.remove('open'); },1200);
        try{const ac=new(window.AudioContext||window.webkitAudioContext)();[0,0.35,0.7].forEach((t,i)=>{const osc=ac.createOscillator(),g=ac.createGain();osc.connect(g);g.connect(ac.destination);osc.frequency.value=[528,660,792][i];g.gain.value=0.2;osc.start(ac.currentTime+t);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+t+0.9);osc.stop(ac.currentTime+t+0.9);});}catch(e){}
      }
      renderPomo();
    },1000);
  }
  renderPomo();
});
document.getElementById('pomo-reset').addEventListener('click',()=>{
  clearInterval(pomo.interval);pomo.running=false;pomo.totalSecs=pomoDuration*60;pomo.remainSecs=pomoDuration*60;renderPomo();
});


// ── SCRIBBLE BOARD ────────────────────────────────────
let _scribbleInited = false;
const SCRIBBLE_COLORS = ['#e8e4d8','#c9a84c','#4a7fa5','#5a8f6a','#c44b3a','#d4813a','#222222'];
const PEN_SIZES = [1, 2, 4, 8, 16];

function initScribble() {
  // Always re-init: tear down old canvas and replace with fresh clone
  // This removes all stale event listeners cleanly
  const oldCv = document.getElementById('scribble-canvas');
  const col   = oldCv.parentElement;
  const newCv = oldCv.cloneNode(false);
  newCv.id = 'scribble-canvas';
  col.replaceChild(newCv, oldCv);
  const cv = newCv;

  // Size canvas to fill container
  const dpr = window.devicePixelRatio || 1;
  const w = col.clientWidth  || 600;
  const h = col.clientHeight || 400;
  cv.width  = Math.round(w * dpr);
  cv.height = Math.round(h * dpr);
  cv.style.width  = w + 'px';
  cv.style.height = h + 'px';
  const ctx = cv.getContext('2d');
  ctx.scale(dpr, dpr);

  // State
  let activeColor = SCRIBBLE_COLORS[0];
  let penSize     = 1;
  let isEraser    = false;
  let drawing     = false;
  let lastX = 0, lastY = 0;

  // ── Color swatches ──
  const swatchBar = document.getElementById('color-swatches');
  swatchBar.innerHTML = '';
  SCRIBBLE_COLORS.forEach(c => {
    const s = document.createElement('div');
    s.className = 'scribble-swatch' + (c === activeColor ? ' active' : '');
    s.style.background = c;
    s.addEventListener('click', () => {
      activeColor = c; isEraser = false;
      document.querySelectorAll('.scribble-swatch').forEach(x => x.classList.remove('active'));
      s.classList.add('active');
      document.getElementById('scribble-eraser').classList.remove('active');
    });
    swatchBar.appendChild(s);
  });

  // ── Pen size buttons (replace slider with preset dots) ──
  const sizeBar = document.getElementById('pen-size-bar');
  sizeBar.innerHTML = '';
  PEN_SIZES.forEach(sz => {
    const btn = document.createElement('button');
    btn.className = 'pen-size-btn' + (sz === 1 ? ' active' : '');
    btn.title = sz + 'px';
    // Show a dot whose size represents the pen width
    const dotPx = Math.min(sz + 4, 20);
    btn.innerHTML = `<span style="display:inline-block;width:${dotPx}px;height:${dotPx}px;border-radius:50%;background:currentColor;vertical-align:middle;"></span>`;
    btn.addEventListener('click', () => {
      penSize = sz; isEraser = false;
      document.querySelectorAll('.pen-size-btn').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('scribble-eraser').classList.remove('active');
    });
    sizeBar.appendChild(btn);
  });

  // ── Tool buttons ──
  const eraserBtn = document.getElementById('scribble-eraser');
  eraserBtn.onclick = function() {
    isEraser = !isEraser;
    this.classList.toggle('active', isEraser);
  };
  eraserBtn.classList.remove('active');

  document.getElementById('scribble-clear').onclick = () => {
    ctx.clearRect(0, 0, cv.width, cv.height);
  };

  document.getElementById('scribble-download').onclick = () => {
    const link = document.createElement('a');
    link.download = 'cosmodex-notes-' + localDate() + '.png';
    const tmp = document.createElement('canvas');
    tmp.width = cv.width; tmp.height = cv.height;
    const tc = tmp.getContext('2d');
    tc.fillStyle = isDark ? '#030508' : '#f0f4f8';
    tc.fillRect(0, 0, tmp.width, tmp.height);
    tc.drawImage(cv, 0, 0);
    link.href = tmp.toDataURL('image/png');
    link.click();
  };

  // ── Drawing ──
  function getPos(e) {
    const rect = cv.getBoundingClientRect();
    const sx = cv.width / dpr / rect.width;
    const sy = cv.height / dpr / rect.height;
    return [(e.clientX - rect.left) * sx, (e.clientY - rect.top) * sy];
  }

  function startDraw(e) {
    e.preventDefault();
    drawing = true;
    [lastX, lastY] = getPos(e);
    // Draw a dot at start point
    ctx.save();
    if (isEraser) ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(lastX, lastY, (isEraser ? penSize * 3 : penSize) / 2, 0, Math.PI * 2);
    ctx.fillStyle = activeColor;
    ctx.fill();
    ctx.restore();
  }

  function moveDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    const [x, y] = getPos(e);
    ctx.save();
    if (isEraser) {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(x, y, penSize * 3, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(0,0,0,1)';
      ctx.fill();
    } else {
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.strokeStyle = activeColor;
      ctx.lineWidth   = penSize;
      ctx.lineCap     = 'round';
      ctx.lineJoin    = 'round';
      ctx.stroke();
    }
    ctx.restore();
    lastX = x; lastY = y;
  }

  function endDraw() { drawing = false; }

  // Use pointer events — works for mouse, touch, and Apple Pencil
  cv.addEventListener('pointerdown',  startDraw, { passive: false });
  cv.addEventListener('pointermove',  moveDraw,  { passive: false });
  cv.addEventListener('pointerup',    endDraw,   { passive: false });
  cv.addEventListener('pointercancel',endDraw,   { passive: false });
  cv.style.touchAction = 'none';

  _scribbleInited = true;
}


// ── QUICK NOTES SCRIBBLE ─────────────────────────────
(function(){
  const COLORS = ['#e8e4d8','#c9a84c','#4a7fa5','#5a8f6a','#c44b3a','#d4813a','#222222'];
  const SIZES  = [1,2,4,8,16];
  let noteInited = false;

  function openNotesOverlay(){
    const ov = document.getElementById('notes-overlay');
    ov.style.display = 'flex';
    // Wait for layout so getBoundingClientRect returns real values (fixes stylus offset on iPad/Boox)
    requestAnimationFrame(()=>{
      if(!noteInited){ noteInited=true; initNotesCanvas(); }
      else { resizeNotesCanvas(); }
    });
  }
  function closeNotesOverlay(){
    document.getElementById('notes-overlay').style.display = 'none';
  }

  function initNotesCanvas(){
    const cv  = document.getElementById('notes-canvas');
    const dpr = window.devicePixelRatio || 1;

    function resizeCanvas(){
      const rect = cv.getBoundingClientRect();
      const w = rect.width  || cv.offsetWidth  || window.innerWidth;
      const h = rect.height || cv.offsetHeight || window.innerHeight - 60;
      const tmp = document.createElement('canvas');
      tmp.width = cv.width; tmp.height = cv.height;
      tmp.getContext('2d').drawImage(cv,0,0);
      cv.width  = Math.round(w*dpr); cv.height = Math.round(h*dpr);
      cv.style.width = w+'px'; cv.style.height = h+'px';
      const ctx = cv.getContext('2d');
      ctx.scale(dpr,dpr);
      ctx.drawImage(tmp,0,0,w,h);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    // expose for external resize calls
    window._resizeNotesCanvas = resizeCanvas;

    let color  = COLORS[0];
    let penSz  = 2;
    let eraser = false;
    let drawing= false, lx=0, ly=0;

    // Pen size buttons
    const penBar = document.getElementById('notes-pen-bar');
    SIZES.forEach(sz=>{
      const b=document.createElement('button');
      b.className='pen-size-btn'+(sz===penSz?' active':'');
      const dp=Math.min(sz+4,20);
      b.innerHTML=`<span style="width:${dp}px;height:${dp}px;border-radius:50%;background:currentColor;display:inline-block;vertical-align:middle"></span>`;
      b.addEventListener('click',()=>{
        penSz=sz; eraser=false;
        penBar.querySelectorAll('.pen-size-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        document.getElementById('notes-eraser-btn').classList.remove('active');
      });
      penBar.appendChild(b);
    });

    // Color swatches
    const colBar = document.getElementById('notes-color-bar');
    COLORS.forEach(c=>{
      const s=document.createElement('div');
      s.className='scribble-swatch'+(c===color?' active':'');
      s.style.background=c;
      s.addEventListener('click',()=>{
        color=c; eraser=false;
        colBar.querySelectorAll('.scribble-swatch').forEach(x=>x.classList.remove('active'));
        s.classList.add('active');
        document.getElementById('notes-eraser-btn').classList.remove('active');
      });
      colBar.appendChild(s);
    });

    document.getElementById('notes-eraser-btn').addEventListener('click', function(){
      eraser=!eraser; this.classList.toggle('active',eraser);
    });
    document.getElementById('notes-clear-btn2').addEventListener('click',()=>{
      const ctx=cv.getContext('2d');
      ctx.clearRect(0,0,cv.width,cv.height);
    });
    document.getElementById('notes-save-btn').addEventListener('click',()=>{
      const link=document.createElement('a');
      link.download='cosmodex-notes-'+localDate()+'.png';
      const tmp=document.createElement('canvas');
      tmp.width=cv.width; tmp.height=cv.height;
      const tc=tmp.getContext('2d');
      tc.fillStyle=isDark?'#030508':'#f0f4f8';
      tc.fillRect(0,0,tmp.width,tmp.height);
      tc.drawImage(cv,0,0);
      link.href=tmp.toDataURL('image/png'); link.click();
    });
    document.getElementById('notes-overlay-close').addEventListener('click', closeNotesOverlay);

    function getPos(e){
      const r=cv.getBoundingClientRect();
      // Scale from CSS pixels to canvas logical pixels (handles DPR mismatch on some tablets)
      const sx=cv.width/dpr/r.width, sy=cv.height/dpr/r.height;
      return [(e.clientX-r.left)*sx, (e.clientY-r.top)*sy];
    }

    function startDraw(e){
      e.preventDefault(); drawing=true;
      [lx,ly]=getPos(e);
      const ctx=cv.getContext('2d');
      ctx.save();
      if(eraser){ ctx.globalCompositeOperation='destination-out';ctx.beginPath();ctx.arc(lx,ly,penSz*3,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,1)';ctx.fill(); }
      else{ ctx.beginPath();ctx.arc(lx,ly,penSz/2,0,Math.PI*2);ctx.fillStyle=color;ctx.fill(); }
      ctx.restore();
    }
    function moveDraw(e){
      if(!drawing) return; e.preventDefault();
      const [x,y]=getPos(e);
      const ctx=cv.getContext('2d');
      ctx.save();
      if(eraser){ ctx.globalCompositeOperation='destination-out';ctx.beginPath();ctx.arc(x,y,penSz*3,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,1)';ctx.fill(); }
      else{ ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(x,y);ctx.strokeStyle=color;ctx.lineWidth=penSz;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke(); }
      ctx.restore();
      lx=x; ly=y;
    }
    function endDraw(){ drawing=false; }

    cv.addEventListener('pointerdown', startDraw, {passive:false});
    cv.addEventListener('pointermove', moveDraw,  {passive:false});
    cv.addEventListener('pointerup',   endDraw,   {passive:false});
    cv.addEventListener('pointercancel',endDraw,  {passive:false});
  }

  function resizeNotesCanvas(){
    if(window._resizeNotesCanvas) window._resizeNotesCanvas();
  }

  document.getElementById('notes-btn').addEventListener('click', openNotesOverlay);
})();



// ── MOBILE NAV ───────────────────────────────────────
function isMobile(){ return window.innerWidth <= 720; }
function mobileSwitchPanel(id, btn){
  if(!isMobile()) return;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('mobile-active'));
  document.getElementById(id).classList.add('mobile-active');
  document.querySelectorAll('.mob-nav-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  // Redraw cosmodex if switching to it
  if(id==='panel-chrono') setTimeout(drawCosmodex, 80);
}
function initMobileLayout(){
  if(!isMobile()) return;
  // Default: show calendar panel
  document.getElementById('panel-left').classList.add('mobile-active');
}
window.addEventListener('resize', ()=>{
  if(!isMobile()){
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('mobile-active'));
  } else {
    initMobileLayout();
  }
});

// ── INSIGHTS ─────────────────────────────────────────
async function openInsights(){
  document.getElementById('insights-overlay').classList.add('open');
  await buildInsights();
}
function closeInsights(){
  document.getElementById('insights-overlay').classList.remove('open');
}

async function buildInsights(){
  // Show loading state
  document.getElementById('heatmap-wrap').innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:12px;color:var(--ink-dim)">Loading…</div>';
  document.getElementById('insights-stats').innerHTML='';
  document.getElementById('insights-grid-6x15').innerHTML='';

  // Build 90-day map from spreadsheet
  const dayFocus={};   // date → hours of deep work
  const sessions=[];   // [{date,title,hrs}]

  if(SHEETS_ID && accessToken){
    try{
      const res=await apiFetch(`${SHEETS_API}/${SHEETS_ID}/values/Events!A:D`);
      (res.values||[]).forEach(row=>{
        if(row[2]==='pomo_complete'){
          const date=(row[0]||'').slice(0,10);
          const hrs=parseFloat(row[3])||0;
          if(date){ dayFocus[date]=(dayFocus[date]||0)+hrs; }
          sessions.push({date,title:row[1]||'',hrs});
        }
      });
    }catch(e){}
  }

  // ── Heatmap ──
  const wrap=document.getElementById('heatmap-wrap');
  wrap.innerHTML='';
  const now=new Date(), DAYS=91;
  // Build cells day by day
  const cells=[];
  for(let i=DAYS-1;i>=0;i--){
    const d=new Date(now);d.setDate(now.getDate()-i);
    cells.push({date:localDate(d),dow:d.getDay()});
  }
  // Group into columns of 7 starting from the first full week
  const MAX_HRS=4;
  const dark=isDark;
  // pad so columns align to Monday (dow=1)
  const firstDow=cells[0].dow; // 0=Sun, pad to make Mon=0
  const padDays=(firstDow===0?6:firstDow-1);
  for(let p=0;p<padDays;p++) cells.unshift(null); // null = empty pad cell
  // pad end so last column is always a full 7-cell column
  const rem=cells.length%7; if(rem!==0) for(let p=0;p<7-rem;p++) cells.push(null);
  // Chunk into cols of 7
  const cols=[];
  for(let i=0;i<cells.length;i+=7) cols.push(cells.slice(i,i+7));
  cols.forEach(col=>{
    const colEl=document.createElement('div');colEl.className='heatmap-col';
    col.forEach(cell=>{
      const d=document.createElement('div');d.className='heatmap-cell';
      if(!cell){d.style.opacity='0';colEl.appendChild(d);return;}
      const hrs=dayFocus[cell.date]||0;
      const intensity=Math.min(hrs/MAX_HRS,1);
      if(intensity===0){
        d.style.background=dark?'rgba(61,184,255,0.08)':'rgba(11,98,196,0.08)';
      }else{
        const alpha=0.18+intensity*0.82;
        d.style.background=dark?`rgba(61,184,255,${alpha.toFixed(2)})`:`rgba(11,98,196,${alpha.toFixed(2)})`;
      }
      d.title=cell.date+' · '+(hrs>0?hrs.toFixed(1)+'h deep work':'no sessions');
      colEl.appendChild(d);
    });
    wrap.appendChild(colEl);
  });

  // Legend
  const leg=document.getElementById('heatmap-legend');
  leg.innerHTML='';
  [0,0.25,0.5,0.75,1].forEach(v=>{
    const c=document.createElement('div');
    c.style.cssText='width:36px;height:14px;border-radius:3px;';
    const alpha=v===0?0.08:(0.18+v*0.82);
    c.style.background=dark?`rgba(61,184,255,${alpha.toFixed(2)})`:`rgba(11,98,196,${alpha.toFixed(2)})`;
    leg.appendChild(c);
  });

  // ── Stats ──
  const totalHrs=Object.values(dayFocus).reduce((s,v)=>s+v,0);
  const thisWeek=cells.slice(-7).filter(Boolean).reduce((s,c)=>s+(dayFocus[c.date]||0),0);
  const bestEntry=Object.entries(dayFocus).sort((a,b)=>b[1]-a[1])[0];
  const statsEl=document.getElementById('insights-stats');
  statsEl.innerHTML=`
    <div class="stat-card">
      <div class="stat-card-lbl">Total 90 days</div>
      <div class="stat-card-val">${totalHrs.toFixed(1)}<span class="stat-card-unit">h</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-card-lbl">This week</div>
      <div class="stat-card-val">${thisWeek.toFixed(1)}<span class="stat-card-unit">h</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-card-lbl">Best day</div>
      <div class="stat-card-val" style="font-size:18px">${bestEntry?bestEntry[0].slice(5)+' · '+bestEntry[1].toFixed(1)+'h':'—'}</div>
    </div>`;

  // ── 6×15 Focus Grid (90 days, 6 rows × 15 columns) ──
  const gridEl=document.getElementById('insights-grid-6x15');
  gridEl.innerHTML='';
  const GRID_ROWS=6, GRID_COLS=15, GRID_DAYS=GRID_ROWS*GRID_COLS; // 90
  const MAX_HRS2=4;
  // Build array of 90 days oldest→newest
  const gridDays=[];
  for(let i=GRID_DAYS-1;i>=0;i--){
    const d=new Date(now); d.setDate(now.getDate()-i);
    gridDays.push(localDate(d));
  }
  // Fill grid left-to-right, top-to-bottom (row 1 = oldest 15, row 6 = newest 15)
  // Slice ensures exactly GRID_DAYS (90) cells regardless of DST edge cases
  gridDays.slice(0,GRID_DAYS).forEach((dateStr,idx)=>{
    const hrs=dayFocus[dateStr]||0;
    const intensity=Math.min(hrs/MAX_HRS2,1);
    const cell=document.createElement('div');
    cell.className='ig-cell';
    const alpha=intensity===0?0.07:(0.15+intensity*0.85);
    cell.style.background=dark?`rgba(61,184,255,${alpha.toFixed(2)})`:`rgba(11,98,196,${alpha.toFixed(2)})`;
    if(intensity>0) cell.style.borderColor=dark?`rgba(61,184,255,${(alpha+0.2).toFixed(2)})`:`rgba(11,98,196,${(alpha+0.2).toFixed(2)})`;
    cell.title=dateStr+' · '+(hrs>0?hrs.toFixed(1)+'h deep work':'no sessions');
    gridEl.appendChild(cell);
  });

  // Legend for grid
  const gridLeg=document.getElementById('insights-grid-legend');
  gridLeg.innerHTML='';
  [0,0.25,0.5,0.75,1].forEach(v=>{
    const c=document.createElement('div');
    c.style.cssText='width:32px;height:12px;border-radius:2px;';
    const alpha=v===0?0.07:(0.15+v*0.85);
    c.style.background=dark?`rgba(61,184,255,${alpha.toFixed(2)})`:`rgba(11,98,196,${alpha.toFixed(2)})`;
    gridLeg.appendChild(c);
  });
}

// ── SIDEBAR PANEL TOGGLES ────────────────────────────
const _panelVis={left:true,tasks:true};
function toggleSidePanel(which){
  _panelVis[which]=!_panelVis[which];
  const pl=document.getElementById('panel-left');
  const pt=document.getElementById('panel-tasks');
  const c3=_panelVis.tasks?'340px':'0px';
  const c4=_panelVis.left?'340px':'0px';
  document.body.style.gridTemplateColumns='36px 1fr '+c3+' '+c4;
  pl.style.display=_panelVis.left?'flex':'none';
  pt.style.display=_panelVis.tasks?'flex':'none';
  document.getElementById('sbtn-cal').classList.toggle('on',_panelVis.left);
  document.getElementById('sbtn-tasks').classList.toggle('on',_panelVis.tasks);
  // Canvas redrawn by ResizeObserver when panel-chrono resizes
}

// ── INIT ──────────────────────────────────────────────
renderLeft(); buildTasks(); updateClock(); drawCosmodex(); buildTicks(); renderPomo(); initMobileLayout();
setInterval(()=>{updateClock();drawCosmodex();}, 30000);
window.addEventListener('resize', () => {
  clearTimeout(window._cdxResizeT);
  window._cdxResizeT = setTimeout(drawCosmodex, 150);
});
// ResizeObserver ensures canvas redraws whenever the chrono panel changes size (panel collapse/expand)
if(window.ResizeObserver){
  new ResizeObserver(()=>{
    clearTimeout(window._cdxResizeT);
    window._cdxResizeT = setTimeout(drawCosmodex, 50);
  }).observe(document.getElementById('panel-chrono'));
}
setInterval(async ()=>{
  if(!accessToken) return;
  await maybeRefreshToken();  // renew token if expiring soon
  try { await loadAllDataSilent(); } catch(e) {}
}, 5*60*1000);  // 5 min refresh + token renewal check

const _gisWait=setInterval(()=>{
  if(window.google&&window.google.accounts){
    clearInterval(_gisWait); initGIS();
    if(accessToken){
      document.getElementById('signin-overlay').classList.add('hidden');
      document.getElementById('sync-user').textContent=currentUser;
      loadAllData();
    }
  }
},150);

// ══════════════════════════════════════════════════════
//  LIFE OS — Project & Initiative Manager
// ══════════════════════════════════════════════════════
const LIFEOS_PASS      = '101';
const LIFEOS_SES_KEY   = 'lifeos_auth_v1';
const LIFEOS_TAB       = 'LifeOS';
const LIFEOS_CATS      = ['All','Mind','Body','Soul','Growth','Relationships','Cosmos'];
const LIFEOS_CAT_COLORS = {
  Mind:'#3db8ff', Body:'#46d4a0', Soul:'#e058c0',
  Growth:'#8ccc60', Relationships:'#e05555', Cosmos:'#7078f0'
};

let _losProjects   = [];      // [{id,title,category,notes,checklist,createdAt,updatedAt}]
let _losSelected   = null;    // active project id
let _losCatFilter  = 'All';
let _losSearch     = '';
let _losSaveTimer  = null;
let _losLoaded     = false;

// ── Helpers ────────────────────────────────────────────
function losGenId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function losProg(p){ if(!p.checklist||!p.checklist.length)return 0; return Math.round(p.checklist.filter(c=>c.done).length/p.checklist.length*100); }
function losNow(){ return new Date().toISOString(); }
function losSafeJSON(s,fb){ try{return JSON.parse(s);}catch(e){return fb;} }

// ── Open / Close ───────────────────────────────────────
function openLifeOS(){
  document.getElementById('lifeos-overlay').classList.add('open');
  if(sessionStorage.getItem(LIFEOS_SES_KEY)==='1'){
    losShowMain();
  } else {
    document.getElementById('lifeos-gate').classList.remove('hidden');
    document.getElementById('lifeos-main').style.display='none';
    document.getElementById('lifeos-pin').value='';
    document.getElementById('lifeos-gate-err').textContent='';
    setTimeout(()=>document.getElementById('lifeos-pin').focus(),80);
  }
}
function closeLifeOS(){ document.getElementById('lifeos-overlay').classList.remove('open'); }

function losShowMain(){
  document.getElementById('lifeos-gate').classList.add('hidden');
  const m=document.getElementById('lifeos-main');
  m.style.display='flex'; m.style.flexDirection='column'; m.style.flex='1'; m.style.overflow='hidden';
  if(!_losLoaded) losLoad();
  else { losBuildChips(); losRenderList(); }
}

// ── Password gate ──────────────────────────────────────
document.getElementById('lifeos-pin-submit').addEventListener('click', losCheckPin);
document.getElementById('lifeos-pin').addEventListener('keydown', e=>{ if(e.key==='Enter') losCheckPin(); });
function losCheckPin(){
  if(document.getElementById('lifeos-pin').value===LIFEOS_PASS){
    sessionStorage.setItem(LIFEOS_SES_KEY,'1');
    document.getElementById('lifeos-gate-err').textContent='';
    document.getElementById('lifeos-pin').value='';
    losShowMain();
  } else {
    document.getElementById('lifeos-gate-err').textContent='Incorrect PIN';
    document.getElementById('lifeos-pin').value='';
    const inner=document.querySelector('.lifeos-gate-inner');
    inner.classList.remove('shake'); void inner.offsetWidth;
    inner.classList.add('shake');
    setTimeout(()=>inner.classList.remove('shake'),500);
    document.getElementById('lifeos-pin').focus();
  }
}

document.getElementById('lifeos-close-btn').addEventListener('click', closeLifeOS);
document.getElementById('lifeos-add-btn').addEventListener('click', losAddProject);
document.getElementById('lifeos-sync-btn').addEventListener('click', ()=>losLoad(true));

// ── Category chips ─────────────────────────────────────
function losBuildChips(){
  const wrap=document.getElementById('lifeos-cat-chips');
  wrap.innerHTML='';
  LIFEOS_CATS.forEach(cat=>{
    const b=document.createElement('button');
    b.className='lifeos-chip'+(cat===_losCatFilter?' active':'');
    b.textContent=cat;
    b.addEventListener('click',()=>{ _losCatFilter=cat; losBuildChips(); losRenderList(); });
    wrap.appendChild(b);
  });
}

// ── Project list ───────────────────────────────────────
function losRenderList(){
  const list=document.getElementById('lifeos-proj-list');
  list.innerHTML='';
  const q=_losSearch.toLowerCase();
  const filtered=_losProjects.filter(p=>
    (_losCatFilter==='All'||p.category===_losCatFilter)&&
    (!q||p.title.toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q))
  );
  // Group by category
  const groups={};
  filtered.forEach(p=>{ if(!groups[p.category])groups[p.category]=[]; groups[p.category].push(p); });
  if(!filtered.length){
    list.innerHTML='<div style="padding:20px 14px;font-family:JetBrains Mono,monospace;font-size:12px;color:var(--ink-dim)">'+(_losProjects.length===0?'No projects yet. Click + Project.':'No matches.')+'</div>';
    return;
  }
  const orderedCats=['Mind','Body','Soul','Growth','Relationships','Cosmos'];
  orderedCats.filter(c=>groups[c]).forEach(cat=>{
    const lbl=document.createElement('div');
    lbl.className='lifeos-proj-group-lbl';
    lbl.innerHTML='<span style="color:'+(LIFEOS_CAT_COLORS[cat]||'var(--accent)')+';margin-right:5px">●</span>'+cat;
    list.appendChild(lbl);
    groups[cat].forEach(p=>{
      const pct=losProg(p);
      const color=LIFEOS_CAT_COLORS[p.category]||'var(--accent)';
      const item=document.createElement('div');
      item.className='lifeos-proj-item'+(p.id===_losSelected?' active':'');
      item.innerHTML=
        '<div class="lifeos-proj-dot" style="background:'+color+'"></div>'+
        '<div class="lifeos-proj-info">'+
          '<div class="lifeos-proj-name">'+(p.title||'(Untitled)').replace(/</g,'&lt;')+'</div>'+
          '<div class="lifeos-proj-meta">'+p.category+' · '+pct+'% done</div>'+
        '</div>'+
        '<div class="lifeos-proj-mini-bar"><div class="lifeos-proj-mini-fill" style="width:'+pct+'%"></div></div>';
      item.addEventListener('click',()=>losSelect(p.id));
      list.appendChild(item);
    });
  });
}

// ── Project detail ─────────────────────────────────────
function losSelect(id){
  _losSelected=id;
  losRenderList();
  const p=_losProjects.find(x=>x.id===id);
  if(!p){ losShowEmpty(); return; }
  document.getElementById('lifeos-empty').style.display='none';
  const det=document.getElementById('lifeos-detail');
  det.style.display='flex';
  document.getElementById('lifeos-det-title').value=p.title;
  document.getElementById('lifeos-det-cat').value=p.category||'Mind';
  document.getElementById('lifeos-det-notes').value=p.notes||'';
  const d=new Date(p.updatedAt||p.createdAt||losNow());
  document.getElementById('lifeos-det-updated').textContent='Updated '+d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  losRenderChecklist(p);
  losUpdateProgress(p);
}
function losShowEmpty(){
  document.getElementById('lifeos-empty').style.display='flex';
  document.getElementById('lifeos-detail').style.display='none';
  _losSelected=null;
}

function losUpdateProgress(p){
  const pct=losProg(p);
  document.getElementById('lifeos-prog-fill').style.width=pct+'%';
  document.getElementById('lifeos-prog-pct').textContent=pct+'%';
}

function losRenderChecklist(p){
  const wrap=document.getElementById('lifeos-checklist');
  wrap.innerHTML='';
  (p.checklist||[]).forEach((item,i)=>{
    const row=document.createElement('div');
    row.className='lifeos-ci'+(item.done?' done':'');
    row.innerHTML=
      '<div class="lifeos-ci-box">'+(item.done?'&#10003;':'')+'</div>'+
      '<input class="lifeos-ci-txt-inp'+(item.done?' done':'')+'" value="'+item.text.replace(/"/g,'&quot;').replace(/</g,'&lt;')+'" placeholder="Item…">'+
      '<button class="lifeos-ci-del" title="Remove">&#10005;</button>';
    row.querySelector('.lifeos-ci-box').addEventListener('click',()=>{
      p.checklist[i].done=!p.checklist[i].done;
      p.updatedAt=losNow();
      losRenderChecklist(p); losUpdateProgress(p); losRenderList(); losDebouncedSave();
    });
    row.querySelector('.lifeos-ci-txt-inp').addEventListener('input',e=>{
      p.checklist[i].text=e.target.value; p.updatedAt=losNow(); losDebouncedSave();
    });
    row.querySelector('.lifeos-ci-del').addEventListener('click',()=>{
      p.checklist.splice(i,1); p.updatedAt=losNow();
      losRenderChecklist(p); losUpdateProgress(p); losRenderList(); losDebouncedSave();
    });
    wrap.appendChild(row);
  });
}

// ── Add project ────────────────────────────────────────
function losAddProject(){
  const p={
    id:losGenId(), title:'New Project',
    category:_losCatFilter!=='All'?_losCatFilter:'Mind',
    notes:'', checklist:[], createdAt:losNow(), updatedAt:losNow()
  };
  _losProjects.unshift(p);
  _losCatFilter='All'; losBuildChips();
  losRenderList(); losSelect(p.id);
  setTimeout(()=>{ const t=document.getElementById('lifeos-det-title'); if(t){t.focus();t.select();} },50);
  losDebouncedSave();
}

// ── Delete project ─────────────────────────────────────
document.getElementById('lifeos-det-delete').addEventListener('click',()=>{
  if(!_losSelected) return;
  const p=_losProjects.find(x=>x.id===_losSelected);
  if(!p||!confirm('Delete "'+p.title.replace(/&lt;/g,'<')+'"?\nThis cannot be undone.')) return;
  _losProjects=_losProjects.filter(x=>x.id!==_losSelected);
  losShowEmpty(); losRenderList(); losDebouncedSave();
});

// ── Checklist add ──────────────────────────────────────
document.getElementById('lifeos-check-add-btn').addEventListener('click',losAddCheckItem);
document.getElementById('lifeos-check-inp').addEventListener('keydown',e=>{ if(e.key==='Enter') losAddCheckItem(); });
function losAddCheckItem(){
  if(!_losSelected) return;
  const inp=document.getElementById('lifeos-check-inp');
  const text=inp.value.trim(); if(!text) return;
  const p=_losProjects.find(x=>x.id===_losSelected); if(!p) return;
  if(!p.checklist) p.checklist=[];
  p.checklist.push({text,done:false});
  p.updatedAt=losNow(); inp.value='';
  losRenderChecklist(p); losUpdateProgress(p); losRenderList(); losDebouncedSave();
}

// ── Live field change listeners ────────────────────────
['lifeos-det-title','lifeos-det-cat','lifeos-det-notes'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    if(!_losSelected) return;
    const p=_losProjects.find(x=>x.id===_losSelected); if(!p) return;
    p.title    = document.getElementById('lifeos-det-title').value;
    p.category = document.getElementById('lifeos-det-cat').value;
    p.notes    = document.getElementById('lifeos-det-notes').value;
    p.updatedAt= losNow();
    losRenderList(); losDebouncedSave();
  });
});

// ── Search ─────────────────────────────────────────────
document.getElementById('lifeos-search').addEventListener('input',e=>{
  _losSearch=e.target.value; losRenderList();
});

// ══ SHEETS SYNC ════════════════════════════════════════
// Sheet: "LifeOS" tab in Cosmodex Trends spreadsheet
// Columns: A=id, B=title, C=category, D=notes, E=checklist(JSON), F=progress%, G=createdAt, H=updatedAt

async function losEnsureTab(){
  if(!accessToken) return null;
  const sid=await ensureSheet(); if(!sid) return null;
  try{
    const meta=await apiFetch(`${SHEETS_API}/${sid}?fields=sheets.properties`);
    const tabs=(meta.sheets||[]).map(s=>s.properties.title);
    if(!tabs.includes(LIFEOS_TAB)){
      await fetch(`${SHEETS_API}/${sid}:batchUpdate`,{
        method:'POST',
        headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
        body:JSON.stringify({requests:[{addSheet:{properties:{title:LIFEOS_TAB}}}]}),
      });
      // Write header row
      await fetch(`${SHEETS_API}/${sid}/values/${LIFEOS_TAB}!A1:H1?valueInputOption=RAW`,{
        method:'PUT',
        headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
        body:JSON.stringify({values:[['id','title','category','notes','checklist','progress%','createdAt','updatedAt']]}),
      });
    }
  }catch(e){ console.warn('LifeOS tab ensure failed:',e); return null; }
  return sid;
}

async function losLoad(showFeedback){
  if(!accessToken) return;
  if(showFeedback) showSyncBar('Loading Life OS…','syncing');
  try{
    const sid=await losEnsureTab(); if(!sid) return;
    const res=await apiFetch(`${SHEETS_API}/${sid}/values/${LIFEOS_TAB}!A2:H`);
    const rows=res.values||[];
    _losProjects=rows.filter(r=>r[0]&&r[1]).map(r=>({
      id:r[0]||'', title:r[1]||'', category:r[2]||'Other',
      notes:r[3]||'', checklist:losSafeJSON(r[4]||'[]',[]),
      createdAt:r[6]||losNow(), updatedAt:r[7]||losNow(),
    }));
    _losLoaded=true;
    losBuildChips(); losRenderList();
    if(_losSelected&&_losProjects.find(x=>x.id===_losSelected)) losSelect(_losSelected);
    else losShowEmpty();
    if(showFeedback) showSyncBar('Life OS synced ✓','ok');
  }catch(e){
    _losLoaded=true;
    losBuildChips(); losRenderList(); losShowEmpty();
    if(showFeedback) showSyncBar('⚠ Life OS sync failed','err');
  }
}

async function losSave(){
  if(!accessToken) return;
  try{
    const sid=await losEnsureTab(); if(!sid) return;
    // Clear data rows then rewrite all
    await fetch(`${SHEETS_API}/${sid}/values/${LIFEOS_TAB}!A2:H:clear`,{
      method:'POST', headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'}, body:'{}',
    });
    if(_losProjects.length){
      await fetch(`${SHEETS_API}/${sid}/values/${LIFEOS_TAB}!A2:H?valueInputOption=RAW`,{
        method:'PUT',
        headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
        body:JSON.stringify({values:_losProjects.map(p=>[
          p.id, p.title, p.category, p.notes,
          JSON.stringify(p.checklist||[]),
          losProg(p),
          p.createdAt||losNow(), p.updatedAt||losNow(),
        ])}),
      });
    }
    showSyncBar('Life OS saved ✓','ok');
  }catch(e){ showSyncBar('⚠ Life OS save failed','err'); }
}

function losDebouncedSave(){
  clearTimeout(_losSaveTimer);
  _losSaveTimer=setTimeout(losSave, 1200);
}

// ══ HABITS / ROUTINES / BEHAVIOURS ═══════════════════

const HABITS_KEY      = 'cdx_habits_v1';
const ROUTINES_KEY    = 'cdx_routines_v1';
const BEHAVIOURS_KEY  = 'cdx_behaviours_v1';

function habitsLoad(){ try{ return JSON.parse(localStorage.getItem(HABITS_KEY)||'[]'); }catch(e){ return []; } }
function habitsSave(d){ try{ localStorage.setItem(HABITS_KEY,JSON.stringify(d)); }catch(e){} }
function routinesLoad(){ try{ return JSON.parse(localStorage.getItem(ROUTINES_KEY)||'{"morning":[],"evening":[]}'); }catch(e){ return {morning:[],evening:[]}; } }
function routinesSave(d){ try{ localStorage.setItem(ROUTINES_KEY,JSON.stringify(d)); }catch(e){} }
function behavLoad(){ try{ return JSON.parse(localStorage.getItem(BEHAVIOURS_KEY)||'{"identity":"","keystone":[],"notes":""}'); }catch(e){ return {identity:'',keystone:[],notes:''}; } }
function behavSaveStore(d){ try{ localStorage.setItem(BEHAVIOURS_KEY,JSON.stringify(d)); }catch(e){} }

function localDateStr(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function last7Days(){
  const days=[]; const now=new Date();
  for(let i=6;i>=0;i--){ const d=new Date(now); d.setDate(now.getDate()-i); days.push(d); }
  return days;
}

function openHabits(){
  document.getElementById('habits-overlay').classList.add('open');
  switchHabitsTab('habits');
}
function closeHabits(){
  document.getElementById('habits-overlay').classList.remove('open');
}

function switchHabitsTab(tab){
  ['habits','routines','behaviours'].forEach(t=>{
    document.getElementById('htab-'+t).classList.toggle('active', t===tab);
    document.getElementById('hpane-'+t).style.display = t===tab ? 'flex' : 'none';
  });
  if(tab==='habits')      renderHabits();
  if(tab==='routines')    renderRoutines();
  if(tab==='behaviours')  renderBehaviours();
}

// ── HABITS TAB ──────────────────────────────────────
function renderHabits(){
  const habits = habitsLoad();
  const days   = last7Days();
  const todayStr = localDateStr(new Date());
  const DN = ['Su','Mo','Tu','We','Th','Fr','Sa'];

  // Day strip header
  const strip = document.getElementById('habits-day-strip');
  strip.innerHTML = '<div style="width:160px;flex-shrink:0"></div>' +
    days.map(d=>`<div class="habit-day-cell"><div class="habit-day-label${localDateStr(d)===todayStr?' today':''}">${DN[d.getDay()]}<br>${d.getDate()}</div></div>`).join('') +
    '<div style="width:56px;flex-shrink:0"></div>';

  // Habit rows
  const list = document.getElementById('habits-list');
  if(!habits.length){
    list.innerHTML='<div style="font-family:\'JetBrains Mono\',monospace;font-size:12px;color:var(--ink-dim);padding:16px 0">No habits yet — add one below.</div>';
    return;
  }
  list.innerHTML = habits.map((h,hi)=>{
    const checks = days.map((d,di)=>{
      const ds = localDateStr(d);
      const done = (h.log||[]).includes(ds);
      const isToday = ds===todayStr;
      return `<div class="habit-day-cell"><div class="habit-check-box${done?' done':''}${isToday?' today-col':''}" onclick="habitToggle(${hi},'${ds}')" title="${ds}">${done?'✓':''}</div></div>`;
    }).join('');
    const streak = habitsStreak(h);
    return `<div class="habit-row">
      <div class="habit-name">${escHtml(h.name)}</div>
      ${checks}
      <div class="habit-streak">${streak>0?streak+'d':''}</div>
      <button class="habit-del-btn" onclick="habitDelete(${hi})" title="Remove">&#8722;</button>
    </div>`;
  }).join('');
}

function escHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function habitsStreak(h){
  const log = h.log||[]; let s=0; const now=new Date();
  for(let i=0;;i++){
    const d=new Date(now); d.setDate(now.getDate()-i);
    if(log.includes(localDateStr(d))) s++; else break;
  }
  return s;
}

function habitToggle(hi, dateStr){
  const habits = habitsLoad();
  if(!habits[hi]) return;
  const log = habits[hi].log||[];
  const idx = log.indexOf(dateStr);
  if(idx>=0) log.splice(idx,1); else log.push(dateStr);
  habits[hi].log = log;
  habitsSave(habits);
  renderHabits();
}

function habitDelete(hi){
  const habits = habitsLoad();
  habits.splice(hi,1);
  habitsSave(habits);
  renderHabits();
}

function habitsAddNew(){
  const inp = document.getElementById('habit-new-inp');
  const name = inp.value.trim();
  if(!name) return;
  const habits = habitsLoad();
  habits.push({name, log:[]});
  habitsSave(habits);
  inp.value='';
  renderHabits();
}
document.addEventListener('keydown', e=>{
  if(document.getElementById('habits-overlay').classList.contains('open') && e.key==='Enter'){
    const focus = document.activeElement;
    if(focus && focus.id==='habit-new-inp') habitsAddNew();
    if(focus && focus.id==='routine-morning-inp') routineAdd('morning');
    if(focus && focus.id==='routine-evening-inp') routineAdd('evening');
    if(focus && focus.id==='behav-keystone-inp')  behavKeystoneAdd();
  }
});

// ── ROUTINES TAB ─────────────────────────────────────
function renderRoutines(){
  const data = routinesLoad();
  ['morning','evening'].forEach(slot=>{
    const list = document.getElementById('routines-'+slot+'-list');
    const items = data[slot]||[];
    if(!items.length){
      list.innerHTML=`<div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--ink-dim);padding:10px 0">No steps yet.</div>`;
      return;
    }
    list.innerHTML = items.map((item,i)=>`
      <div class="routine-item">
        <input class="routine-time-inp" value="${escHtml(item.time||'')}" placeholder="--:--" onchange="routineUpdate('${slot}',${i},'time',this.value)">
        <input class="routine-text-inp" value="${escHtml(item.text||'')}" placeholder="Step&#8230;" onchange="routineUpdate('${slot}',${i},'text',this.value)">
        <button class="habit-del-btn" onclick="routineDelete('${slot}',${i})">&#8722;</button>
      </div>`).join('');
  });
}

function routineAdd(slot){
  const timeEl = document.getElementById('routine-'+slot+'-time');
  const textEl = document.getElementById('routine-'+slot+'-inp');
  const text = textEl.value.trim(); if(!text) return;
  const data = routinesLoad();
  (data[slot]=data[slot]||[]).push({time:timeEl.value.trim(), text});
  routinesSave(data); textEl.value=''; timeEl.value='';
  renderRoutines();
}

function routineUpdate(slot,i,field,val){
  const data = routinesLoad();
  if(data[slot]&&data[slot][i]) data[slot][i][field]=val;
  routinesSave(data);
}

function routineDelete(slot,i){
  const data = routinesLoad();
  if(data[slot]) data[slot].splice(i,1);
  routinesSave(data); renderRoutines();
}

// ── BEHAVIOURS TAB ───────────────────────────────────
function renderBehaviours(){
  const data = behavLoad();
  document.getElementById('behav-identity').value = data.identity||'';
  document.getElementById('behav-notes').value    = data.notes||'';
  const list = document.getElementById('behav-keystone-list');
  const ks = data.keystone||[];
  if(!ks.length){
    list.innerHTML=`<div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--ink-dim);padding:10px 0">No keystone behaviours yet.</div>`;
  } else {
    list.innerHTML = ks.map((k,i)=>`
      <div class="habit-row">
        <div class="habit-name">${escHtml(k)}</div>
        <button class="habit-del-btn" onclick="behavKeystoneDelete(${i})">&#8722;</button>
      </div>`).join('');
  }
}

function behavSave(){
  const data = behavLoad();
  data.identity = document.getElementById('behav-identity').value;
  data.notes    = document.getElementById('behav-notes').value;
  behavSaveStore(data);
}

function behavKeystoneAdd(){
  const inp = document.getElementById('behav-keystone-inp');
  const val = inp.value.trim(); if(!val) return;
  const data = behavLoad();
  (data.keystone=data.keystone||[]).push(val);
  behavSaveStore(data); inp.value='';
  renderBehaviours();
}

function behavKeystoneDelete(i){
  const data = behavLoad();
  (data.keystone||[]).splice(i,1);
  behavSaveStore(data); renderBehaviours();
}
</script>

<!-- MOBILE BOTTOM NAV -->
<div id="mobile-nav">
  <button class="mob-nav-btn active" data-panel="panel-left" onclick="mobileSwitchPanel('panel-left',this)">
    <span class="mob-nav-icon">&#128197;</span>
    <span>Calendar</span>
  </button>
  <button class="mob-nav-btn" data-panel="panel-tasks" onclick="mobileSwitchPanel('panel-tasks',this)">
    <span class="mob-nav-icon">&#9745;</span>
    <span>Tasks</span>
  </button>
  <button class="mob-nav-btn" data-panel="panel-chrono" onclick="mobileSwitchPanel('panel-chrono',this)">
    <span class="mob-nav-icon">&#11044;</span>
    <span>Cosmodex</span>
  </button>
</div>

</body>
</html>
