<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chronodex Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }

[data-theme="dark"] {
  --bg:#0a0a08; --surface:#111110; --border:#2a2a26;
  --ink:#e8e4d8; --ink-dim:#7a7568; --ink-faint:#2e2d28;
  --gold:#c9a84c; --gold-dim:#6b5a2a;
  --red:#c44b3a; --blue:#4a7fa5; --green:#5a8f6a; --amber:#d4813a;
  --pomo-bg:#0f0f0d;
}
[data-theme="light"] {
  --bg:#f0eeeb; --surface:#ffffff; --border:#c8c4bc;
  --ink:#1c1f26; --ink-dim:#7a808c; --ink-faint:#e2e0dc;
  --gold:#8a6a28; --gold-dim:#b89848;
  --red:#b83228; --blue:#2e5c8a; --green:#2e6644; --amber:#c06820;
  --pomo-bg:#e8e6e2;
}

html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--ink); font-family:'Cormorant Garamond',serif; }
body { display:grid; grid-template-columns:1fr 1fr 1.8fr; height:100vh; }

.panel { border-right:2px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
.panel:last-child { border-right:none; }

/* HEADERS */
.panel-header { padding:12px 14px; border-bottom:2px solid var(--border); display:flex; align-items:center; gap:8px; flex-shrink:0; }
.panel-title { font-size:15px; letter-spacing:0.20em; text-transform:uppercase; color:var(--ink-dim); font-family:'JetBrains Mono',monospace; }
.panel-accent { width:6px; height:6px; border-radius:50%; background:var(--gold); animation:pulse 3s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* Add button */
.add-btn { margin-left:auto; background:none; border:2px solid var(--gold-dim); border-radius:5px; color:var(--gold); cursor:pointer; font-size:22px; line-height:1; padding:4px 10px; min-height:44px; min-width:44px; display:flex; align-items:center; justify-content:center; }
.add-btn:active { background:var(--gold-dim); }

/* Theme toggle */
.theme-btn { background:none; border:2px solid var(--border); border-radius:6px; padding:8px 14px; cursor:pointer; font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.08em; color:var(--ink-dim); display:flex; align-items:center; gap:8px; min-height:44px; }
.theme-btn:active { background:var(--ink-faint); }

/* View toggle */
.view-toggle { display:flex; gap:3px; background:var(--ink-faint); border-radius:6px; padding:3px; margin-left:auto; }
.view-btn { font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.06em; text-transform:uppercase; color:var(--ink-dim); background:none; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; min-height:44px; min-width:56px; }
.view-btn.active { background:var(--border); color:var(--gold); }

/* Nav arrows */
.nav-arrow { background:none; border:2px solid var(--border); border-radius:5px; color:var(--ink-dim); cursor:pointer; font-size:22px; padding:6px 12px; line-height:1; min-height:44px; min-width:48px; }
.nav-arrow:active { background:var(--ink-faint); }

/* ── TABS (shared by calendar + tasks panels) ── */
.tab-bar { display:flex; gap:0; border-bottom:2px solid var(--border); flex-shrink:0; overflow-x:auto; scrollbar-width:none; }
.tab-bar::-webkit-scrollbar { display:none; }
.tab { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.08em; text-transform:uppercase; color:var(--ink-dim); background:none; border:none; border-bottom:3px solid transparent; padding:9px 14px; cursor:pointer; white-space:nowrap; flex-shrink:0; min-height:40px; }
.tab.active { color:var(--gold); border-bottom-color:var(--gold); }
.tab-dot { display:inline-block; width:7px; height:7px; border-radius:50%; margin-right:6px; vertical-align:middle; }

/* DAY VIEW */
.daily-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.daily-top { display:flex; align-items:center; justify-content:space-between; padding:8px 14px; border-bottom:2px solid var(--ink-faint); flex-shrink:0; }
.daily-title-num { font-size:34px; font-weight:300; line-height:1; }
.daily-title-sub { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); letter-spacing:0.08em; margin-top:2px; }
.daily-timeline { flex:1; overflow-y:auto; scrollbar-width:none; }
.daily-timeline::-webkit-scrollbar { display:none; }
.hour-row { display:flex; min-height:40px; border-bottom:1.5px solid var(--ink-faint); }
.hour-row.hour-now { background:rgba(160,120,48,0.07); }
.hour-label { width:52px; flex-shrink:0; font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); padding:6px 6px 0; text-align:right; }
.hour-label.now-lbl { color:var(--gold); }
.hour-events { flex:1; padding:4px 8px; display:flex; flex-direction:column; gap:3px; }
.hour-event { font-size:16px; padding:4px 10px; border-radius:3px; cursor:pointer; border-left:4px solid; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* WEEK VIEW */
.week-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.week-nav { display:flex; align-items:center; justify-content:space-between; padding:5px 14px; flex-shrink:0; }
.week-range { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); }
.week-grid { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.week-day { flex:1; display:flex; align-items:stretch; border-bottom:1.5px solid var(--ink-faint); }
.week-day:last-child { border-bottom:none; }
.week-day.today { background:rgba(160,120,48,0.06); }
.day-label { width:54px; flex-shrink:0; display:flex; flex-direction:column; align-items:center; justify-content:center; border-right:2px solid var(--ink-faint); }
.day-name { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.08em; color:var(--ink-dim); text-transform:uppercase; }
.day-num { font-size:22px; font-weight:300; line-height:1; margin-top:2px; }
.week-day.today .day-num { color:var(--gold); font-weight:400; }
.day-events { flex:1; padding:3px 8px; display:flex; flex-direction:column; gap:2px; justify-content:center; overflow:hidden; }
.cal-event { display:flex; align-items:center; gap:6px; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.cal-event-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.cal-event-time { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); flex-shrink:0; }

/* MONTH VIEW */
.month-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.month-nav { display:flex; align-items:center; justify-content:space-between; padding:6px 14px 3px; flex-shrink:0; }
.month-title { font-size:22px; font-weight:300; }
.month-dow-row { display:grid; grid-template-columns:repeat(7,1fr); padding:0 6px; flex-shrink:0; }
.month-dow { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); text-align:center; padding:3px 0; text-transform:uppercase; }
.month-grid { flex:1; display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr; padding:0 6px 6px; gap:2px; overflow:hidden; }
.month-cell { display:flex; flex-direction:column; padding:3px 4px; border:2px solid transparent; border-radius:3px; min-height:0; }
.month-cell.today { border-color:var(--gold); background:rgba(160,120,48,0.07); }
.month-cell.other-month { opacity:0.22; }
.month-day-num { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); line-height:1.3; }
.month-cell.today .month-day-num { color:var(--gold); font-weight:400; }
.month-dots { display:flex; flex-wrap:wrap; gap:2px; margin-top:2px; }
.month-dot { width:6px; height:6px; border-radius:50%; }

/* CHRONODEX */
#panel-chrono { background:var(--bg); }
.chrono-wrapper { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:space-evenly; gap:0; padding:16px 20px 20px; width:100%; }
.time-display { text-align:center; }
.time-big { font-size:52px; font-weight:300; letter-spacing:-0.02em; line-height:1; font-variant-numeric:tabular-nums; }
.time-date { font-family:'JetBrains Mono',monospace; font-size:14px; color:var(--ink-dim); letter-spacing:0.10em; margin-top:2px; text-transform:uppercase; }
#chronodex-canvas { max-width:90%; display:block; pointer-events:none; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent; }
.chrono-canvas-wrap { position:relative; display:inline-block; max-width:100%; }
.chrono-tap-overlay { position:absolute; inset:0; cursor:pointer; user-select:none; -webkit-user-select:none; -webkit-tap-highlight-color:transparent; touch-action:manipulation; }
.next-strip { background:var(--ink-faint); border:2px solid var(--border); border-radius:3px; padding:12px 18px; width:100%; }
.next-lbl { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.18em; color:var(--ink-dim); text-transform:uppercase; margin-bottom:3px; }
.next-title { font-size:18px; font-weight:400; color:var(--gold); }
.next-time { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); margin-top:2px; }

/* EVENT PICKER */
#event-picker { position:fixed; z-index:500; display:none; background:var(--surface); border:2px solid var(--border); border-radius:6px; min-width:230px; max-width:320px; }
#event-picker.open { display:block; }
.picker-label { font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.15em; text-transform:uppercase; color:var(--ink-dim); padding:12px 16px 6px; }
.picker-item { display:flex; align-items:center; gap:12px; padding:12px 16px; cursor:pointer; border-top:1px solid var(--ink-faint); }
.picker-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.picker-text { flex:1; min-width:0; }
.picker-title { font-size:18px; font-weight:400; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.picker-time { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); margin-top:2px; }
.picker-divider { height:2px; background:var(--border); }
.picker-cancel { font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.12em; text-transform:uppercase; color:var(--ink-dim); padding:12px 16px; cursor:pointer; display:block; }

/* TASKS */
#panel-tasks { background:var(--surface); }
.tasks-list { flex:1; overflow-y:auto; padding:4px 0; scrollbar-width:none; }
.tasks-list::-webkit-scrollbar { display:none; }
.task-group-lbl { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.18em; color:var(--gold-dim); text-transform:uppercase; padding:8px 16px 4px; }
.task-item { display:flex; align-items:flex-start; gap:10px; padding:8px 16px; border-bottom:1.5px solid var(--ink-faint); cursor:pointer; }
.task-item.done { opacity:0.35; }
.task-check { width:20px; height:20px; border:2px solid var(--border); border-radius:3px; flex-shrink:0; margin-top:1px; display:flex; align-items:center; justify-content:center; }
.task-item.done .task-check { background:var(--gold-dim); border-color:var(--gold-dim); }
.task-item.done .task-check::after { content:'✓'; font-size:12px; color:var(--gold); }
.task-body { flex:1; min-width:0; }
.task-title { font-size:16px; line-height:1.4; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.task-item.done .task-title { text-decoration:line-through; }
.task-meta { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); margin-top:2px; }
.task-meta.overdue { color:var(--red); }
.task-meta.today-due { color:var(--amber); }
.task-pri { width:5px; align-self:stretch; border-radius:2px; flex-shrink:0; }
.pri-high{background:var(--red);} .pri-med{background:var(--amber);} .pri-low{background:var(--border);}
.tasks-footer { padding:8px 16px; border-top:2px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
.tasks-count { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); }

/* POMODORO */
#panel-pomo { display:none; } /* pomo is now an overlay */
.pomo-header { padding:12px 16px; border-bottom:2px solid var(--border); display:flex; align-items:center; gap:10px; flex-shrink:0; }
.pomo-header-title { font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.20em; text-transform:uppercase; color:var(--ink-dim); }
.pomo-close-btn { margin-left:auto; background:none; border:2px solid var(--border); border-radius:5px; color:var(--ink-dim); cursor:pointer; font-size:16px; padding:5px 10px; min-height:44px; min-width:44px; display:flex; align-items:center; justify-content:center; }
.pomo-close-btn:active { background:var(--ink-faint); }
.pomo-body { flex:1; display:flex; flex-direction:column; align-items:center; padding:14px 16px 16px; gap:12px; overflow-y:auto; scrollbar-width:none; }
.pomo-body::-webkit-scrollbar { display:none; }
.pomo-ev-label { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.18em; text-transform:uppercase; color:var(--ink-dim); text-align:center; }
.pomo-ev-title { font-size:20px; font-weight:300; color:var(--gold); text-align:center; line-height:1.3; width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.pomo-ring-wrap { position:relative; width:150px; height:150px; flex-shrink:0; }
#pomo-ring { position:absolute; inset:0; }
.pomo-center { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:none; }
.pomo-time { font-size:34px; font-weight:300; font-variant-numeric:tabular-nums; letter-spacing:-0.02em; line-height:1; }
.pomo-phase { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.15em; color:var(--ink-dim); text-transform:uppercase; margin-top:4px; }
.swipe-section { width:100%; }
.swipe-lbl { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.12em; color:var(--ink-dim); text-transform:uppercase; text-align:center; margin-bottom:8px; }
.swipe-control { display:flex; align-items:center; background:var(--ink-faint); border:2px solid var(--border); border-radius:5px; overflow:hidden; user-select:none; }
.swipe-minus,.swipe-plus { background:none; border:none; color:var(--ink-dim); cursor:pointer; padding:0 14px; height:52px; font-size:24px; display:flex; align-items:center; flex-shrink:0; min-width:48px; justify-content:center; }
.swipe-minus:active,.swipe-plus:active { background:var(--border); }
.swipe-track { flex:1; height:52px; position:relative; overflow:hidden; cursor:ew-resize; touch-action:none; }
.swipe-track-inner { width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; position:relative; }
.swipe-val { font-family:'JetBrains Mono',monospace; font-size:22px; color:var(--gold); line-height:1; pointer-events:none; }
.swipe-unit { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); pointer-events:none; margin-top:2px; }
.swipe-ticks { position:absolute; bottom:4px; left:0; right:0; display:flex; align-items:flex-end; justify-content:center; gap:2px; pointer-events:none; }
.tick { width:2px; border-radius:1px; background:var(--border); }
.tick.major { background:var(--gold-dim); }
.tick.current { background:var(--gold); width:3px; }
.pomo-btns { display:flex; gap:8px; width:100%; }
.pomo-btn { flex:1; padding:12px 0; font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.10em; text-transform:uppercase; border:2px solid var(--border); background:none; color:var(--ink-dim); cursor:pointer; border-radius:4px; min-height:48px; }
.pomo-btn.primary { background:var(--gold-dim); border-color:var(--gold); color:var(--gold); }
.pomo-btn.primary:active { background:var(--gold); color:var(--bg); }
.pomo-btn.danger { border-color:var(--red); color:var(--red); }
.pomo-btn.danger:active { background:rgba(196,75,58,0.15); }
.pomo-sess { display:flex; gap:8px; }
.sess-dot { width:13px; height:13px; border-radius:50%; border:2px solid var(--gold-dim); }
.sess-dot.done { background:var(--gold); border-color:var(--gold); }
.pomo-tip { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-faint); text-align:center; line-height:1.7; }

/* Light mode */
[data-theme="light"] #panel-left   { background:#ffffff; }
[data-theme="light"] #panel-chrono { background:#f0eeeb; }
[data-theme="light"] #panel-tasks  { background:#f7f6f3; }
[data-theme="light"] #panel-pomo   { background:#e8e6e2; }
[data-theme="light"] .next-strip   { background:#e2e0dc; }
[data-theme="light"] .swipe-control { background:#dedad4; }
[data-theme="light"] .task-group-lbl { color:#8a6a28; }

/* ══ SIGN-IN OVERLAY ══ */
#signin-overlay { position:fixed; inset:0; z-index:2000; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; }
#signin-overlay.hidden { display:none; }
.signin-logo { font-size:54px; opacity:0.6; }
.signin-title { font-family:'JetBrains Mono',monospace; font-size:22px; letter-spacing:0.22em; text-transform:uppercase; color:var(--ink); text-align:center; }
.signin-sub { font-family:'JetBrains Mono',monospace; font-size:14px; color:var(--ink-dim); text-align:center; line-height:1.8; }
.signin-btn { font-family:'JetBrains Mono',monospace; font-size:15px; letter-spacing:0.12em; text-transform:uppercase; padding:16px 36px; border-radius:6px; cursor:pointer; background:var(--gold-dim); border:2px solid var(--gold); color:var(--gold); min-height:56px; }
.signin-btn:active { background:var(--gold); color:var(--bg); }
.signin-note { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-faint); text-align:center; max-width:340px; line-height:1.8; }

/* ══ SYNC BAR ══ */
#sync-bar { position:fixed; bottom:0; left:0; right:0; z-index:1000; background:var(--surface); border-top:2px solid var(--border); padding:7px 16px; display:flex; align-items:center; gap:10px; font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); transform:translateY(100%); transition:transform 0.2s ease; }
#sync-bar.visible { transform:translateY(0); }
.sync-dot { width:7px; height:7px; border-radius:50%; background:var(--gold); animation:pulse 1.5s ease-in-out infinite; }
.sync-dot.ok { background:var(--green); animation:none; }
.sync-dot.err { background:var(--red); animation:none; }
#sync-user { margin-left:auto; color:var(--ink-faint); font-size:11px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px; }
.signout-btn { background:none; border:1px solid var(--border); border-radius:3px; color:var(--ink-dim); font-family:'JetBrains Mono',monospace; font-size:11px; padding:4px 10px; cursor:pointer; min-height:30px; }
.signout-btn:active { background:var(--ink-faint); }
.loading-msg { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--ink-dim); padding:20px 16px; }

/* ══ ADD ENTRY MODAL ══ */
.modal-backdrop { position:fixed; inset:0; z-index:900; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; }
.modal-backdrop.open { display:flex; }
.modal { background:var(--surface); border:2px solid var(--border); border-radius:8px; width:min(440px,95vw); max-height:90vh; overflow-y:auto; scrollbar-width:none; }
.modal::-webkit-scrollbar { display:none; }
.modal-header { padding:16px 20px 12px; border-bottom:2px solid var(--border); display:flex; align-items:center; gap:12px; }
.modal-title { font-family:'JetBrains Mono',monospace; font-size:14px; letter-spacing:0.18em; text-transform:uppercase; color:var(--ink); }
.modal-close { margin-left:auto; background:none; border:none; color:var(--ink-dim); cursor:pointer; font-size:20px; line-height:1; padding:4px 6px; min-height:36px; min-width:36px; }
.modal-body { padding:20px; display:flex; flex-direction:column; gap:16px; }
.field { display:flex; flex-direction:column; gap:6px; }
.field label { font-family:'JetBrains Mono',monospace; font-size:12px; letter-spacing:0.14em; text-transform:uppercase; color:var(--ink-dim); }
.field input, .field select, .field textarea {
  background:var(--ink-faint); border:2px solid var(--border); border-radius:4px;
  color:var(--ink); font-family:'JetBrains Mono',monospace; font-size:14px;
  padding:10px 12px; width:100%; outline:none; appearance:none;
}
.field input:focus, .field select:focus, .field textarea:focus { border-color:var(--gold); }
.field-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.modal-footer { padding:14px 20px 18px; border-top:2px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }
.modal-btn { font-family:'JetBrains Mono',monospace; font-size:13px; letter-spacing:0.10em; text-transform:uppercase; padding:12px 22px; border-radius:4px; cursor:pointer; border:2px solid var(--border); background:none; color:var(--ink-dim); min-height:46px; }
.modal-btn.primary { background:var(--gold-dim); border-color:var(--gold); color:var(--gold); }
.modal-btn.primary:active { background:var(--gold); color:var(--bg); }
.modal-btn:active { background:var(--ink-faint); }
.modal-saving { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--ink-dim); align-self:center; }


/* ── 24HR DAY VIEW ── */
.hour-row { display:flex; min-height:44px; border-bottom:1.5px solid var(--ink-faint); position:relative; }
.hour-row.hour-now { background:rgba(160,120,48,0.08); }
.hour-row.hour-past { opacity:0.55; }
.hour-row.drag-over { background:rgba(74,127,165,0.15); border-color:var(--blue); }
/* DRAG ── */
.task-item[draggable] { cursor:grab; }
.task-item.dragging { opacity:0.4; }
.drag-hint { font-size:16px; color:var(--ink-dim); margin-right:8px; align-self:center; flex-shrink:0; cursor:grab; }


/* ══ POMODORO OVERLAY ══ */
#pomo-overlay {
  display:none; position:fixed; z-index:800;
  /* covers tasks + chrono = right 2/3 of screen */
  left:calc(100% / 3); top:0; right:0; bottom:0;
  background:rgba(10,10,8,0.92);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  flex-direction:column;
  border-left:2px solid var(--border);
}
#pomo-overlay.open { display:flex; }
[data-theme="light"] #pomo-overlay { background:rgba(240,238,235,0.93); }

.pomo-overlay-inner {
  flex:1; display:flex; gap:0; overflow:hidden;
}

/* Left half of overlay = pomodoro */
.pomo-col {
  width:340px; flex-shrink:0;
  display:flex; flex-direction:column;
  border-right:2px solid var(--border);
  background:var(--pomo-bg);
  overflow-y:auto; scrollbar-width:none;
}
.pomo-col::-webkit-scrollbar { display:none; }

/* Right half = scribble canvas */
.scribble-col {
  flex:1; display:flex; flex-direction:column; overflow:hidden;
}
.scribble-header {
  padding:10px 16px; border-bottom:2px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0;
}
.scribble-title {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.16em; text-transform:uppercase; color:var(--ink-dim);
}
#scribble-canvas {
  flex:1; width:100%; cursor:crosshair;
  touch-action:none;
  -webkit-touch-callout:none;
  background:transparent;
}
.scribble-tools {
  display:flex; gap:8px; margin-left:auto; align-items:center;
}
.scribble-btn {
  background:none; border:1.5px solid var(--border); border-radius:4px;
  color:var(--ink-dim); cursor:pointer; font-family:'JetBrains Mono',monospace;
  font-size:11px; padding:5px 10px; min-height:32px;
}
.scribble-btn.active { border-color:var(--gold); color:var(--gold); }
.scribble-swatch {
  width:22px; height:22px; border-radius:50%; border:2px solid var(--border);
  cursor:pointer; flex-shrink:0;
}
.scribble-swatch.active { border-color:var(--gold); }
.stroke-size {
  display:flex; align-items:center; gap:6px;
  font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--ink-dim);
}
.stroke-size input { width:60px; accent-color:var(--gold); }

/* Locked overlay when pomo running */
#pomo-lock-msg {
  display:none; position:absolute; inset:0; z-index:50;
  align-items:center; justify-content:center; flex-direction:column; gap:16px;
  background:rgba(0,0,0,0.72);
}
#pomo-lock-msg.show { display:flex; }
.lock-text {
  font-family:'JetBrains Mono',monospace; font-size:14px;
  letter-spacing:0.12em; color:var(--ink); text-align:center; line-height:1.8;
}
.lock-withdraw {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.10em; text-transform:uppercase;
  padding:12px 28px; border-radius:4px; cursor:pointer;
  border:2px solid var(--red); color:var(--red); background:none;
  min-height:46px;
}
.lock-withdraw:active { background:rgba(196,75,58,0.15); }

/* Pomo overlay header */
.pomo-overlay-header {
  padding:11px 16px; border-bottom:2px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0;
}
.pomo-overlay-title {
  font-family:'JetBrains Mono',monospace; font-size:13px;
  letter-spacing:0.18em; text-transform:uppercase; color:var(--ink-dim);
}

/* Paper grain */
body::after { content:''; position:fixed; inset:0; pointer-events:none; opacity:0.25; z-index:998;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"); }
[data-theme="light"] body::after { opacity:0.10; }
</style>
</head>
<body>

<!-- COL 1: CALENDAR -->
<section class="panel" id="panel-left">
  <div class="panel-header">
    <span class="panel-title" id="left-title">Day View</span>
    <button class="add-btn" id="add-event-btn" title="Add event">+</button>
    <div class="view-toggle" style="margin-left:8px">
      <button class="view-btn active" data-view="day">Day</button>
      <button class="view-btn" data-view="week">Week</button>
      <button class="view-btn" data-view="month">Mon</button>
    </div>
  </div>
  <div class="tab-bar" id="cal-tab-bar" style="display:none"></div>
  <div id="left-content" style="flex:1;display:flex;flex-direction:column;overflow:hidden;"></div>
</section>

<!-- COL 2: TASKS -->
<section class="panel" id="panel-tasks">
  <div class="panel-header">
    <span class="panel-title">Tasks</span>
    <button class="add-btn" id="add-task-btn" title="Add task">+</button>
    <div class="panel-accent" style="margin-left:8px"></div>
  </div>
  <div class="tab-bar" id="task-tab-bar" style="display:none"></div>
  <div class="tasks-list" id="tasks-list"></div>
  <div class="tasks-footer">
    <span class="tasks-count" id="tasks-count"></span>
    <span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--ink-dim);">drag → cal</span>
  </div>
</section>

<!-- COL 3: CHRONODEX -->
<section class="panel" id="panel-chrono">
  <div class="panel-header">
    <span class="panel-title">Chronodex</span>
    <button class="add-btn" id="pomo-open-btn" title="Focus timer" style="border-color:var(--gold-dim)">&#9650;</button>
    <button class="theme-btn" id="theme-btn" style="margin-left:8px">
      <span id="theme-icon">☀</span><span id="theme-label">Light</span>
    </button>
  </div>
  <div class="chrono-wrapper">
    <div class="time-display">
      <div class="time-big" id="time-big">00:00</div>
      <div class="time-date" id="time-date"></div>
    </div>
    <div class="chrono-canvas-wrap">
      <canvas id="chronodex-canvas" width="520" height="520"></canvas>
      <div class="chrono-tap-overlay" id="chrono-overlay"></div>
    </div>
    <div class="next-strip">
      <div class="next-lbl">Next · 30 min</div>
      <div class="next-title" id="next-title">—</div>
      <div class="next-time" id="next-time"></div>
    </div>
  </div>
</section>

<!-- POMODORO + SCRIBBLE OVERLAY (covers tasks+chrono) -->
<div id="pomo-overlay">
  <div class="pomo-overlay-header">
    <span class="pomo-overlay-title">&#9650; Focus</span>
    <button class="pomo-close-btn" id="pomo-close" style="margin-left:auto">✕</button>
  </div>
  <div class="pomo-overlay-inner">
    <!-- Pomodoro col -->
    <div class="pomo-col">
      <div class="pomo-body">
        <div class="pomo-ev-label">Focus Session</div>
        <div class="pomo-ev-title" id="pomo-ev-title">—</div>
        <div class="pomo-ring-wrap">
          <canvas id="pomo-ring" width="150" height="150"></canvas>
          <div class="pomo-center">
            <div class="pomo-time" id="pomo-time">25:00</div>
            <div class="pomo-phase" id="pomo-phase">Ready</div>
          </div>
        </div>
        <div class="swipe-section">
          <div class="swipe-lbl">Duration</div>
          <div class="swipe-control">
            <button class="swipe-minus" id="sw-minus">−</button>
            <div class="swipe-track" id="sw-track">
              <div class="swipe-track-inner">
                <div class="swipe-val" id="sw-val">25</div>
                <div class="swipe-unit">minutes</div>
                <div class="swipe-ticks" id="sw-ticks"></div>
              </div>
            </div>
            <button class="swipe-plus" id="sw-plus">+</button>
          </div>
        </div>
        <div class="pomo-btns">
          <button class="pomo-btn danger" id="pomo-reset">Reset</button>
          <button class="pomo-btn primary" id="pomo-start">Start</button>
        </div>
        <div class="pomo-sess" id="pomo-sess">
          <div class="sess-dot"></div><div class="sess-dot"></div>
          <div class="sess-dot"></div><div class="sess-dot"></div>
        </div>
        <div class="pomo-tip">swipe · 1 min steps · hold +/− fast</div>
      </div>
    </div>
    <!-- Scribble col -->
    <div class="scribble-col">
      <div class="scribble-header">
        <span class="scribble-title">&#9998; Notes</span>
        <div class="scribble-tools">
          <div class="stroke-size">
            <span>size</span>
            <input type="range" id="stroke-size" min="1" max="24" value="3">
          </div>
          <div id="color-swatches" style="display:flex;gap:6px;align-items:center"></div>
          <button class="scribble-btn" id="scribble-eraser">Erase</button>
          <button class="scribble-btn" id="scribble-clear">Clear</button>
        </div>
      </div>
      <canvas id="scribble-canvas"></canvas>
    </div>
  </div>
  <!-- Lock screen shown when timer is running -->
  <div id="pomo-lock-msg">
    <div class="lock-text">Session in progress.<br>Stop the timer to close.</div>
    <button class="lock-withdraw" id="pomo-withdraw">Withdraw Session</button>
  </div>
</div>

</section>

<!-- SIGN-IN OVERLAY -->
<div id="signin-overlay">
  <div class="signin-logo">◷</div>
  <div class="signin-title">Chronodex</div>
  <div class="signin-sub">Your day, at a glance.<br>Sign in to load your calendar &amp; tasks.</div>
  <button class="signin-btn" id="signin-btn">Sign in with Google</button>
  <div class="signin-note">Calendar &amp; Tasks access (read + write).<br>No data stored anywhere.</div>
</div>

<!-- SYNC BAR -->
<div id="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-msg">Syncing…</span>
  <span id="sync-user"></span>
  <button class="signout-btn" id="signout-btn">Sign out</button>
</div>

<!-- EVENT PICKER (tap dial) -->
<div id="event-picker">
  <div class="picker-label">Start Pomodoro for</div>
  <div id="picker-items"></div>
  <div class="picker-divider"></div>
  <div class="picker-cancel" id="picker-cancel">Cancel</div>
</div>

<!-- ADD EVENT MODAL -->
<div class="modal-backdrop" id="modal-event">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Add Calendar Event</span>
      <button class="modal-close" id="modal-event-close">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Title</label>
        <input type="text" id="ev-title" placeholder="Event title" autocomplete="off">
      </div>
      <div class="field-row">
        <div class="field">
          <label>Date</label>
          <input type="date" id="ev-date">
        </div>
        <div class="field">
          <label>Calendar</label>
          <select id="ev-cal"></select>
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Start time</label>
          <input type="time" id="ev-start">
        </div>
        <div class="field">
          <label>Duration (min)</label>
          <input type="number" id="ev-dur" value="60" min="5" max="480" step="5">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span class="modal-saving" id="ev-saving" style="display:none">Saving…</span>
      <button class="modal-btn" id="ev-cancel">Cancel</button>
      <button class="modal-btn primary" id="ev-save">Add Event</button>
    </div>
  </div>
</div>

<!-- ADD TASK MODAL -->
<div class="modal-backdrop" id="modal-task">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Add Task</span>
      <button class="modal-close" id="modal-task-close">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Title</label>
        <input type="text" id="tk-title" placeholder="Task title" autocomplete="off">
      </div>
      <div class="field-row">
        <div class="field">
          <label>Due date (optional)</label>
          <input type="date" id="tk-date">
        </div>
        <div class="field">
          <label>Task list</label>
          <select id="tk-list"></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span class="modal-saving" id="tk-saving" style="display:none">Saving…</span>
      <button class="modal-btn" id="tk-cancel">Cancel</button>
      <button class="modal-btn primary" id="tk-save">Add Task</button>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════
//  GOOGLE API — Calendar + Tasks (read + write)
// ══════════════════════════════════════════════════════
const CLIENT_ID  = '663470287783-ljsv9gr282m780ue4mlbu6qoqulenk7u.apps.googleusercontent.com';
const SCOPES     = [
  'https://www.googleapis.com/auth/calendar.events',
  'https://www.googleapis.com/auth/tasks',
  'https://www.googleapis.com/auth/userinfo.email',
].join(' ');
const SCOPE_VER  = 'v2-rw';  // bump this whenever scopes change to force re-auth

// Local date helper — fixes UTC vs local timezone mismatch (critical for SGT UTC+8)
function localDate(d){
  const dt = d || new Date();
  return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
}
function localDatetime(d){
  // Returns YYYY-MM-DDTHH:MM in local time (for input[type=date/time] prefill)
  const dt = d || new Date();
  return localDate(dt)+'T'+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
}
function dtToLocal(apiStr){
  // Convert Google Calendar API datetime string to local YYYY-MM-DDTHH:MM
  // Handles both "2026-02-26T02:00:00Z" (UTC) and "2026-02-26T10:00:00+08:00" (offset)
  const d = new Date(apiStr);
  return localDate(d)+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
}
const CAL_API    = 'https://www.googleapis.com/calendar/v3';
const TASKS_API  = 'https://www.googleapis.com/tasks/v1';

// ── DATA ──────────────────────────────────────────────
let EVENTS       = [];  // all events
let TASKS        = [];  // all tasks
let CAL_LIST     = [];  // [{id, name, color}]  — all writable calendars
let TASK_LISTS   = [];  // [{id, title}]         — all task lists

// Tabs state
let activeCalTab  = 'all';   // calendarId or 'all'
let activeTaskTab = 'all';   // list id or 'all'

// Google colorId → theme colour
const GCAL_COLORS = {'1':'#4a7fa5','2':'#5a8f6a','3':'#5a8f6a','4':'#c44b3a','5':'#d4813a','6':'#d4813a','7':'#4a7fa5','8':'#7a7568','9':'#4a7fa5','10':'#5a8f6a','11':'#c9a84c'};

// ── AUTH ──────────────────────────────────────────────
let accessToken = null, tokenExpiry = 0, tokenClient = null, currentUser = '';

try {
  const s = JSON.parse(sessionStorage.getItem('cdx_tok') || 'null');
  if (s && s.expiry > Date.now() + 90000 && s.sv === SCOPE_VER) {
    accessToken = s.token; tokenExpiry = s.expiry; currentUser = s.user||'';
  } else if (s) {
    // Stale or wrong-scope token — wipe it so user gets prompted with new scopes
    sessionStorage.removeItem('cdx_tok');
  }
} catch(e){}

function saveSession(){ try{ sessionStorage.setItem('cdx_tok', JSON.stringify({token:accessToken,expiry:tokenExpiry,user:currentUser,sv:SCOPE_VER})); }catch(e){} }
function clearSession(){ accessToken=null;tokenExpiry=0;currentUser=''; try{sessionStorage.removeItem('cdx_tok');}catch(e){} }

function initGIS(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES,
    callback: async (resp) => {
      if(resp.error){ showSyncBar('Auth error: '+resp.error,'err'); return; }
      accessToken = resp.access_token;
      tokenExpiry  = Date.now() + (resp.expires_in - 60)*1000;
      await fetchUserInfo(); saveSession();
      document.getElementById('signin-overlay').classList.add('hidden');
      document.getElementById('sync-user').textContent = currentUser;
      await loadAllData();
    },
  });
}

async function fetchUserInfo(){
  try{ const r=await apiFetch('https://www.googleapis.com/oauth2/v2/userinfo'); currentUser=r.email||''; }catch(e){}
}

function requestToken(){ if(!tokenClient){showSyncBar('GIS loading — try again shortly','err');return;} tokenClient.requestAccessToken({prompt:'consent'}); }

function signOut(){
  if(accessToken) try{google.accounts.oauth2.revoke(accessToken,()=>{});}catch(e){}
  clearSession(); EVENTS=[];TASKS=[];CAL_LIST=[];TASK_LISTS=[];
  renderLeft();buildTasks();updateClock();drawChronodex();
  document.getElementById('signin-overlay').classList.remove('hidden');
  document.getElementById('sync-bar').classList.remove('visible');
}

document.getElementById('signin-btn').addEventListener('click', requestToken);
document.getElementById('signout-btn').addEventListener('click', signOut);

// ── SYNC BAR ──────────────────────────────────────────
let _st=null;
function showSyncBar(msg,state){
  document.getElementById('sync-msg').textContent=msg;
  document.getElementById('sync-dot').className='sync-dot'+(state==='ok'?' ok':state==='err'?' err':'');
  document.getElementById('sync-bar').classList.add('visible');
  clearTimeout(_st);
  if(state==='ok') _st=setTimeout(()=>document.getElementById('sync-bar').classList.remove('visible'),3500);
}

// ── API HELPER ────────────────────────────────────────
async function apiFetch(url, params, opts){
  if(!accessToken) throw new Error('not_authenticated');
  if(Date.now()>tokenExpiry){ clearSession(); throw new Error('token_expired'); }
  const qs = params ? '?'+new URLSearchParams(params) : '';
  const r = await fetch(url+qs, { headers:{Authorization:'Bearer '+accessToken}, ...opts });
  if(r.status===401){ clearSession(); throw new Error('token_expired'); }
  if(!r.ok) throw new Error('HTTP '+r.status);
  if(r.status===204||r.headers.get('content-length')==='0') return {};
  return r.json();
}
async function apiPost(url, body){
  if(!accessToken) throw new Error('not_authenticated');
  if(Date.now()>tokenExpiry){ clearSession(); throw new Error('token_expired'); }
  const r = await fetch(url, { method:'POST', headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'}, body:JSON.stringify(body) });
  if(r.status===401){ clearSession(); throw new Error('token_expired'); }
  if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+': '+t.slice(0,120)); }
  return r.json();
}

// ── FETCH CALENDAR LIST ───────────────────────────────
async function fetchCalList(){
  const res = await apiFetch(CAL_API+'/users/me/calendarList');
  const palette = ['#4a7fa5','#5a8f6a','#c9a84c','#c44b3a','#d4813a'];
  CAL_LIST = (res.items||[]).filter(c=>c.selected!==false).map((c,i)=>({
    id:       c.id,
    name:     c.summary||'Calendar',
    color:    c.backgroundColor || palette[i%palette.length],
    isPrimary: c.primary === true,
  }));
}

function evColor(gcalEv, calId){
  if(gcalEv.colorId) return GCAL_COLORS[gcalEv.colorId]||'#c9a84c';
  const cal = CAL_LIST.find(c=>c.id===calId);
  return cal ? cal.color : '#4a7fa5';
}

// ── FETCH EVENTS ──────────────────────────────────────
async function fetchEvents(){
  const now=new Date();
  const tMin=new Date(now); tMin.setDate(now.getDate()-3);
  const tMax=new Date(now); tMax.setDate(now.getDate()+14);
  const all=[];
  await Promise.all(CAL_LIST.map(async cal=>{
    try{
      const resp=await apiFetch(CAL_API+'/calendars/'+encodeURIComponent(cal.id)+'/events',{
        timeMin:tMin.toISOString(), timeMax:tMax.toISOString(),
        singleEvents:'true', orderBy:'startTime', maxResults:'500',
        fields:'items(id,summary,start,end,colorId,status)',
      });
      (resp.items||[]).forEach(ev=>{
        if(ev.status==='cancelled') return;
        const startISO=dtToLocal(ev.start.dateTime||ev.start.date+'T00:00:00');
        const endISO  =dtToLocal(ev.end.dateTime  ||ev.end.date  +'T00:00:00');
        all.push({ title:(ev.summary||'(No title)').replace(/</g,'&lt;'), startISO, endISO, color:evColor(ev,cal.id), calId:cal.id, calName:cal.name });
      });
    }catch(e){}
  }));
  all.sort((a,b)=>a.startISO.localeCompare(b.startISO));
  EVENTS=all;
}

// ── FETCH TASKS ───────────────────────────────────────
async function fetchTasks(){
  const res=await apiFetch(TASKS_API+'/users/@me/lists',{maxResults:'20'});
  TASK_LISTS=(res.items||[]).map(t=>({id:t.id,title:t.title||'Tasks'}));
  const today=localDate();
  const all=[];
  await Promise.all(TASK_LISTS.map(async tl=>{
    try{
      const r=await apiFetch(TASKS_API+'/lists/'+tl.id+'/tasks',{showCompleted:'false',showHidden:'false',maxResults:'100',fields:'items(id,title,due,status)'});
      (r.items||[]).forEach(t=>{
        if(!t.title||!t.title.trim()) return;
        const due=t.due?t.due.slice(0,10):null;
        const d=due?(new Date(due)-new Date(today))/86400000:null;
        const priority=d===null?'low':d<=0?'high':d<=2?'high':d<=7?'med':'low';
        all.push({title:t.title.replace(/</g,'&lt;'),due,done:false,priority,_id:t.id,_list:tl.id,_listName:tl.title});
      });
    }catch(e){}
  }));
  all.sort((a,b)=>{if(!a.due&&!b.due)return 0;if(!a.due)return 1;if(!b.due)return -1;return a.due.localeCompare(b.due);});
  TASKS=all;
}

// ── LOAD ALL ──────────────────────────────────────────
async function loadAllData(){
  showSyncBar('Syncing\u2026','syncing');
  try{
    await fetchCalList();
    await Promise.all([fetchEvents(),fetchTasks()]);
    buildCalTabs(); buildTaskTabs();
    renderLeft(); buildTasks(); updateClock(); drawChronodex();
    const t=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    showSyncBar('Synced \u00b7 '+t,'ok');
  }catch(err){
    if(err.message==='token_expired'||err.message==='not_authenticated'){
      clearSession(); document.getElementById('signin-overlay').classList.remove('hidden');
      document.getElementById('sync-bar').classList.remove('visible'); return;
    }
    showSyncBar('\u26a0 '+err.message,'err');
    renderLeft(); buildTasks(); updateClock(); drawChronodex();
  }
}

// ── TABS ──────────────────────────────────────────────
function buildCalTabs(){
  const bar=document.getElementById('cal-tab-bar');
  if(CAL_LIST.length<=1){bar.style.display='none';activeCalTab='all';return;}
  bar.style.display='flex';
  bar.innerHTML='';
  const all=document.createElement('button'); all.className='tab'+(activeCalTab==='all'?' active':''); all.textContent='All'; all.onclick=()=>{activeCalTab='all';buildCalTabs();renderLeft();};
  bar.appendChild(all);
  CAL_LIST.forEach(cal=>{
    const t=document.createElement('button'); t.className='tab'+(activeCalTab===cal.id?' active':'');
    t.innerHTML='<span class="tab-dot" style="background:'+cal.color+'"></span>'+cal.name;
    t.onclick=()=>{activeCalTab=cal.id;buildCalTabs();renderLeft();};
    bar.appendChild(t);
  });
}

function buildTaskTabs(){
  const bar=document.getElementById('task-tab-bar');
  if(TASK_LISTS.length<=1){bar.style.display='none';activeTaskTab='all';return;}
  bar.style.display='flex';
  bar.innerHTML='';
  const all=document.createElement('button'); all.className='tab'+(activeTaskTab==='all'?' active':''); all.textContent='All'; all.onclick=()=>{activeTaskTab='all';buildTaskTabs();buildTasks();};
  bar.appendChild(all);
  TASK_LISTS.forEach(tl=>{
    const t=document.createElement('button'); t.className='tab'+(activeTaskTab===tl.id?' active':'');
    t.textContent=tl.title;
    t.onclick=()=>{activeTaskTab=tl.id;buildTaskTabs();buildTasks();};
    bar.appendChild(t);
  });
}

function filteredEvents(){
  return activeCalTab==='all' ? EVENTS : EVENTS.filter(e=>e.calId===activeCalTab);
}

function filteredTasks(){
  return activeTaskTab==='all' ? TASKS : TASKS.filter(t=>t._list===activeTaskTab);
}

// ── THEME ─────────────────────────────────────────────
let isDark=true;
document.getElementById('theme-btn').addEventListener('click',()=>{
  isDark=!isDark;
  document.documentElement.setAttribute('data-theme',isDark?'dark':'light');
  document.getElementById('theme-icon').textContent=isDark?'☀':'☾';
  document.getElementById('theme-label').textContent=isDark?'Light':'Dark';
  drawChronodex(); drawPomoRing();
});

// ── VIEW STATE ────────────────────────────────────────
let currentView='day',dayOff=0,weekOff=0,monthOff=0;
document.querySelectorAll('.view-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); currentView=btn.dataset.view; dayOff=weekOff=monthOff=0; renderLeft();
  });
});
function renderLeft(){
  document.getElementById('left-title').textContent={day:'Day View',week:'Week View',month:'Month View'}[currentView];
  ({day:buildDay,week:buildWeek,month:buildMonth})[currentView]();
}

// ── DAY VIEW ──────────────────────────────────────────
function buildDay(){
  const now=new Date(),d=new Date(now); d.setDate(now.getDate()+dayOff);
  const ds=localDate(d),isToday=ds===localDate(now);
  const DN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const MN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const evts=filteredEvents().filter(e=>e.startISO.startsWith(ds));
  const nowH=now.getHours(), nowM=now.getMinutes();
  document.getElementById('left-content').innerHTML=
    '<div class="daily-view">'+
    '<div class="daily-top">'+
    '<button class="nav-arrow" id="d-prev">&#8249;</button>'+
    '<div style="text-align:center"><div class="daily-title-num">'+d.getDate()+'</div>'+
    '<div class="daily-title-sub">'+DN[d.getDay()].toUpperCase()+' &middot; '+MN[d.getMonth()].toUpperCase()+' '+d.getFullYear()+'</div></div>'+
    '<button class="nav-arrow" id="d-next">&#8250;</button>'+
    '</div>'+
    '<div class="daily-timeline" id="d-tl"></div>'+
    '</div>';
  document.getElementById('d-prev').onclick=()=>{dayOff--;buildDay();};
  document.getElementById('d-next').onclick=()=>{dayOff++;buildDay();};
  const tl=document.getElementById('d-tl');

  // Full 24 hours
  for(let hr=0;hr<24;hr++){
    const isNow=isToday&&hr===nowH;
    const isPast=isToday&&hr<nowH;
    const row=document.createElement('div');
    row.className='hour-row'+(isNow?' hour-now':'')+(isPast?' hour-past':'');
    row.dataset.hour=hr;
    // Drop-zone for tasks
    row.addEventListener('dragover',e=>{e.preventDefault();row.classList.add('drag-over');});
    row.addEventListener('dragleave',()=>row.classList.remove('drag-over'));
    row.addEventListener('drop',e=>{
      e.preventDefault(); row.classList.remove('drag-over');
      const data=JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
      if(data.taskTitle) createEventFromTask(data.taskTitle,data.taskId,data.listId,ds,hr);
    });

    const lbl=document.createElement('div');
    lbl.className='hour-label'+(isNow?' now-lbl':'');
    lbl.textContent=String(hr).padStart(2,'0')+':00';

    const evDiv=document.createElement('div'); evDiv.className='hour-events';

    // Current time indicator line
    if(isNow){
      const pct=(nowM/60)*100;
      const line=document.createElement('div');
      line.style.cssText='position:absolute;left:0;right:0;top:'+pct+'%;height:2px;background:var(--red);opacity:0.7;pointer-events:none;z-index:2;';
      evDiv.style.position='relative';
      evDiv.appendChild(line);
    }

    evts.filter(e=>new Date(e.startISO).getHours()===hr).forEach(ev=>{
      const dur=Math.round((new Date(ev.endISO)-new Date(ev.startISO))/60000);
      const startM=new Date(ev.startISO).getMinutes();
      const el=document.createElement('div'); el.className='hour-event';
      const topPct=(startM/60)*100;
      const heightPct=Math.max(8,(dur/60)*100);
      el.style.cssText='border-color:'+ev.color+';background:'+ev.color+'28;position:relative;margin-top:'+topPct+'%;';
      const tStr=String(new Date(ev.startISO).getHours()).padStart(2,'0')+':'+String(startM).padStart(2,'0');
      el.innerHTML='<span style="font-size:11px;font-family:JetBrains Mono,monospace;color:var(--ink-dim)">'+tStr+'</span> '+ev.title+(dur>0?' <span style="color:var(--ink-dim);font-size:12px">'+dur+'m</span>':'');
      el.addEventListener('click',()=>openPomo(ev)); evDiv.appendChild(el);
    });

    row.appendChild(lbl); row.appendChild(evDiv); tl.appendChild(row);
  }

  // Scroll to current hour (or 8am if not today)
  const scrollTo=isToday?Math.max(0,nowH-1):8;
  const rows=tl.querySelectorAll('.hour-row');
  if(rows[scrollTo]) setTimeout(()=>rows[scrollTo].scrollIntoView({block:'start'}),50);
}

// Create a calendar event from a dragged task
async function createEventFromTask(title, taskId, listId, dateStr, hour){
  if(!accessToken){showSyncBar('Sign in to add events','err');return;}
  const calId = CAL_LIST.find(c=>c.isPrimary)?.id || CAL_LIST[0]?.id;
  if(!calId){showSyncBar('No calendar found','err');return;}
  const start=new Date(dateStr+'T'+String(hour).padStart(2,'0')+':00:00');
  const end  =new Date(start.getTime()+60*60000); // 1 hour default
  try{
    await apiPost(CAL_API+'/calendars/'+encodeURIComponent(calId)+'/events',{
      summary: title,
      start:{dateTime: start.toISOString()},
      end:  {dateTime: end.toISOString()},
    });
    showSyncBar('Added "'+title+'" to calendar','ok');
    await loadAllData();
  }catch(err){showSyncBar('Failed: '+err.message,'err');}
}

// ── WEEK VIEW ─────────────────────────────────────────
function buildWeek(){
  const now=new Date(),base=new Date(now); base.setDate(now.getDate()+weekOff*7);
  const dow=base.getDay(),mon=new Date(base); mon.setDate(base.getDate()-((dow+6)%7));
  const sun=new Date(mon); sun.setDate(mon.getDate()+6);
  const M=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmt=d=>d.getDate()+' '+M[d.getMonth()];
  const DN=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],todayStr=localDate(now);
  document.getElementById('left-content').innerHTML=
    '<div class="week-view"><div class="week-nav">'+
    '<button class="nav-arrow" id="w-prev">&#8249;</button>'+
    '<span class="week-range">'+fmt(mon)+' \u2013 '+fmt(sun)+'</span>'+
    '<button class="nav-arrow" id="w-next">&#8250;</button></div>'+
    '<div class="week-grid" id="w-grid"></div></div>';
  document.getElementById('w-prev').onclick=()=>{weekOff--;buildWeek();};
  document.getElementById('w-next').onclick=()=>{weekOff++;buildWeek();};
  const grid=document.getElementById('w-grid');
  for(let i=0;i<7;i++){
    const d=new Date(mon); d.setDate(mon.getDate()+i);
    const ds=localDate(d),isToday=ds===todayStr;
    const dayEvts=filteredEvents().filter(e=>e.startISO.startsWith(ds)).sort((a,b)=>a.startISO.localeCompare(b.startISO));
    const row=document.createElement('div'); row.className='week-day'+(isToday?' today':'');
    row.innerHTML='<div class="day-label"><span class="day-name">'+DN[i]+'</span><span class="day-num">'+d.getDate()+'</span></div><div class="day-events" id="de'+i+'"></div>';
    grid.appendChild(row);
    const evDiv=row.querySelector('#de'+i);
    if(!dayEvts.length){evDiv.innerHTML='<span style="font-size:14px;color:var(--ink-faint);font-style:italic">clear</span>';}
    dayEvts.slice(0,3).forEach(e=>{
      const t=new Date(e.startISO).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
      const el=document.createElement('div'); el.className='cal-event';
      el.innerHTML='<span class="cal-event-dot" style="background:'+e.color+'"></span><span class="cal-event-time">'+t+'</span><span style="overflow:hidden;text-overflow:ellipsis">'+e.title+'</span>';
      evDiv.appendChild(el);
    });
    if(dayEvts.length>3){const m=document.createElement('div');m.style.cssText='font-family:JetBrains Mono,monospace;font-size:12px;color:var(--ink-dim);padding-left:13px;';m.textContent='+'+(dayEvts.length-3)+' more';evDiv.appendChild(m);}
  }
}

// ── MONTH VIEW ────────────────────────────────────────
function buildMonth(){
  const now=new Date(),ref=new Date(now.getFullYear(),now.getMonth()+monthOff,1);
  const MN=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const dim=new Date(ref.getFullYear(),ref.getMonth()+1,0).getDate();
  let fd=ref.getDay(); fd=fd===0?6:fd-1;
  const prevDim=new Date(ref.getFullYear(),ref.getMonth(),0).getDate(),todayStr=localDate(now);
  document.getElementById('left-content').innerHTML=
    '<div class="month-view"><div class="month-nav">'+
    '<button class="nav-arrow" id="m-prev">&#8249;</button>'+
    '<span class="month-title">'+MN[ref.getMonth()]+' '+ref.getFullYear()+'</span>'+
    '<button class="nav-arrow" id="m-next">&#8250;</button></div>'+
    '<div class="month-dow-row">'+['M','T','W','T','F','S','S'].map(x=>'<div class="month-dow">'+x+'</div>').join('')+'</div>'+
    '<div class="month-grid" id="m-grid"></div></div>';
  document.getElementById('m-prev').onclick=()=>{monthOff--;buildMonth();};
  document.getElementById('m-next').onclick=()=>{monthOff++;buildMonth();};
  const grid=document.getElementById('m-grid');
  for(let i=fd-1;i>=0;i--){const c=document.createElement('div');c.className='month-cell other-month';c.innerHTML='<div class="month-day-num">'+(prevDim-i)+'</div>';grid.appendChild(c);}
  for(let d=1;d<=dim;d++){
    const ds=ref.getFullYear()+'-'+String(ref.getMonth()+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const isToday=ds===todayStr, de=filteredEvents().filter(e=>e.startISO.startsWith(ds));
    const c=document.createElement('div'); c.className='month-cell'+(isToday?' today':'');
    c.innerHTML='<div class="month-day-num">'+d+'</div><div class="month-dots">'+de.slice(0,5).map(e=>'<div class="month-dot" style="background:'+e.color+'"></div>').join('')+'</div>';
    grid.appendChild(c);
  }
  const total=fd+dim,rem=total%7===0?0:7-(total%7);
  for(let d=1;d<=rem;d++){const c=document.createElement('div');c.className='month-cell other-month';c.innerHTML='<div class="month-day-num">'+d+'</div>';grid.appendChild(c);}
}

// ── CHRONODEX ─────────────────────────────────────────
// Petal layout: 5am-midnight, 19 petals, growing outward.
// - Empty petals: thin border outline only (no fill)
// - Elapsed time: thick radial arc LINE per petal, not fill
// - Events: solid color fill in their exact petal fraction
// - Labels: outside petals, rotated so text goes petal->outward
// - Crisp: canvas scaled by devicePixelRatio

const H_START  = 5;
const H_END    = 24;
const CHOURS   = H_END - H_START;   // 19
const PETAL_DEG = 360 / CHOURS;
const PETAL_RAD = PETAL_DEG * Math.PI / 180;
const RI_BASE  = 30;
const RO_MIN   = 56;
const RO_MAX   = 220;

function petalRI()  { return RI_BASE; }
function petalRO(i) { return RO_MIN + i * (RO_MAX - RO_MIN) / (CHOURS - 1); }
function hourAngle(i, frac) { return -Math.PI/2 + (i + frac) * PETAL_RAD; }
function petalMid(i) { return hourAngle(i, 0.5); }

let todayEventsForPicker = [];

function initHiDPI(cv) {
  const dpr = window.devicePixelRatio || 1;
  const rect = cv.getBoundingClientRect();
  const logW = cv.width, logH = cv.height;
  cv.width  = logW * dpr;
  cv.height = logH * dpr;
  cv.style.width  = logW + 'px';
  cv.style.height = logH + 'px';
  const ctx = cv.getContext('2d');
  ctx.scale(dpr, dpr);
  return { ctx, W:logW, H:logH, dpr };
}

function drawChronodex() {
  const cv = document.getElementById('chronodex-canvas');
  const dpr = window.devicePixelRatio || 1;
  // Only re-init if needed (size changed or first draw)
  if (!cv._cdxInit) {
    const lw = parseInt(cv.getAttribute('width'));
    const lh = parseInt(cv.getAttribute('height'));
    cv.width  = lw * dpr;
    cv.height = lh * dpr;
    cv.style.width  = lw + 'px';
    cv.style.height = lh + 'px';
    cv._cdxInit = true;
  }
  const ctx = cv.getContext('2d');
  const LW = parseInt(cv.style.width)  || 520;
  const LH = parseInt(cv.style.height) || 520;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, LW, LH);
  todayEventsForPicker = [];

  const dark    = isDark;
  const needleC = dark ? '#c44b3a' : '#b83228';
  const hubC    = dark ? '#c9a84c' : '#8a6a28';
  const borderC = dark ? 'rgba(255,255,255,0.13)' : 'rgba(28,31,38,0.15)';
  const tickC   = dark ? 'rgba(255,255,255,0.18)' : 'rgba(28,31,38,0.18)';
  const elapsedC= dark ? 'rgba(201,168,76,0.70)'  : 'rgba(138,106,40,0.65)';
  const lblC    = dark ? 'rgba(232,228,216,0.82)'  : 'rgba(28,31,38,0.88)';
  const cx = LW/2, cy = LH/2;
  const GAP = 0.020;

  const now   = new Date();
  const tm    = now.getHours()*60 + now.getMinutes();
  const today = localDate(now);
  const te    = EVENTS.filter(e => e.startISO.startsWith(today));
  todayEventsForPicker = te;

  // ── 1. Petal outlines only (no fill for empty petals) ──
  for (let i = 0; i < CHOURS; i++) {
    const ri = petalRI(), ro = petalRO(i);
    const a0 = hourAngle(i, 0), a1 = hourAngle(i, 1);
    ctx.beginPath();
    ctx.arc(cx, cy, ro, a0 + GAP, a1 - GAP);
    ctx.arc(cx, cy, ri, a1 - GAP, a0 + GAP, true);
    ctx.closePath();
    ctx.strokeStyle = borderC;
    ctx.lineWidth = 1;
    ctx.stroke();

    // 30-min tick (small radial line inside petal near inner edge)
    const amid = hourAngle(i, 0.5);
    const t0 = ri + 3, t1 = ri + 3 + Math.min(8, (ro - ri) * 0.18);
    ctx.beginPath();
    ctx.moveTo(cx + t0 * Math.cos(amid), cy + t0 * Math.sin(amid));
    ctx.lineTo(cx + t1 * Math.cos(amid), cy + t1 * Math.sin(amid));
    ctx.strokeStyle = tickC;
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // ── 2. Elapsed time: thick arc line per completed/partial petal ──
  for (let i = 0; i < CHOURS; i++) {
    const hAbs = H_START + i;
    const hMin = hAbs * 60, hMax = (hAbs + 1) * 60;
    if (tm <= hMin) continue;
    const frac = Math.min((tm - hMin) / 60, 1);
    const ri = petalRI(), ro = petalRO(i);
    const rMid = (ri + ro) / 2;
    const a0 = hourAngle(i, 0), a1 = hourAngle(i, frac);
    // Thick arc line at petal midpoint radius
    ctx.beginPath();
    ctx.arc(cx, cy, rMid, a0 + GAP * 0.5, a1);
    ctx.strokeStyle = elapsedC;
    ctx.lineWidth = Math.min(ro - ri - 4, 18);
    ctx.lineCap = 'round';
    ctx.stroke();
  }

  // ── 3. Event fills ──
  te.forEach(ev => {
    const sm = new Date(ev.startISO).getHours() * 60 + new Date(ev.startISO).getMinutes();
    const em = new Date(ev.endISO).getHours()   * 60 + new Date(ev.endISO).getMinutes();
    if (em <= H_START * 60 || sm >= H_END * 60) return;
    const isPast    = em <= tm;
    const isCurrent = sm <= tm && em > tm;
    const alpha = isPast ? 0.20 : isCurrent ? 0.92 : 0.75;

    for (let i = 0; i < CHOURS; i++) {
      const hAbs = H_START + i;
      const hMin = hAbs * 60, hMax = (hAbs + 1) * 60;
      const os = Math.max(sm, hMin), oe = Math.min(em, hMax);
      if (oe <= os) continue;
      const f0 = (os - hMin) / 60, f1 = (oe - hMin) / 60;
      const ri = petalRI() + 2, ro = petalRO(i) - 2;
      const a0 = hourAngle(i, f0), a1 = hourAngle(i, f1);
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.beginPath();
      ctx.arc(cx, cy, ro, a0 + GAP * 0.4, a1 - GAP * 0.4);
      ctx.arc(cx, cy, ri, a1 - GAP * 0.4, a0 + GAP * 0.4, true);
      ctx.closePath();
      ctx.fillStyle = ev.color;
      ctx.fill();
      ctx.globalAlpha = isPast ? 0.15 : 0.80;
      ctx.strokeStyle = ev.color;
      ctx.lineWidth = isCurrent ? 2.5 : 1.5;
      ctx.stroke();
      ctx.restore();
    }
  });

  // ── 4. Event labels — outside petals, no overlap ──
  // Sort by bestI so labels at same petal stack in order
  const labelItems = [];
  te.forEach(ev => {
    const sm = new Date(ev.startISO).getHours() * 60 + new Date(ev.startISO).getMinutes();
    const em = new Date(ev.endISO).getHours()   * 60 + new Date(ev.endISO).getMinutes();
    if (em <= H_START * 60 || sm >= H_END * 60) return;
    let bestI = -1, bestOv = 0;
    for (let i = 0; i < CHOURS; i++) {
      const ov = Math.min(em, (H_START+i+1)*60) - Math.max(sm, (H_START+i)*60);
      if (ov > bestOv) { bestOv = ov; bestI = i; }
    }
    if (bestI < 0) return;
    const fmt = m => String(Math.floor(m/60)).padStart(2,'0') + ':' + String(m%60).padStart(2,'0');
    const short = ev.title.replace(/&lt;/g,'<').replace(/&amp;/g,'&');
    const name  = short.length > 15 ? short.slice(0,14) + '\u2026' : short;
    const times = fmt(sm) + '-' + fmt(em);
    labelItems.push({ bestI, name, times, color: ev.color, isPast: em <= tm });
  });
  labelItems.sort((a,b) => a.bestI - b.bestI);

  // Assign label slots — multiple events on same petal get staggered outward
  const petalLabelCount = {};
  labelItems.forEach(item => {
    const i    = item.bestI;
    const slot = petalLabelCount[i] || 0;
    petalLabelCount[i] = slot + 1;

    const ro     = petalRO(i);
    const labelR = ro + 12 + slot * 28;  // stack outward
    const angle  = petalMid(i);
    const lx = cx + labelR * Math.cos(angle);
    const ly = cy + labelR * Math.sin(angle);

    ctx.save();
    ctx.translate(lx, ly);
    // Rotate: text flows OUTWARD from centre along petal angle.
    // angle points from centre outward. We want text baseline at inner end,
    // reading outward. So rotate = angle + PI/2 (text bottom toward centre).
    // In the upper-right quadrant (angle ~-PI/2 to 0) this reads left-to-right outward.
    // Flip in left half (angle PI/2..3PI/2 i.e. cos<0) so it's never upside-down.
    let rot = angle + Math.PI / 2;
    const cosA = Math.cos(angle);
    if (cosA < 0) rot += Math.PI;
    ctx.rotate(rot);

    // Name line
    ctx.font = 'bold 11px "JetBrains Mono",monospace';
    ctx.textAlign  = 'left';
    ctx.textBaseline = 'alphabetic';
    ctx.shadowColor = dark ? 'rgba(0,0,0,1)' : 'rgba(255,255,255,0.9)';
    ctx.shadowBlur  = 4;
    ctx.fillStyle   = item.isPast ? 'rgba(160,160,160,0.45)' : item.color;
    ctx.fillText(item.name, 0, 0);

    // Time line
    ctx.font = '9px "JetBrains Mono",monospace';
    ctx.fillStyle = item.isPast ? 'rgba(120,120,120,0.35)' : lblC;
    ctx.fillText(item.times, 0, 12);
    ctx.shadowBlur = 0;
    ctx.restore();
  });

  // ── 5. Hour labels at petal tip ──
  ctx.shadowBlur = 0;
  for (let i = 0; i < CHOURS; i++) {
    const hAbs = H_START + i;
    const a    = petalMid(i);
    const tipR = petalRO(i) - 9;
    const hLabel = hAbs >= 12 ? (hAbs === 12 ? '12p' : (hAbs-12) + 'p') : hAbs + 'a';
    ctx.save();
    ctx.translate(cx + tipR * Math.cos(a), cy + tipR * Math.sin(a));
    let rot = a + Math.PI / 2;
    if (Math.cos(a) < 0) rot += Math.PI;
    ctx.rotate(rot);
    ctx.font = '10px "JetBrains Mono",monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = dark ? 'rgba(0,0,0,0.9)' : 'rgba(255,255,255,0.8)';
    ctx.shadowBlur  = 3;
    ctx.fillStyle   = lblC;
    ctx.fillText(hLabel, 0, 0);
    ctx.shadowBlur = 0;
    ctx.restore();
  }

  // ── 6. Time needle ──
  if (tm >= H_START * 60 && tm < H_END * 60) {
    const slotF = tm / 60 - H_START;
    const si    = Math.floor(slotF);
    const frac  = slotF - si;
    const na    = hourAngle(si, frac);
    const nLen  = petalRO(si) + 6;
    ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx + nLen * Math.cos(na), cy + nLen * Math.sin(na));
    ctx.strokeStyle = dark ? 'rgba(0,0,0,0.45)' : 'rgba(255,255,255,0.5)';
    ctx.lineWidth = 5; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx + nLen * Math.cos(na), cy + nLen * Math.sin(na));
    ctx.strokeStyle = needleC; ctx.lineWidth = 2.5; ctx.stroke();
    ctx.beginPath(); ctx.arc(cx + nLen * Math.cos(na), cy + nLen * Math.sin(na), 5, 0, Math.PI * 2);
    ctx.fillStyle = needleC; ctx.fill();
  }

  // ── 7. Centre hub — just a small dot, no circle ──
  ctx.beginPath(); ctx.arc(cx, cy, 8, 0, Math.PI * 2);
  ctx.fillStyle = hubC; ctx.fill();
}

// ── SMART TAP ────────────────────────────────────────
const overlay=document.getElementById('chrono-overlay');
const canvas=document.getElementById('chronodex-canvas');
const picker=document.getElementById('event-picker');

overlay.addEventListener('click',e=>{
  const rect=overlay.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  const cx=canvas.width/2,cy=canvas.height/2,dx=mx-cx,dy=my-cy,dist=Math.sqrt(dx*dx+dy*dy);
  // Work out which petal was tapped using angle + radius
  const tapAngle=Math.atan2(dy,dx);  // -π to π
  // Normalise to 0–2π starting from top (−π/2)
  let norm=tapAngle+Math.PI/2; if(norm<0)norm+=Math.PI*2;
  // Which hour slot?
  const slotF=norm/PETAL_RAD;
  const slotI=Math.floor(slotF);
  if(slotI<0||slotI>=CHOURS){closePicker();return;}
  const ro=petalRO(slotI);
  if(dist<petalRI()||dist>ro+20){closePicker();return;}
  const tapMin=(H_START+slotF)*60;  // fractional minute
  const near=todayEventsForPicker.filter(ev=>{
    const sm=new Date(ev.startISO).getHours()*60+new Date(ev.startISO).getMinutes();
    const em=new Date(ev.endISO).getHours()*60+new Date(ev.endISO).getMinutes();
    return sm<=tapMin+30&&tapMin<=em+30;
  });
  if(!near.length){closePicker();return;}
  if(near.length===1){openPomo(near[0]);return;}
  showPicker(near,e.clientX,e.clientY);
});

function showPicker(events,px,py){
  const items=document.getElementById('picker-items');items.innerHTML='';
  events.forEach(ev=>{
    const fmt=d=>d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    const div=document.createElement('div');div.className='picker-item';
    div.innerHTML='<div class="picker-dot" style="background:'+ev.color+'"></div><div class="picker-text"><div class="picker-title">'+ev.title+'</div><div class="picker-time">'+fmt(new Date(ev.startISO))+' \u2013 '+fmt(new Date(ev.endISO))+'</div></div>';
    div.addEventListener('click',()=>{closePicker();openPomo(ev);});
    items.appendChild(div);
  });
  picker.classList.add('open');
  const pw=320,ph=picker.offsetHeight||200;
  let left=px+12,top=py-ph/2;
  if(left+pw>window.innerWidth-10)left=px-pw-12;
  if(top<10)top=10; if(top+ph>window.innerHeight-10)top=window.innerHeight-ph-10;
  picker.style.left=left+'px';picker.style.top=top+'px';
}
function closePicker(){picker.classList.remove('open');}
document.getElementById('picker-cancel').addEventListener('click',closePicker);
document.addEventListener('click',e=>{if(picker.classList.contains('open')&&!picker.contains(e.target)&&e.target!==overlay)closePicker();},{capture:true});

// ── CLOCK + NEXT EVENT ────────────────────────────────
function updateClock(){
  const now=new Date();
  document.getElementById('time-big').textContent=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  const DN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const MN=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('time-date').textContent=DN[now.getDay()]+' \u00b7 '+now.getDate()+' '+MN[now.getMonth()]+' '+now.getFullYear();
  const nm=now.getTime(),in30=nm+30*60*1000;
  const up=EVENTS.map(e=>({...e,sm:new Date(e.startISO).getTime()})).filter(e=>e.sm>=nm&&e.sm<=in30).sort((a,b)=>a.sm-b.sm);
  if(up.length){
    const nx=up[0],st=new Date(nx.startISO),mu=Math.round((nx.sm-nm)/60000);
    document.getElementById('next-title').textContent=nx.title;
    document.getElementById('next-title').style.color=nx.color;
    document.getElementById('next-time').textContent=st.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})+' \u00b7 in '+mu+' min';
  }else{
    document.getElementById('next-title').textContent='Nothing in next 30 min';
    document.getElementById('next-title').style.color='var(--ink-dim)';
    document.getElementById('next-time').textContent='';
  }
}

// ── TASKS ─────────────────────────────────────────────
function buildTasks(){
  const list=document.getElementById('tasks-list'),today=localDate();
  list.innerHTML='';
  const tasks=filteredTasks();
  if(!tasks.length){ list.innerHTML='<div class="loading-msg">'+(accessToken?'No tasks':'Sign in to see tasks')+'</div>'; document.getElementById('tasks-count').textContent=''; return; }
  const ov=tasks.filter(t=>!t.done&&t.due&&t.due<today);
  const dt=tasks.filter(t=>!t.done&&t.due===today);
  const up=tasks.filter(t=>!t.done&&(!t.due||t.due>today));
  const dn=tasks.filter(t=>t.done);
  function grp(lbl,items,mc){
    if(!items.length)return;
    const gl=document.createElement('div');gl.className='task-group-lbl';gl.textContent=lbl;list.appendChild(gl);
    items.forEach(task=>{
      const item=document.createElement('div');item.className='task-item'+(task.done?' done':'');
      item.draggable=true;
      item.innerHTML='<div class="drag-hint">\u2630</div><div class="task-pri pri-'+task.priority+'"></div><div class="task-check"></div><div class="task-body"><div class="task-title">'+task.title+'</div>'+(task.due?'<div class="task-meta '+(mc||'')+'">'+fmtDue(task.due,today)+(activeTaskTab==='all'?'  \u00b7 '+task._listName:'')+'</div>':'')+'</div>';
      item.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',JSON.stringify({taskTitle:task.title,taskId:task._id,listId:task._list}));item.classList.add('dragging');});
      item.addEventListener('dragend',()=>item.classList.remove('dragging'));
      item.querySelector('.task-check').addEventListener('click',ev=>{ev.stopPropagation();completeTask(task);});
      list.appendChild(item);
    });
  }
  grp('\u26a0 Overdue',ov,'overdue');grp('\u00b7 Today',dt,'today-due');grp('\u00b7 Upcoming',up,'');grp('\u00b7 Done',dn,'');
  document.getElementById('tasks-count').textContent=tasks.filter(t=>!t.done).length+' remaining';
}
function fmtDue(due,today){ if(due===today)return'Today'; return new Date(due+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}); }

async function completeTask(task){
  task.done=true; buildTasks();
  try{
    await fetch(TASKS_API+'/lists/'+task._list+'/tasks/'+task._id,{
      method:'PATCH', headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
      body:JSON.stringify({status:'completed'}),
    });
  }catch(e){ task.done=false; buildTasks(); }
}

// ── ADD EVENT MODAL ───────────────────────────────────
function openAddEvent(){
  if(!accessToken){showSyncBar('Sign in first','err');return;}
  // Pre-fill today's date and current time rounded to next 30 min
  const now=new Date();
  const mins=now.getMinutes(); const roundMin=mins<30?30:0;
  const h=roundMin===0?now.getHours()+1:now.getHours();
  document.getElementById('ev-date').value=localDate(now);
  document.getElementById('ev-start').value=String(h%24).padStart(2,'0')+':'+String(roundMin).padStart(2,'0');
  document.getElementById('ev-title').value='';
  document.getElementById('ev-dur').value='60';
  // Populate calendar selector
  const sel=document.getElementById('ev-cal'); sel.innerHTML='';
  const primaryCal = CAL_LIST.find(c=>c.isPrimary);
  CAL_LIST.forEach(cal=>{
    const o=document.createElement('option'); o.value=cal.id; o.textContent=cal.name;
    // Priority: active tab > primary calendar > first
    if(activeCalTab!=='all' && activeCalTab===cal.id) o.selected=true;
    else if(activeCalTab==='all' && cal.isPrimary) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('modal-event').classList.add('open');
  setTimeout(()=>document.getElementById('ev-title').focus(),50);
}
function closeAddEvent(){ document.getElementById('modal-event').classList.remove('open'); }

document.getElementById('add-event-btn').addEventListener('click',openAddEvent);
document.getElementById('modal-event-close').addEventListener('click',closeAddEvent);
document.getElementById('ev-cancel').addEventListener('click',closeAddEvent);
document.getElementById('modal-event').addEventListener('click',e=>{ if(e.target===document.getElementById('modal-event'))closeAddEvent(); });

document.getElementById('ev-save').addEventListener('click',async()=>{
  const title=document.getElementById('ev-title').value.trim();
  const date=document.getElementById('ev-date').value;
  const start=document.getElementById('ev-start').value;
  const dur=parseInt(document.getElementById('ev-dur').value)||60;
  const calId=document.getElementById('ev-cal').value;
  if(!title){document.getElementById('ev-title').focus();return;}
  if(!date||!start){showSyncBar('Please fill in date and time','err');return;}
  const startDT=new Date(date+'T'+start);
  const endDT=new Date(startDT.getTime()+dur*60000);
  const toISO=d=>d.toISOString().replace('.000Z','Z');
  document.getElementById('ev-saving').style.display='';
  document.getElementById('ev-save').disabled=true;
  try{
    await apiPost(CAL_API+'/calendars/'+encodeURIComponent(calId)+'/events',{
      summary:title, start:{dateTime:toISO(startDT)}, end:{dateTime:toISO(endDT)},
    });
    closeAddEvent();
    await loadAllData();
    showSyncBar('Event added \u2713','ok');
  }catch(err){
    showSyncBar('\u26a0 '+err.message,'err');
  }finally{
    document.getElementById('ev-saving').style.display='none';
    document.getElementById('ev-save').disabled=false;
  }
});

// ── ADD TASK MODAL ────────────────────────────────────
function openAddTask(){
  if(!accessToken){showSyncBar('Sign in first','err');return;}
  document.getElementById('tk-title').value='';
  document.getElementById('tk-date').value='';
  const sel=document.getElementById('tk-list'); sel.innerHTML='';
  TASK_LISTS.forEach(tl=>{
    const o=document.createElement('option'); o.value=tl.id; o.textContent=tl.title;
    if(activeTaskTab!=='all'&&activeTaskTab===tl.id) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('modal-task').classList.add('open');
  setTimeout(()=>document.getElementById('tk-title').focus(),50);
}
function closeAddTask(){ document.getElementById('modal-task').classList.remove('open'); }

document.getElementById('add-task-btn').addEventListener('click',openAddTask);
document.getElementById('modal-task-close').addEventListener('click',closeAddTask);
document.getElementById('tk-cancel').addEventListener('click',closeAddTask);
document.getElementById('modal-task').addEventListener('click',e=>{ if(e.target===document.getElementById('modal-task'))closeAddTask(); });

document.getElementById('tk-save').addEventListener('click',async()=>{
  const title=document.getElementById('tk-title').value.trim();
  const due=document.getElementById('tk-date').value;
  const listId=document.getElementById('tk-list').value;
  if(!title){document.getElementById('tk-title').focus();return;}
  if(!listId){showSyncBar('No task lists found','err');return;}
  const body={title};
  // Tasks API expects RFC 3339 with time for due field
  if(due) body.due=new Date(due+'T00:00:00').toISOString();
  document.getElementById('tk-saving').style.display='';
  document.getElementById('tk-save').disabled=true;
  try{
    await apiPost(TASKS_API+'/lists/'+listId+'/tasks',body);
    closeAddTask();
    await loadAllData();
    showSyncBar('Task added \u2713','ok');
  }catch(err){
    showSyncBar('\u26a0 '+err.message,'err');
  }finally{
    document.getElementById('tk-saving').style.display='none';
    document.getElementById('tk-save').disabled=false;
  }
});

// ── POMODORO ──────────────────────────────────────────
const PMIN=1,PMAX=80;let pomoDuration=25;
const pomo={running:false,totalSecs:25*60,remainSecs:25*60,interval:null,sessions:0};

function openPomo(ev){
  if(!pomo.running) document.getElementById('pomo-ev-title').textContent = ev ? ev.title : 'Focus Session';
  document.getElementById('pomo-overlay').classList.add('open');
  initScribble();
  drawPomoRing(); renderPomo(); buildTicks();
}
document.getElementById('pomo-open-btn').addEventListener('click', ()=>openPomo(null));
document.getElementById('pomo-close').addEventListener('click', ()=>{
  if(pomo.running){
    document.getElementById('pomo-lock-msg').classList.add('show');
    return;
  }
  document.getElementById('pomo-overlay').classList.remove('open');
});
document.getElementById('pomo-withdraw').addEventListener('click', ()=>{
  clearInterval(pomo.interval); pomo.running=false;
  pomo.totalSecs=pomoDuration*60; pomo.remainSecs=pomoDuration*60;
  renderPomo();
  document.getElementById('pomo-lock-msg').classList.remove('show');
  document.getElementById('pomo-overlay').classList.remove('open');
});

function clamp(v){return Math.max(PMIN,Math.min(PMAX,Math.round(v)));}
function setDuration(v){
  pomoDuration=clamp(v);
  if(!pomo.running){pomo.totalSecs=pomoDuration*60;pomo.remainSecs=pomoDuration*60;}
  const el=document.getElementById('sw-val');if(el)el.textContent=String(pomoDuration);
  buildTicks();renderPomo();
}
function buildTicks(){
  const c=document.getElementById('sw-ticks');if(!c)return;c.innerHTML='';
  for(let i=-15;i<=15;i++){
    const val=pomoDuration+i,el=document.createElement('div');
    if(val<PMIN||val>PMAX){el.style.width='4px';c.appendChild(el);continue;}
    el.className='tick'+(i===0?' current':val%5===0?' major':'');
    el.style.height=i===0?'16px':val%5===0?'11px':'6px';
    c.appendChild(el);
  }
}
let swX=null,swDur=null;
const swTrack=document.getElementById('sw-track');
swTrack.addEventListener('pointerdown',e=>{swX=e.clientX;swDur=pomoDuration;swTrack.setPointerCapture(e.pointerId);e.preventDefault();});
swTrack.addEventListener('pointermove',e=>{if(swX===null)return;setDuration(swDur+Math.round((e.clientX-swX)/13));});
swTrack.addEventListener('pointerup',()=>swX=null);
swTrack.addEventListener('pointercancel',()=>swX=null);
swTrack.addEventListener('wheel',e=>{e.preventDefault();setDuration(pomoDuration+(e.deltaY>0?-1:1));},{passive:false});
['sw-minus','sw-plus'].forEach(id=>{
  const btn=document.getElementById(id),d=id==='sw-minus'?-1:1;
  btn.addEventListener('click',()=>setDuration(pomoDuration+d));
  btn.addEventListener('pointerdown',()=>{let tid=setInterval(()=>setDuration(pomoDuration+d),90);document.addEventListener('pointerup',()=>clearInterval(tid),{once:true});});
});

function drawPomoRing(){
  const cv=document.getElementById('pomo-ring');if(!cv)return;
  const ctx=cv.getContext('2d'),W=cv.width,H=cv.height,cx=W/2,cy=H/2,R=58;
  ctx.clearRect(0,0,W,H);
  const frac=pomo.remainSecs/pomo.totalSecs,sa=-Math.PI/2,ea=sa+(1-frac)*Math.PI*2;
  const dark=isDark,gRGB=dark?'201,168,76':'138,106,40';
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.strokeStyle=dark?'rgba(255,255,255,0.10)':'rgba(28,31,38,0.12)';ctx.lineWidth=13;ctx.stroke();
  if(frac>0){ctx.beginPath();ctx.arc(cx,cy,R,ea,sa+Math.PI*2);ctx.strokeStyle='rgba('+gRGB+',0.15)';ctx.lineWidth=13;ctx.lineCap='butt';ctx.stroke();}
  if(frac<1){const col=pomo.running?(dark?'#c44b3a':'#b83228'):pomo.remainSecs<pomo.totalSecs?(dark?'#4a7fa5':'#2e5c8a'):'rgba('+gRGB+',0.7)';ctx.beginPath();ctx.arc(cx,cy,R,sa,ea);ctx.strokeStyle=col;ctx.lineWidth=13;ctx.lineCap='round';ctx.stroke();}
}
function renderPomo(){
  const m=Math.floor(pomo.remainSecs/60),s=pomo.remainSecs%60;
  document.getElementById('pomo-time').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  document.getElementById('pomo-phase').textContent=pomo.running?'Focusing':pomo.remainSecs===0?'Complete \u2713':pomo.remainSecs<pomo.totalSecs?'Paused':'Ready';
  document.getElementById('pomo-start').textContent=pomo.running?'Pause':pomo.remainSecs>0&&pomo.remainSecs<pomo.totalSecs?'Resume':'Start';
  document.querySelectorAll('.sess-dot').forEach((d,i)=>d.classList.toggle('done',i<pomo.sessions));
  const sw=document.querySelector('.swipe-section');
  if(sw){sw.style.opacity=pomo.running?'0.4':'1';sw.style.pointerEvents=pomo.running?'none':'auto';}
  if(!pomo.running) document.getElementById('pomo-lock-msg').classList.remove('show');
  drawPomoRing();
}
document.getElementById('pomo-start').addEventListener('click',()=>{
  if(pomo.running){clearInterval(pomo.interval);pomo.running=false;}
  else{
    if(pomo.remainSecs===0){pomo.totalSecs=pomoDuration*60;pomo.remainSecs=pomoDuration*60;}
    pomo.running=true;
    pomo.interval=setInterval(()=>{
      pomo.remainSecs--;
      if(pomo.remainSecs<=0){
        clearInterval(pomo.interval);pomo.running=false;pomo.remainSecs=0;pomo.sessions=Math.min(4,pomo.sessions+1);
        document.getElementById('pomo-lock-msg').classList.remove('show');
        setTimeout(()=>document.getElementById('pomo-overlay').classList.remove('open'),1200);
        try{const ac=new(window.AudioContext||window.webkitAudioContext)();[0,0.35,0.7].forEach((t,i)=>{const osc=ac.createOscillator(),g=ac.createGain();osc.connect(g);g.connect(ac.destination);osc.frequency.value=[528,660,792][i];g.gain.value=0.2;osc.start(ac.currentTime+t);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+t+0.9);osc.stop(ac.currentTime+t+0.9);});}catch(e){}
      }
      renderPomo();
    },1000);
  }
  renderPomo();
});
document.getElementById('pomo-reset').addEventListener('click',()=>{
  clearInterval(pomo.interval);pomo.running=false;pomo.totalSecs=pomoDuration*60;pomo.remainSecs=pomoDuration*60;renderPomo();
});


// ── SCRIBBLE BOARD ────────────────────────────────────
let _scribbleInited = false;
const SCRIBBLE_COLORS = ['#e8e4d8','#c9a84c','#4a7fa5','#5a8f6a','#c44b3a','#d4813a','#000000'];

function initScribble() {
  if (_scribbleInited) return;
  _scribbleInited = true;
  const cv  = document.getElementById('scribble-canvas');
  const col = cv.parentElement;

  function resize() {
    const dpr = window.devicePixelRatio || 1;
    const w   = col.clientWidth;
    const h   = col.clientHeight;
    // Preserve existing drawing
    const tmp = document.createElement('canvas');
    tmp.width = cv.width; tmp.height = cv.height;
    tmp.getContext('2d').drawImage(cv, 0, 0);
    cv.width  = w * dpr; cv.height = h * dpr;
    cv.style.width = w + 'px'; cv.style.height = h + 'px';
    const ctx = cv.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.drawImage(tmp, 0, 0, w, h);
  }
  resize();
  new ResizeObserver(resize).observe(col);

  // Build color swatches
  const swatchBar = document.getElementById('color-swatches');
  swatchBar.innerHTML = '';
  let activeColor = SCRIBBLE_COLORS[0];
  SCRIBBLE_COLORS.forEach(c => {
    const s = document.createElement('div');
    s.className = 'scribble-swatch' + (c === activeColor ? ' active' : '');
    s.style.background = c;
    s.addEventListener('click', () => {
      activeColor = c;
      isEraser = false;
      document.querySelectorAll('.scribble-swatch').forEach(x => x.classList.remove('active'));
      s.classList.add('active');
      document.getElementById('scribble-eraser').classList.remove('active');
    });
    swatchBar.appendChild(s);
  });

  let isEraser = false;
  document.getElementById('scribble-eraser').addEventListener('click', function() {
    isEraser = !isEraser;
    this.classList.toggle('active', isEraser);
  });
  document.getElementById('scribble-clear').addEventListener('click', () => {
    const dpr = window.devicePixelRatio || 1;
    cv.getContext('2d').clearRect(0, 0, cv.width / dpr * dpr, cv.height / dpr * dpr);
  });

  // Drawing logic — works for both mouse and Apple Pencil (pointer events)
  let drawing = false, lastX = 0, lastY = 0;

  function getPos(e) {
    const rect = cv.getBoundingClientRect();
    const dpr  = window.devicePixelRatio || 1;
    const src  = e.touches ? e.touches[0] : e;
    return [(src.clientX - rect.left), (src.clientY - rect.top)];
  }

  function startDraw(e) {
    e.preventDefault();
    drawing = true;
    [lastX, lastY] = getPos(e);
    const ctx = cv.getContext('2d');
    const sz  = parseInt(document.getElementById('stroke-size').value) || 3;
    ctx.beginPath();
    ctx.arc(lastX, lastY, sz / 2, 0, Math.PI * 2);
    ctx.fillStyle = isEraser ? 'rgba(0,0,0,1)' : activeColor;
    if (isEraser) { ctx.save(); ctx.globalCompositeOperation = 'destination-out'; ctx.fill(); ctx.restore(); }
    else ctx.fill();
  }

  function draw(e) {
    if (!drawing) return;
    e.preventDefault();
    const ctx = cv.getContext('2d');
    const [x, y] = getPos(e);
    const sz = parseInt(document.getElementById('stroke-size').value) || 3;
    ctx.save();
    if (isEraser) ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.strokeStyle = isEraser ? 'rgba(0,0,0,1)' : activeColor;
    ctx.lineWidth   = sz;
    ctx.lineCap     = 'round';
    ctx.lineJoin    = 'round';
    ctx.stroke();
    ctx.restore();
    lastX = x; lastY = y;
  }

  function endDraw() { drawing = false; }

  cv.addEventListener('pointerdown', startDraw, { passive: false });
  cv.addEventListener('pointermove', draw,      { passive: false });
  cv.addEventListener('pointerup',   endDraw);
  cv.addEventListener('pointercancel', endDraw);
}

// ── INIT ──────────────────────────────────────────────
renderLeft(); buildTasks(); updateClock(); drawChronodex(); buildTicks(); renderPomo();
setInterval(()=>{updateClock();drawChronodex();}, 30000);
setInterval(()=>{if(accessToken)loadAllData();}, 10*60*1000);  // 10 min refresh

const _gisWait=setInterval(()=>{
  if(window.google&&window.google.accounts){
    clearInterval(_gisWait); initGIS();
    if(accessToken){
      document.getElementById('signin-overlay').classList.add('hidden');
      document.getElementById('sync-user').textContent=currentUser;
      loadAllData();
    }
  }
},150);
</script>
</body>
</html>
